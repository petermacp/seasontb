<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>data-and-code • seasontb</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="data-and-code">
<meta property="og:description" content="seasontb">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">seasontb</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/data-and-code.html">data-and-code</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="data-and-code_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>data-and-code</h1>
            
      
      
      <div class="hidden name"><code>data-and-code.Rmd</code></div>

    </div>

    
    
<p><br></p>
<div id="backgound" class="section level2">
<h2 class="hasAnchor">
<a href="#backgound" class="anchor"></a>1. Backgound</h2>
<p>The script conducts analysis of the seasonality of TB in Blantyre, Malawi</p>
<p><br></p>
</div>
<div id="set-up" class="section level2">
<h2 class="hasAnchor">
<a href="#set-up" class="anchor"></a>2. Set-up</h2>
<p>Load all required packages for analysis.</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">tidyverse</span>)      <span class="co">#for data manipulation</span>
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">lubridate</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">tsibble</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">glue</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">mgcv</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">mlwdata</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">zoo</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">ggpubr</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">xts</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">smooth</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">Mcomp</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">fpp2</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">smooth</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">ggseas</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">here</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">ggtext</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">GSODR</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">arsenal</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">patchwork</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">dlnm</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">MuMIn</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">Metrics</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">knitr</span>)
<span class="co">#for Blantyre data (</span>
<span class="co"># install.packages("devtools")</span>
<span class="co">#devtools::install_github("petermacp/mlwdata"))</span></pre></body></html></div>
<p><br></p>
</div>
<div id="import-the-data" class="section level2">
<h2 class="hasAnchor">
<a href="#import-the-data" class="anchor"></a>3. Import the data</h2>
<p>Load the required data.</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="no">tbcases</span> <span class="kw">&lt;-</span> <span class="kw pkg">mlwdata</span><span class="kw ns">::</span><span class="no">tb_cases_2011_2018</span>
<span class="no">blantyre</span> <span class="kw">&lt;-</span> <span class="kw pkg">mlwdata</span><span class="kw ns">::</span><span class="no">blantyre_census_by_q</span>

<span class="co">#Weather data</span>
<span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span>(<span class="st">"extdata"</span>, <span class="st">"isd_history.rda"</span>, <span class="kw">package</span> <span class="kw">=</span> <span class="st">"GSODR"</span>))
<span class="co">#see the available data for Malawi</span>
<span class="no">Malawi</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span>(<span class="no">isd_history</span>, <span class="no">COUNTRY_NAME</span> <span class="kw">==</span> <span class="st">"MALAWI"</span>)
<span class="co">#Subset the Malawi data for Chileka Airport station</span>
<span class="no">chileka</span> <span class="kw">&lt;-</span> <span class="no">Malawi</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">NAME</span><span class="kw">==</span><span class="st">"CHILEKA INTL"</span>)
<span class="co">#Now pull the 2017 data for Malawi</span>
<span class="no">mweather</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://docs.ropensci.org/GSODR/reference/get_GSOD.html">get_GSOD</a></span>(<span class="kw">years</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">2011</span>:<span class="fl">2019</span>), <span class="kw">station</span> <span class="kw">=</span> <span class="st">"676930-99999"</span>)</pre></body></html></div>
<p><br></p>
</div>
<div id="cleaning-and-recoding" class="section level2">
<h2 class="hasAnchor">
<a href="#cleaning-and-recoding" class="anchor"></a>4. Cleaning and recoding</h2>
<div class="sourceCode" id="cb3"><html><body><pre class="r">#Here we aggregate the rural and urban populations, and sum across age groups to get overall population at each quarter.

#Then we do linear interpolation to get the weekly estimated population.

a &lt;- blantyre %&gt;%
  filter(sex == "total") %&gt;%
  filter(year_q&gt;="2011.2") %&gt;%
  group_by(year_q) %&gt;%
  summarise(population = sum(population)) %&gt;%
  mutate(year_temp = str_extract(year_q, "[^.]+")) %&gt;%
  mutate(period_temp = case_when(str_detect(year_q, ".1$") ~ "03-31",
                                 str_detect(year_q, ".2$") ~ "06-30",
                                 str_detect(year_q, ".3$") ~ "09-30",
                                 str_detect(year_q, ".4$") ~ "12-31")) %&gt;%
  mutate(temp_date = ymd(glue("{year_temp}-{period_temp}"))) %&gt;%
  mutate(y_w = yearweek(temp_date))


weeks_for_fill &lt;- seq(from=min(a$y_w), to=max(a$y_w), 1) %&gt;%
  tibble(y_w=.)

a &lt;- full_join(a, weeks_for_fill)

a &lt;- a %&gt;%
  ungroup() %&gt;%
  mutate(y_w = yearweek(y_w)) %&gt;%
  arrange(y_w) %&gt;%
  mutate(int_pop = round(zoo::na.approx(population))) %&gt;%
  dplyr::select(year_q, y_w, int_pop) %&gt;%
  fill(year_q)

#Tidy-up the TB case data

b &lt;- tbcases %&gt;%
  select(reg_date, year_q, year) %&gt;%
  filter(year_q &gt;="2011.3") %&gt;%
  mutate(y_w = yearweek(reg_date))

b &lt;- b %&gt;%
  group_by(y_w) %&gt;%
  count() %&gt;%
  ungroup()

b %&gt;% summarise(sum = sum(n))
# A tibble: 1 x 1
    sum
  &lt;int&gt;
1 15908</pre></body></html></div>
<p><br></p>
</div>
<div id="table-1-characteristics-of-cases" class="section level2">
<h2 class="hasAnchor">
<a href="#table-1-characteristics-of-cases" class="anchor"></a>5. Table 1: Characteristics of cases</h2>
<div class="sourceCode" id="cb4"><html><body><pre class="r">
<span class="no">tab1</span> <span class="kw">&lt;-</span> <span class="no">tbcases</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">year_q</span> <span class="kw">&gt;=</span><span class="st">"2011.3"</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">year2</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="kw pkg">lubridate</span><span class="kw ns">::</span><span class="fu"><a href="http://lubridate.tidyverse.org/reference/year.html">year</a></span>(<span class="no">reg_date</span>))) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">agegp</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="no">agegp</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">month</span> <span class="kw">=</span> <span class="fu"><a href="http://lubridate.tidyverse.org/reference/month.html">month</a></span>(<span class="no">reg_date</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">season</span> <span class="kw">=</span> <span class="fu">case_when</span>(<span class="no">month</span> <span class="kw">&gt;=</span><span class="fl">5</span> <span class="kw">&amp;</span> <span class="no">month</span><span class="kw">&lt;=</span><span class="fl">8</span> ~ <span class="st">"Cold, dry (May-Aug)"</span>,
                            <span class="no">month</span> <span class="kw">&gt;</span><span class="fl">8</span> <span class="kw">&amp;</span> <span class="no">month</span> <span class="kw">&lt;=</span><span class="fl">11</span> ~ <span class="st">"Hot, dry (Sept-Nov)"</span>,
                            <span class="no">month</span><span class="kw">==</span><span class="fl">12</span> ~ <span class="st">"Hot, wet (Dec-Apr)"</span>,
                            <span class="no">month</span><span class="kw">&lt;=</span><span class="fl">4</span> ~ <span class="st">"Hot, wet (Dec-Apr)"</span>))



<span class="no">table1</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/arsenal/man/tableby.html">tableby</a></span>(<span class="no">year2</span> ~ <span class="no">season</span> +<span class="no">sex</span> + <span class="no">age</span> + <span class="no">hiv</span> + <span class="no">art</span> + <span class="no">tbtype</span> + <span class="no">tbcat</span> + <span class="no">smr_xpert_any</span>,
                  <span class="kw">data</span><span class="kw">=</span><span class="no">tab1</span>, <span class="kw">digits</span><span class="kw">=</span><span class="fl">1L</span>, <span class="kw">numeric.stats</span><span class="kw">=</span><span class="st">"meansd"</span>)

<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(<span class="no">table1</span>)</pre></body></html></div>
<table class="table">
<colgroup>
<col width="24%">
<col width="7%">
<col width="7%">
<col width="7%">
<col width="7%">
<col width="7%">
<col width="7%">
<col width="7%">
<col width="7%">
<col width="8%">
<col width="4%">
</colgroup>
<thead><tr class="header">
<th align="left"></th>
<th align="center">2011 (N=1309)</th>
<th align="center">2012 (N=2464)</th>
<th align="center">2013 (N=2347)</th>
<th align="center">2014 (N=2110)</th>
<th align="center">2015 (N=1962)</th>
<th align="center">2016 (N=1957)</th>
<th align="center">2017 (N=1940)</th>
<th align="center">2018 (N=1819)</th>
<th align="center">Total (N=15908)</th>
<th align="right">p value</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left"><strong>season</strong></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="right">&lt; 0.001</td>
</tr>
<tr class="even">
<td align="left">   Cold, dry (May-Aug)</td>
<td align="center">396 (30.3%)</td>
<td align="center">864 (35.1%)</td>
<td align="center">776 (33.1%)</td>
<td align="center">666 (31.6%)</td>
<td align="center">645 (32.9%)</td>
<td align="center">616 (31.5%)</td>
<td align="center">650 (33.5%)</td>
<td align="center">677 (37.2%)</td>
<td align="center">5290 (33.3%)</td>
<td align="right"></td>
</tr>
<tr class="odd">
<td align="left">   Hot, dry (Sept-Nov)</td>
<td align="center">671 (51.3%)</td>
<td align="center">693 (28.1%)</td>
<td align="center">564 (24.0%)</td>
<td align="center">543 (25.7%)</td>
<td align="center">477 (24.3%)</td>
<td align="center">524 (26.8%)</td>
<td align="center">493 (25.4%)</td>
<td align="center">439 (24.1%)</td>
<td align="center">4404 (27.7%)</td>
<td align="right"></td>
</tr>
<tr class="even">
<td align="left">   Hot, wet (Dec-Apr)</td>
<td align="center">242 (18.5%)</td>
<td align="center">907 (36.8%)</td>
<td align="center">1007 (42.9%)</td>
<td align="center">901 (42.7%)</td>
<td align="center">840 (42.8%)</td>
<td align="center">817 (41.7%)</td>
<td align="center">797 (41.1%)</td>
<td align="center">703 (38.6%)</td>
<td align="center">6214 (39.1%)</td>
<td align="right"></td>
</tr>
<tr class="odd">
<td align="left"><strong>sex</strong></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="right">0.025</td>
</tr>
<tr class="even">
<td align="left">   Female</td>
<td align="center">504 (38.5%)</td>
<td align="center">1008 (40.9%)</td>
<td align="center">953 (40.6%)</td>
<td align="center">844 (40.0%)</td>
<td align="center">732 (37.3%)</td>
<td align="center">721 (36.8%)</td>
<td align="center">728 (37.5%)</td>
<td align="center">691 (38.0%)</td>
<td align="center">6181 (38.9%)</td>
<td align="right"></td>
</tr>
<tr class="odd">
<td align="left">   Male</td>
<td align="center">805 (61.5%)</td>
<td align="center">1456 (59.1%)</td>
<td align="center">1394 (59.4%)</td>
<td align="center">1266 (60.0%)</td>
<td align="center">1230 (62.7%)</td>
<td align="center">1236 (63.2%)</td>
<td align="center">1212 (62.5%)</td>
<td align="center">1128 (62.0%)</td>
<td align="center">9727 (61.1%)</td>
<td align="right"></td>
</tr>
<tr class="even">
<td align="left"><strong>age</strong></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="right">&lt; 0.001</td>
</tr>
<tr class="odd">
<td align="left">   Mean (SD)</td>
<td align="center">31.8 (14.3)</td>
<td align="center">33.1 (14.9)</td>
<td align="center">34.1 (14.5)</td>
<td align="center">34.6 (13.8)</td>
<td align="center">34.6 (13.4)</td>
<td align="center">34.5 (13.7)</td>
<td align="center">34.4 (14.6)</td>
<td align="center">35.7 (15.2)</td>
<td align="center">34.1 (14.4)</td>
<td align="right"></td>
</tr>
<tr class="even">
<td align="left"><strong>hiv</strong></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="right">&lt; 0.001</td>
</tr>
<tr class="odd">
<td align="left">   N-Miss</td>
<td align="center">193</td>
<td align="center">234</td>
<td align="center">291</td>
<td align="center">159</td>
<td align="center">115</td>
<td align="center">50</td>
<td align="center">31</td>
<td align="center">7</td>
<td align="center">1080</td>
<td align="right"></td>
</tr>
<tr class="even">
<td align="left">   a) HIV-negative</td>
<td align="center">300 (26.9%)</td>
<td align="center">599 (26.9%)</td>
<td align="center">573 (27.9%)</td>
<td align="center">599 (30.7%)</td>
<td align="center">532 (28.8%)</td>
<td align="center">604 (31.7%)</td>
<td align="center">612 (32.1%)</td>
<td align="center">588 (32.5%)</td>
<td align="center">4407 (29.7%)</td>
<td align="right"></td>
</tr>
<tr class="odd">
<td align="left">   b) HIV-positive</td>
<td align="center">816 (73.1%)</td>
<td align="center">1631 (73.1%)</td>
<td align="center">1483 (72.1%)</td>
<td align="center">1352 (69.3%)</td>
<td align="center">1315 (71.2%)</td>
<td align="center">1303 (68.3%)</td>
<td align="center">1297 (67.9%)</td>
<td align="center">1224 (67.5%)</td>
<td align="center">10421 (70.3%)</td>
<td align="right"></td>
</tr>
<tr class="even">
<td align="left"><strong>art</strong></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="right">&lt; 0.001</td>
</tr>
<tr class="odd">
<td align="left">   a) Not taking ART</td>
<td align="center">894 (68.3%)</td>
<td align="center">1445 (58.6%)</td>
<td align="center">1200 (51.1%)</td>
<td align="center">1020 (48.3%)</td>
<td align="center">862 (43.9%)</td>
<td align="center">792 (40.5%)</td>
<td align="center">735 (37.9%)</td>
<td align="center">635 (34.9%)</td>
<td align="center">7583 (47.7%)</td>
<td align="right"></td>
</tr>
<tr class="even">
<td align="left">   b) Taking ART</td>
<td align="center">415 (31.7%)</td>
<td align="center">1019 (41.4%)</td>
<td align="center">1147 (48.9%)</td>
<td align="center">1090 (51.7%)</td>
<td align="center">1100 (56.1%)</td>
<td align="center">1165 (59.5%)</td>
<td align="center">1205 (62.1%)</td>
<td align="center">1184 (65.1%)</td>
<td align="center">8325 (52.3%)</td>
<td align="right"></td>
</tr>
<tr class="odd">
<td align="left"><strong>tbtype</strong></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="right">&lt; 0.001</td>
</tr>
<tr class="even">
<td align="left">   N-Miss</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">3</td>
<td align="center">3</td>
<td align="right"></td>
</tr>
<tr class="odd">
<td align="left">   a) Pulmonary TB</td>
<td align="center">921 (70.4%)</td>
<td align="center">1721 (69.8%)</td>
<td align="center">1602 (68.3%)</td>
<td align="center">1223 (58.0%)</td>
<td align="center">1244 (63.4%)</td>
<td align="center">1200 (61.3%)</td>
<td align="center">1201 (61.9%)</td>
<td align="center">913 (50.3%)</td>
<td align="center">10025 (63.0%)</td>
<td align="right"></td>
</tr>
<tr class="even">
<td align="left">   b) Extrapulmonary TB</td>
<td align="center">388 (29.6%)</td>
<td align="center">743 (30.2%)</td>
<td align="center">745 (31.7%)</td>
<td align="center">887 (42.0%)</td>
<td align="center">718 (36.6%)</td>
<td align="center">757 (38.7%)</td>
<td align="center">739 (38.1%)</td>
<td align="center">903 (49.7%)</td>
<td align="center">5880 (37.0%)</td>
<td align="right"></td>
</tr>
<tr class="odd">
<td align="left"><strong>tbcat</strong></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="right">&lt; 0.001</td>
</tr>
<tr class="even">
<td align="left">   N-Miss</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">4</td>
<td align="center">4</td>
<td align="right"></td>
</tr>
<tr class="odd">
<td align="left">   a) New TB case</td>
<td align="center">1190 (90.9%)</td>
<td align="center">2214 (89.9%)</td>
<td align="center">2049 (87.3%)</td>
<td align="center">1832 (86.8%)</td>
<td align="center">1701 (86.7%)</td>
<td align="center">1665 (85.1%)</td>
<td align="center">1675 (86.3%)</td>
<td align="center">1598 (88.0%)</td>
<td align="center">13924 (87.6%)</td>
<td align="right"></td>
</tr>
<tr class="even">
<td align="left">   b) Relapse TB case</td>
<td align="center">87 (6.6%)</td>
<td align="center">180 (7.3%)</td>
<td align="center">165 (7.0%)</td>
<td align="center">161 (7.6%)</td>
<td align="center">144 (7.3%)</td>
<td align="center">189 (9.7%)</td>
<td align="center">245 (12.6%)</td>
<td align="center">200 (11.0%)</td>
<td align="center">1371 (8.6%)</td>
<td align="right"></td>
</tr>
<tr class="odd">
<td align="left">   c) Retreatment after default</td>
<td align="center">1 (0.1%)</td>
<td align="center">7 (0.3%)</td>
<td align="center">7 (0.3%)</td>
<td align="center">10 (0.5%)</td>
<td align="center">8 (0.4%)</td>
<td align="center">6 (0.3%)</td>
<td align="center">6 (0.3%)</td>
<td align="center">9 (0.5%)</td>
<td align="center">54 (0.3%)</td>
<td align="right"></td>
</tr>
<tr class="even">
<td align="left">   d) Retreatment after failure</td>
<td align="center">2 (0.2%)</td>
<td align="center">1 (0.0%)</td>
<td align="center">6 (0.3%)</td>
<td align="center">6 (0.3%)</td>
<td align="center">4 (0.2%)</td>
<td align="center">7 (0.4%)</td>
<td align="center">5 (0.3%)</td>
<td align="center">5 (0.3%)</td>
<td align="center">36 (0.2%)</td>
<td align="right"></td>
</tr>
<tr class="odd">
<td align="left">   e) Other</td>
<td align="center">29 (2.2%)</td>
<td align="center">62 (2.5%)</td>
<td align="center">120 (5.1%)</td>
<td align="center">101 (4.8%)</td>
<td align="center">105 (5.4%)</td>
<td align="center">90 (4.6%)</td>
<td align="center">9 (0.5%)</td>
<td align="center">3 (0.2%)</td>
<td align="center">519 (3.3%)</td>
<td align="right"></td>
</tr>
<tr class="even">
<td align="left"><strong>smr_xpert_any</strong></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="right">&lt; 0.001</td>
</tr>
<tr class="odd">
<td align="left">   N-Miss</td>
<td align="center">305</td>
<td align="center">429</td>
<td align="center">464</td>
<td align="center">228</td>
<td align="center">282</td>
<td align="center">412</td>
<td align="center">418</td>
<td align="center">529</td>
<td align="center">3067</td>
<td align="right"></td>
</tr>
<tr class="even">
<td align="left">   a) Smr/Xpert-negative</td>
<td align="center">449 (44.7%)</td>
<td align="center">938 (46.1%)</td>
<td align="center">920 (48.9%)</td>
<td align="center">941 (50.0%)</td>
<td align="center">759 (45.2%)</td>
<td align="center">558 (36.1%)</td>
<td align="center">621 (40.8%)</td>
<td align="center">603 (46.7%)</td>
<td align="center">5789 (45.1%)</td>
<td align="right"></td>
</tr>
<tr class="odd">
<td align="left">   b) Smr/Xpert-positive</td>
<td align="center">555 (55.3%)</td>
<td align="center">1097 (53.9%)</td>
<td align="center">963 (51.1%)</td>
<td align="center">941 (50.0%)</td>
<td align="center">921 (54.8%)</td>
<td align="center">987 (63.9%)</td>
<td align="center">901 (59.2%)</td>
<td align="center">687 (53.3%)</td>
<td align="center">7052 (54.9%)</td>
<td align="right"></td>
</tr>
</tbody>
</table>
<p><br></p>
</div>
<div id="tb-case-notification-rates" class="section level2">
<h2 class="hasAnchor">
<a href="#tb-case-notification-rates" class="anchor"></a>6. TB Case notification rates</h2>
<p>Calculate and summarise TB case notification rates</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r">
<span class="co">#bind cases to week</span>

<span class="no">c</span> <span class="kw">&lt;-</span> <span class="fu">left_join</span>(<span class="no">a</span>, <span class="no">b</span>, <span class="kw">by</span><span class="kw">=</span><span class="st">"y_w"</span>)

<span class="no">c</span> <span class="kw">&lt;-</span> <span class="no">c</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">pop_52</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">ceiling</a></span>(<span class="no">int_pop</span>/<span class="fl">52.25</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">i</span> <span class="kw">=</span> (<span class="no">n</span>/<span class="no">pop_52</span>)*<span class="fl">100000</span>) <span class="kw">%&gt;%</span>
  <span class="no">rowwise</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">xx</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw pkg">broom</span><span class="kw ns">::</span><span class="fu"><a href="https://broom.tidymodels.org/reference/reexports.html">tidy</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/binom.test.html">binom.test</a></span>(<span class="no">n</span>, <span class="no">pop_52</span>, <span class="kw">conf.level</span><span class="kw">=</span><span class="fl">0.95</span>)))) <span class="kw">%&gt;%</span>
  <span class="kw pkg">tidyr</span><span class="kw ns">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span>(<span class="no">xx</span>) <span class="kw">%&gt;%</span>
  <span class="fu">ungroup</span>() <span class="kw">%&gt;%</span>
  <span class="fu">mutate_at</span>(<span class="fu">vars</span>(<span class="no">estimate</span>, <span class="no">conf.low</span>, <span class="no">conf.high</span>), <span class="fu">funs</span>(<span class="no">.</span>*<span class="fl">100000</span>)) <span class="kw">%&gt;%</span>
  <span class="fu">select</span>(-<span class="no">estimate</span>, -<span class="no">statistic</span>, - <span class="no">p.value</span>, -<span class="no">method</span>, -<span class="no">alternative</span>, -<span class="no">parameter</span>)

<span class="co">#Drop the first and last observations - these look odd</span>

<span class="no">d</span> <span class="kw">&lt;-</span> <span class="no">c</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">y_w</span> <span class="kw">!=</span><span class="fu"><a href="http://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span>(<span class="st">"2011-06-27"</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">y_w</span> <span class="kw">!=</span><span class="fu"><a href="http://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span>(<span class="st">"2018-12-31"</span>))

<span class="no">d</span> <span class="kw">&lt;-</span> <span class="no">d</span> <span class="kw">%&gt;%</span>
  <span class="fu">arrange</span>(<span class="no">y_w</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">w2</span> <span class="kw">=</span> <span class="fu">row_number</span>())

<span class="co">#plot case notification rate</span>

<span class="no">CNR</span> <span class="kw">&lt;-</span> <span class="no">d</span> <span class="kw">%&gt;%</span>
  <span class="fu">ggplot</span>() +
  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="kw">x</span><span class="kw">=</span><span class="no">y_w</span>, <span class="kw">ymin</span><span class="kw">=</span><span class="no">conf.low</span>, <span class="kw">ymax</span><span class="kw">=</span><span class="no">conf.high</span>), <span class="kw">alpha</span><span class="kw">=</span><span class="fl">0.3</span>) +
  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="kw">x</span><span class="kw">=</span><span class="no">y_w</span>, <span class="kw">y</span><span class="kw">=</span><span class="no">i</span>)) +
  <span class="fu">labs</span>(<span class="kw">title</span> <span class="kw">=</span> <span class="st">"TB case notification rate"</span>,
       <span class="kw">subtitle</span> <span class="kw">=</span> <span class="st">"Blantyre, Malawi: per week"</span>,
       <span class="kw">y</span><span class="kw">=</span><span class="st">"CNR per 100,000/year"</span>,
       <span class="kw">x</span><span class="kw">=</span><span class="st">"Week"</span>) +
  <span class="fu">theme</span>(<span class="kw">panel.border</span> <span class="kw">=</span> <span class="fu">element_rect</span>(<span class="kw">colour</span> <span class="kw">=</span> <span class="st">"black"</span>, <span class="kw">fill</span><span class="kw">=</span><span class="fl">NA</span>, <span class="kw">size</span><span class="kw">=</span><span class="fl">0.5</span>))  +
  <span class="fu">theme</span>(<span class="kw">axis.text</span> <span class="kw">=</span> <span class="fu">element_text</span>(<span class="kw">family</span> <span class="kw">=</span> <span class="st">"Menlo"</span>, <span class="kw">size</span><span class="kw">=</span><span class="fl">8</span>))+
  <span class="fu">theme</span>(<span class="kw">axis.text.x</span> <span class="kw">=</span> <span class="fu">element_text</span>(<span class="kw">angle</span> <span class="kw">=</span> <span class="fl">45</span>, <span class="kw">hjust</span> <span class="kw">=</span> <span class="fl">1</span>))+
  <span class="fu">theme</span>(<span class="kw">title</span> <span class="kw">=</span> <span class="fu">element_text</span>(<span class="kw">family</span> <span class="kw">=</span> <span class="st">"Oswald"</span>, <span class="kw">size</span><span class="kw">=</span><span class="fl">11</span>)) +
  <span class="fu">theme</span>(<span class="kw">axis.title</span> <span class="kw">=</span> <span class="fu">element_text</span>(<span class="kw">family</span> <span class="kw">=</span> <span class="st">"Oswald"</span>, <span class="kw">size</span> <span class="kw">=</span> <span class="fl">11</span>, <span class="kw">hjust</span> <span class="kw">=</span> <span class="fl">1</span>))

<span class="no">CNR</span></pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
<p><br></p>
<p>TB case notification rates wtih moving averages</p>
<div class="sourceCode" id="cb6"><html><body><pre class="r">
<span class="co">#calculate moving average with different extents of smoothing</span>

<span class="no">CNRma</span> <span class="kw">&lt;-</span> <span class="no">d</span> <span class="kw">%&gt;%</span>
  <span class="fu">select</span>(<span class="no">y_w</span>, <span class="kw">srate</span> <span class="kw">=</span> <span class="no">i</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">srate_ma5</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/zoo/man/rollmean.html">rollmean</a></span>(<span class="no">srate</span>, <span class="kw">k</span> <span class="kw">=</span> <span class="fl">5</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="fl">NA</span>),
         <span class="kw">srate_ma10</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/zoo/man/rollmean.html">rollmean</a></span>(<span class="no">srate</span>, <span class="kw">k</span> <span class="kw">=</span> <span class="fl">10</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="fl">NA</span>),
         <span class="kw">srate_ma25</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/zoo/man/rollmean.html">rollmean</a></span>(<span class="no">srate</span>, <span class="kw">k</span> <span class="kw">=</span> <span class="fl">25</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="fl">NA</span>),
         <span class="kw">srate_ma50</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/zoo/man/rollmean.html">rollmean</a></span>(<span class="no">srate</span>, <span class="kw">k</span> <span class="kw">=</span> <span class="fl">50</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="fl">NA</span>),
         <span class="kw">srate_ma100</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/zoo/man/rollmean.html">rollmean</a></span>(<span class="no">srate</span>, <span class="kw">k</span> <span class="kw">=</span> <span class="fl">100</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="fl">NA</span>))

<span class="co">#plot 10 week moving average</span>

<span class="no">CNR10wma</span> <span class="kw">&lt;-</span> <span class="no">CNRma</span> <span class="kw">%&gt;%</span>
  <span class="fu">gather</span>(<span class="no">metric</span>, <span class="no">value</span>, <span class="no">srate_ma10</span>) <span class="kw">%&gt;%</span>
  <span class="fu">ggplot</span>() +
  <span class="fu">geom_line</span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">d</span>, <span class="fu">aes</span>(<span class="kw">x</span><span class="kw">=</span><span class="fu"><a href="http://lubridate.tidyverse.org/reference/as_date.html">as_date</a></span>(<span class="no">y_w</span>), <span class="kw">y</span><span class="kw">=</span><span class="no">i</span>), <span class="kw">alpha</span><span class="kw">=</span><span class="fl">0.2</span>) +
  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="kw">x</span><span class="kw">=</span> <span class="fu"><a href="http://lubridate.tidyverse.org/reference/as_date.html">as_date</a></span>(<span class="no">y_w</span>), <span class="no">value</span>)) +
  <span class="fu">labs</span>(<span class="kw">title</span> <span class="kw">=</span> <span class="st">"Overall TB case notification rate"</span>,
       <span class="kw">subtitle</span> <span class="kw">=</span> <span class="st">"Weekly &amp; 10-week average"</span>,
       <span class="kw">y</span><span class="kw">=</span><span class="st">"CNR per 100,000/year"</span>,
       <span class="kw">x</span><span class="kw">=</span><span class="st">""</span>)+
  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.window.html">ylim</a></span>(<span class="fl">0</span>,<span class="fl">300</span>) +
  <span class="fu">theme</span>(<span class="kw">panel.border</span> <span class="kw">=</span> <span class="fu">element_rect</span>(<span class="kw">colour</span> <span class="kw">=</span> <span class="st">"black"</span>, <span class="kw">fill</span><span class="kw">=</span><span class="fl">NA</span>, <span class="kw">size</span><span class="kw">=</span><span class="fl">0.5</span>)) +
  <span class="fu">scale_x_date</span>(<span class="kw">date_breaks</span> <span class="kw">=</span> <span class="st">"20 weeks"</span>,
               <span class="kw">date_labels</span> <span class="kw">=</span> <span class="st">"%Y-w%W"</span>)  +
  <span class="fu">theme</span>(<span class="kw">panel.border</span> <span class="kw">=</span> <span class="fu">element_rect</span>(<span class="kw">colour</span> <span class="kw">=</span> <span class="st">"black"</span>, <span class="kw">fill</span><span class="kw">=</span><span class="fl">NA</span>, <span class="kw">size</span><span class="kw">=</span><span class="fl">0.5</span>))  +
  <span class="fu">theme</span>(<span class="kw">axis.text</span> <span class="kw">=</span> <span class="fu">element_text</span>(<span class="kw">family</span> <span class="kw">=</span> <span class="st">"Menlo"</span>, <span class="kw">size</span><span class="kw">=</span><span class="fl">8</span>))+
  <span class="fu">theme</span>(<span class="kw">axis.text.x</span> <span class="kw">=</span> <span class="fu">element_text</span>(<span class="kw">angle</span> <span class="kw">=</span> <span class="fl">45</span>, <span class="kw">hjust</span> <span class="kw">=</span> <span class="fl">1</span>))+
  <span class="fu">theme</span>(<span class="kw">title</span> <span class="kw">=</span> <span class="fu">element_text</span>(<span class="kw">family</span> <span class="kw">=</span> <span class="st">"Oswald"</span>, <span class="kw">size</span><span class="kw">=</span><span class="fl">11</span>)) +
  <span class="fu">theme</span>(<span class="kw">axis.title</span> <span class="kw">=</span> <span class="fu">element_text</span>(<span class="kw">family</span> <span class="kw">=</span> <span class="st">"Oswald"</span>, <span class="kw">size</span> <span class="kw">=</span> <span class="fl">11</span>))

<span class="no">CNR10wma</span></pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-6-1.png" width="700"></p>
<div class="sourceCode" id="cb7"><html><body><pre class="r">
<span class="co"># make figure of CNR and moving average</span>

<span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/ggarrange.html">ggarrange</a></span>(<span class="no">CNR</span>, <span class="no">CNR10wma</span>,
          <span class="kw">labels</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"A"</span>, <span class="st">"B"</span>),
          <span class="kw">ncol</span> <span class="kw">=</span> <span class="fl">1</span>, <span class="kw">nrow</span> <span class="kw">=</span> <span class="fl">2</span>)</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-6-2.png" width="700"></p>
<p><br></p>
</div>
<div id="tb-case-notification-rates-stratified-by-age-sex-hiv-status" class="section level2">
<h2 class="hasAnchor">
<a href="#tb-case-notification-rates-stratified-by-age-sex-hiv-status" class="anchor"></a>7. TB case notification rates stratified by age, sex, HIV status</h2>
<p>First by sex</p>
<div class="sourceCode" id="cb8"><html><body><pre class="r">
##filter sex

bmale &lt;- filter(tbcases, sex == "Male") %&gt;%
  select(reg_date, year_q, year) %&gt;%
  filter(year_q &gt;="2011.3") %&gt;%
  mutate(y_w = yearweek(reg_date))

bmale &lt;- bmale %&gt;%
  group_by(y_w) %&gt;%
  count() %&gt;%
  ungroup()

bmale %&gt;% summarise(sum = sum(n))
# A tibble: 1 x 1
    sum
  &lt;int&gt;
1  9727

cmale &lt;- left_join(a, bmale, by="y_w")

cmale &lt;- cmale %&gt;%
  mutate(pop_52 = ceiling(int_pop/52.25)) %&gt;%
  mutate(i = (n/pop_52)*100000) %&gt;%
  rowwise %&gt;%
  mutate(xx = list(broom::tidy(binom.test(n, pop_52, conf.level=0.95)))) %&gt;%
  tidyr::unnest(xx) %&gt;%
  ungroup() %&gt;%
  mutate_at(vars(estimate, conf.low, conf.high), funs(.*100000)) %&gt;%
  select(-estimate, -statistic, - p.value, -method, -alternative, -parameter)

dmale &lt;- cmale %&gt;%
  filter(y_w !=ymd("2011-06-27")) %&gt;%
  filter(y_w !=ymd("2018-12-31"))

dmale &lt;- dmale %&gt;%
  arrange(y_w) %&gt;%
  mutate(w2 = row_number())

dmalemovingaverage &lt;- dmale %&gt;%
  select(y_w, sratemale = i) %&gt;%
  mutate(srate_ma5male = rollmean(sratemale, k = 5, fill = NA),
         srate_ma10male = rollmean(sratemale, k = 10, fill = NA),
         srate_ma25male = rollmean(sratemale, k = 25, fill = NA),
         srate_ma50male = rollmean(sratemale, k = 50, fill = NA),
         srate_ma100male = rollmean(sratemale, k = 100, fill = NA))

bfemale &lt;- filter(tbcases, sex == "Female") %&gt;%
  select(reg_date, year_q, year) %&gt;%
  filter(year_q &gt;="2011.3") %&gt;%
  mutate(y_w = yearweek(reg_date))

bfemale &lt;- bfemale %&gt;%
  group_by(y_w) %&gt;%
  count() %&gt;%
  ungroup()

bfemale %&gt;% summarise(sum = sum(n))
# A tibble: 1 x 1
    sum
  &lt;int&gt;
1  6181

cfemale &lt;- left_join(a, bfemale, by="y_w")

cfemale &lt;- cfemale %&gt;%
  mutate(pop_52 = ceiling(int_pop/52.25)) %&gt;%
  mutate(i = (n/pop_52)*100000) %&gt;%
  rowwise %&gt;%
  mutate(xx = list(broom::tidy(binom.test(n, pop_52, conf.level=0.95)))) %&gt;%
  tidyr::unnest(xx) %&gt;%
  ungroup() %&gt;%
  mutate_at(vars(estimate, conf.low, conf.high), funs(.*100000)) %&gt;%
  select(-estimate, -statistic, - p.value, -method, -alternative, -parameter)

dfemale &lt;- cfemale %&gt;%
  filter(y_w !=ymd("2011-06-27")) %&gt;%
  filter(y_w !=ymd("2018-12-31"))

dfemale &lt;- dfemale %&gt;%
  arrange(y_w) %&gt;%
  mutate(w2 = row_number())

dfemalemovingaverage &lt;- dfemale %&gt;%
  select(y_w, sratefemale = i) %&gt;%
  mutate(srate_ma5female = rollmean(sratefemale, k = 5, fill = NA),
         srate_ma10female = rollmean(sratefemale, k = 10, fill = NA),
         srate_ma25female = rollmean(sratefemale, k = 25, fill = NA),
         srate_ma50female = rollmean(sratefemale, k = 50, fill = NA),
         srate_ma100female = rollmean(sratefemale, k = 100, fill = NA))

mergesex &lt;- merge(dmalemovingaverage,dfemalemovingaverage, by="y_w")

graphbysex &lt;- mergesex %&gt;%
  ggplot() +
  geom_line(aes(x=as_date(y_w), y=sratemale), alpha=0.2) +
  geom_line(aes(x=as_date(y_w), y=sratefemale), alpha=0.2) +
  geom_line(aes(x=as_date(y_w), y=srate_ma10male), colour="#0d3b66") +
  geom_line(aes(x=as_date(y_w), y=srate_ma10female), colour="#ee964b") +
  labs(title = "TB case notification rates",
       subtitle = "Per week &amp; 10-week averages (&lt;b style='color:#0d3b66'&gt;Male&lt;/b&gt;, &lt;b style='color:#ee964b'&gt;Female&lt;/b&gt;)",
       y="CNR per 100,000/year",
       x="")  +
  theme(panel.border = element_rect(colour = "black", fill=NA, size=0.5)) +
  theme(plot.subtitle = element_markdown(lineheight = 1)) +
  scale_x_date(date_breaks = "20 weeks",
               date_labels = "%Y-w%W")   +
  theme(panel.border = element_rect(colour = "black", fill=NA, size=0.5))  +
  theme(axis.text = element_text(family = "Menlo", size=8))+ 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+ 
  theme(title = element_text(family = "Oswald", size=11)) +
  theme(axis.title = element_text(family = "Oswald", size = 11))


graphbysex</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-7-1.png" width="700"></p>
<p><br></p>
<p>Now by HIV status</p>
<div class="sourceCode" id="cb9"><html><body><pre class="r">
bHIVpos &lt;- filter(tbcases, hiv == "b) HIV-positive") %&gt;%
  select(reg_date, year_q, year) %&gt;%
  filter(year_q &gt;="2011.3") %&gt;%
  mutate(y_w = yearweek(reg_date))

bHIVpos &lt;- bHIVpos %&gt;%
  group_by(y_w) %&gt;%
  count() %&gt;%
  ungroup()

bHIVpos %&gt;% summarise(sum = sum(n))
# A tibble: 1 x 1
    sum
  &lt;int&gt;
1 10421

cHIVpos &lt;- left_join(a, bHIVpos, by="y_w")

cHIVpos &lt;- cHIVpos %&gt;%
  mutate(pop_52 = ceiling(int_pop/52.25)) %&gt;%
  mutate(i = (n/pop_52)*100000) %&gt;%
  rowwise %&gt;%
  mutate(xx = list(broom::tidy(binom.test(n, pop_52, conf.level=0.95)))) %&gt;%
  tidyr::unnest(xx) %&gt;%
  ungroup() %&gt;%
  mutate_at(vars(estimate, conf.low, conf.high), funs(.*100000)) %&gt;%
  select(-estimate, -statistic, - p.value, -method, -alternative, -parameter)

dHIVpos &lt;- cHIVpos %&gt;%
  filter(y_w !=ymd("2011-06-27")) %&gt;%
  filter(y_w !=ymd("2018-12-31"))

dHIVpos &lt;- dHIVpos %&gt;%
  arrange(y_w) %&gt;%
  mutate(w2 = row_number())

dHIVposmovingaverage &lt;- dHIVpos %&gt;%
  select(y_w, srateHIVpos = i) %&gt;%
  mutate(srate_ma5HIVpos = rollmean(srateHIVpos, k = 5, fill = NA),
         srate_ma10HIVpos = rollmean(srateHIVpos, k = 10, fill = NA),
         srate_ma25HIVpos = rollmean(srateHIVpos, k = 25, fill = NA),
         srate_ma50HIVpos = rollmean(srateHIVpos, k = 50, fill = NA),
         srate_ma100HIVpos = rollmean(srateHIVpos, k = 100, fill = NA))

bHIVneg &lt;- filter(tbcases, hiv == "a) HIV-negative") %&gt;%
  select(reg_date, year_q, year) %&gt;%
  filter(year_q &gt;="2011.3") %&gt;%
  mutate(y_w = yearweek(reg_date))

bHIVneg &lt;- bHIVneg %&gt;%
  group_by(y_w) %&gt;%
  count() %&gt;%
  ungroup()

bHIVneg %&gt;% summarise(sum = sum(n))
# A tibble: 1 x 1
    sum
  &lt;int&gt;
1  4407

cHIVneg &lt;- left_join(a, bHIVneg, by="y_w")

cHIVneg &lt;- cHIVneg %&gt;%
  mutate(pop_52 = ceiling(int_pop/52.25)) %&gt;%
  mutate(i = (n/pop_52)*100000) %&gt;%
  rowwise %&gt;%
  mutate(xx = list(broom::tidy(binom.test(n, pop_52, conf.level=0.95)))) %&gt;%
  tidyr::unnest(xx) %&gt;%
  ungroup() %&gt;%
  mutate_at(vars(estimate, conf.low, conf.high), funs(.*100000)) %&gt;%
  select(-estimate, -statistic, - p.value, -method, -alternative, -parameter)

dHIVneg &lt;- cHIVneg %&gt;%
  filter(y_w !=ymd("2011-06-27")) %&gt;%
  filter(y_w !=ymd("2018-12-31"))

dHIVneg &lt;- dHIVneg %&gt;%
  arrange(y_w) %&gt;%
  mutate(w2 = row_number())

dHIVnegmovingaverage &lt;- dHIVneg %&gt;%
  select(y_w, srateHIVneg = i) %&gt;%
  mutate(srate_ma5HIVneg = rollmean(srateHIVneg, k = 5, fill = NA),
         srate_ma10HIVneg = rollmean(srateHIVneg, k = 10, fill = NA),
         srate_ma25HIVneg = rollmean(srateHIVneg, k = 25, fill = NA),
         srate_ma50HIVneg = rollmean(srateHIVneg, k = 50, fill = NA),
         srate_ma100HIVneg = rollmean(srateHIVneg, k = 100, fill = NA))

mergeHIV &lt;- merge(dHIVposmovingaverage,dHIVnegmovingaverage, by="y_w")

graphbyHIV &lt;- mergeHIV %&gt;%
  ggplot() +
  geom_line(aes(x=as_date(y_w), y=srateHIVneg), alpha=0.2) +
  geom_line(aes(x=as_date(y_w), y=srateHIVpos), alpha=0.2) +
  geom_line(aes(x=as_date(y_w), y=srate_ma10HIVneg), colour="#247ba0") +
  geom_line(aes(x=as_date(y_w), y=srate_ma10HIVpos), colour="#f25f5c") +
  labs(title = "TB case notification rates",
       subtitle = "Per week &amp; 10-week averages (&lt;b style='color:#f25f5c'&gt;HIV-positive&lt;/b&gt;, &lt;b style='color:#247ba0'&gt;HIV-negative&lt;/b&gt;)",
       y="CNR per 100,000/year",
       x="")  +
  theme(panel.border = element_rect(colour = "black", fill=NA, size=0.5))+
  theme(
    plot.subtitle = element_markdown(lineheight = 1)) +
  scale_x_date(date_breaks = "20 weeks",
               date_labels = "%Y-w%W")  +
  theme(panel.border = element_rect(colour = "black", fill=NA, size=0.5))  +
  theme(axis.text = element_text(family = "Menlo", size=8))+ 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+ 
  theme(title = element_text(family = "Oswald", size=11)) +
  theme(axis.title = element_text(family = "Oswald", size = 11))



graphbyHIV</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-8-1.png" width="700"></p>
<p><br></p>
<p>Now by age group</p>
<div class="sourceCode" id="cb10"><html><body><pre class="r">

bunder20 &lt;- filter(tbcases, age &lt; 20) %&gt;%
  select(reg_date, year_q, year) %&gt;%
  filter(year_q &gt;="2011.3") %&gt;%
  mutate(y_w = yearweek(reg_date))

bunder20 &lt;- bunder20 %&gt;%
  group_by(y_w) %&gt;%
  count() %&gt;%
  ungroup()

bunder20 %&gt;% summarise(sum = sum(n))
# A tibble: 1 x 1
    sum
  &lt;int&gt;
1  1857

cunder20 &lt;- left_join(a, bunder20, by="y_w")
cunder20[is.na(cunder20)] &lt;- 0

cunder20 &lt;- cunder20 %&gt;%
  mutate(pop_52 = ceiling(int_pop/52.25)) %&gt;%
  mutate(i = (n/pop_52)*100000) %&gt;%
  rowwise %&gt;%
  mutate(xx = list(broom::tidy(binom.test(n, pop_52, conf.level=0.95)))) %&gt;%
  tidyr::unnest(xx) %&gt;%
  ungroup() %&gt;%
  mutate_at(vars(estimate, conf.low, conf.high), funs(.*100000)) %&gt;%
  select(-estimate, -statistic, - p.value, -method, -alternative, -parameter)

dunder20 &lt;- cunder20 %&gt;%
  filter(y_w !=ymd("2011-06-27")) %&gt;%
  filter(y_w !=ymd("2018-12-31"))

dunder20 &lt;- dunder20 %&gt;%
  arrange(y_w) %&gt;%
  mutate(w2 = row_number())

dunder20movingaverage &lt;- dunder20 %&gt;%
  select(y_w, srateunder20 = i) %&gt;%
  mutate(srate_ma5under20 = rollmean(srateunder20, k = 5, fill = NA),
         srate_ma10under20 = rollmean(srateunder20, k = 10, fill = NA),
         srate_ma25under20 = rollmean(srateunder20, k = 25, fill = NA),
         srate_ma50under20 = rollmean(srateunder20, k = 50, fill = NA),
         srate_ma100under20 = rollmean(srateunder20, k = 100, fill = NA))

bbet20_40 &lt;- filter(tbcases, age &gt;= 20 &amp; age &lt;40) %&gt;%
  select(reg_date, year_q, year) %&gt;%
  filter(year_q &gt;="2011.3") %&gt;%
  mutate(y_w = yearweek(reg_date))

bbet20_40 &lt;- bbet20_40 %&gt;%
  group_by(y_w) %&gt;%
  count() %&gt;%
  ungroup()

bbet20_40 %&gt;% summarise(sum = sum(n))
# A tibble: 1 x 1
    sum
  &lt;int&gt;
1  9341

cbet20_40 &lt;- left_join(a, bbet20_40, by="y_w")

cbet20_40 &lt;- cbet20_40 %&gt;%
  mutate(pop_52 = ceiling(int_pop/52.25)) %&gt;%
  mutate(i = (n/pop_52)*100000) %&gt;%
  rowwise %&gt;%
  mutate(xx = list(broom::tidy(binom.test(n, pop_52, conf.level=0.95)))) %&gt;%
  tidyr::unnest(xx) %&gt;%
  ungroup() %&gt;%
  mutate_at(vars(estimate, conf.low, conf.high), funs(.*100000)) %&gt;%
  select(-estimate, -statistic, - p.value, -method, -alternative, -parameter)

dbet20_40 &lt;- cbet20_40 %&gt;%
  filter(y_w !=ymd("2011-06-27")) %&gt;%
  filter(y_w !=ymd("2018-12-31"))

dbet20_40 &lt;- dbet20_40 %&gt;%
  arrange(y_w) %&gt;%
  mutate(w2 = row_number())

dbet20_40movingaverage &lt;- dbet20_40 %&gt;%
  select(y_w, sratebet20_40 = i) %&gt;%
  mutate(srate_ma5bet20_40 = rollmean(sratebet20_40, k = 5, fill = NA),
         srate_ma10bet20_40 = rollmean(sratebet20_40, k = 10, fill = NA),
         srate_ma25bet20_40 = rollmean(sratebet20_40, k = 25, fill = NA),
         srate_ma50bet20_40 = rollmean(sratebet20_40, k = 50, fill = NA),
         srate_ma100bet20_40 = rollmean(sratebet20_40, k = 100, fill = NA))

bover40 &lt;- filter(tbcases, age &gt;= 40) %&gt;%
  select(reg_date, year_q, year) %&gt;%
  filter(year_q &gt;="2011.3") %&gt;%
  mutate(y_w = yearweek(reg_date))

bover40 &lt;- bover40 %&gt;%
  group_by(y_w) %&gt;%
  count() %&gt;%
  ungroup()

bover40 %&gt;% summarise(sum = sum(n))
# A tibble: 1 x 1
    sum
  &lt;int&gt;
1  4710

cover40 &lt;- left_join(a, bover40, by="y_w")
cover40[is.na(cover40)] &lt;- 0

cover40 &lt;- cover40 %&gt;%
  mutate(pop_52 = ceiling(int_pop/52.25)) %&gt;%
  mutate(i = (n/pop_52)*100000) %&gt;%
  rowwise %&gt;%
  mutate(xx = list(broom::tidy(binom.test(n, pop_52, conf.level=0.95)))) %&gt;%
  tidyr::unnest(xx) %&gt;%
  ungroup() %&gt;%
  mutate_at(vars(estimate, conf.low, conf.high), funs(.*100000)) %&gt;%
  select(-estimate, -statistic, - p.value, -method, -alternative, -parameter)

dover40 &lt;- cover40 %&gt;%
  filter(y_w !=ymd("2011-06-27")) %&gt;%
  filter(y_w !=ymd("2018-12-31"))

dover40 &lt;- dover40 %&gt;%
  arrange(y_w) %&gt;%
  mutate(w2 = row_number())

dover40movingaverage &lt;- dover40 %&gt;%
  select(y_w, srateover40 = i) %&gt;%
  mutate(srate_ma5over40 = rollmean(srateover40, k = 5, fill = NA),
         srate_ma10over40 = rollmean(srateover40, k = 10, fill = NA),
         srate_ma25over40 = rollmean(srateover40, k = 25, fill = NA),
         srate_ma50over40 = rollmean(srateover40, k = 50, fill = NA),
         srate_ma100over40 = rollmean(srateover40, k = 100, fill = NA))

mergeage &lt;- merge(dunder20movingaverage,dbet20_40movingaverage, by="y_w")
mergeage &lt;- merge(mergeage, dover40movingaverage, by="y_w")

graphbyage &lt;- mergeage %&gt;%
  ggplot() +
  geom_line(aes(x=as_date(y_w), y=srateunder20), alpha=0.2) +
  geom_line(aes(x=as_date(y_w), y=sratebet20_40), alpha=0.2) +
  geom_line(aes(x=as_date(y_w), y=srateover40), alpha=0.2) +
  geom_line(aes(x=as_date(y_w), y=srate_ma10under20), colour="#ef476f") +
  geom_line(aes(x=as_date(y_w), y=srate_ma10bet20_40), colour="#118ab2") +
  geom_line(aes(x=as_date(y_w), y=srate_ma10over40), colour="#073b4c") +
  labs(title = "TB case notification rates",
       subtitle = "Per week &amp; 10-week averages (&lt;b style='color:#ef476f'&gt;0-20&lt;/b&gt;, &lt;b style='color:#118ab2'&gt;20-40&lt;/b&gt;, &lt;b style='color:#073b4c'&gt;40+ years&lt;/b&gt;)",
       y="CNR per 100,000/year",
       x="")  +
  theme(panel.border = element_rect(colour = "black", fill=NA, size=0.5))+
  theme(
    plot.subtitle = element_markdown(lineheight = 1)) +
  scale_x_date(date_breaks = "20 weeks",
               date_labels = "%Y-w%W")  +
  theme(panel.border = element_rect(colour = "black", fill=NA, size=0.5))  +
  theme(axis.text = element_text(family = "Menlo", size=8))+ 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+ 
  theme(title = element_text(family = "Oswald", size=11)) +
  theme(axis.title = element_text(family = "Oswald", size = 11))



graphbyage</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-9-1.png" width="700"></p>
<p><br></p>
</div>
<div id="figure-1-combine-graphs-together" class="section level2">
<h2 class="hasAnchor">
<a href="#figure-1-combine-graphs-together" class="anchor"></a>8. Figure 1: Combine graphs together</h2>
<div class="sourceCode" id="cb11"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/ggarrange.html">ggarrange</a></span>(<span class="no">graphbyage</span>, <span class="no">graphbysex</span>, <span class="no">graphbyHIV</span>,
          <span class="kw">labels</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"A"</span>, <span class="st">"B"</span>, <span class="st">"C"</span>),
          <span class="kw">ncol</span> <span class="kw">=</span> <span class="fl">1</span>, <span class="kw">nrow</span> <span class="kw">=</span> <span class="fl">3</span>)</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-10-1.png" width="700"></p>
<div class="sourceCode" id="cb12"><html><body><pre class="r">
<span class="fu">ggsave</span>(<span class="fu"><a href="https://rdrr.io/pkg/here/man/here.html">here</a></span>(<span class="st">"figures/figure1.png"</span>), <span class="kw">dpi</span><span class="kw">=</span><span class="fl">600</span>, <span class="kw">width</span><span class="kw">=</span><span class="fl">9</span>, <span class="kw">height</span><span class="kw">=</span><span class="fl">10</span>)</pre></body></html></div>
<p><br></p>
</div>
<div id="figure-2-weather-data" class="section level2">
<h2 class="hasAnchor">
<a href="#figure-2-weather-data" class="anchor"></a>9. Figure 2: weather data</h2>
<p>First temperature</p>
<div class="sourceCode" id="cb13"><html><body><pre class="r">
<span class="no">df2</span> <span class="kw">&lt;-</span>  <span class="no">mweather</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">reg_date</span> <span class="kw">=</span> <span class="fu"><a href="http://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span>(<span class="no">YEARMODA</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">dow</span> <span class="kw">=</span> <span class="fu"><a href="http://lubridate.tidyverse.org/reference/day.html">wday</a></span>(<span class="no">reg_date</span>, <span class="kw">label</span><span class="kw">=</span><span class="fl">TRUE</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">dom</span> <span class="kw">=</span> <span class="fu"><a href="http://lubridate.tidyverse.org/reference/day.html">mday</a></span>(<span class="no">reg_date</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">doy</span> <span class="kw">=</span> <span class="fu"><a href="http://lubridate.tidyverse.org/reference/day.html">yday</a></span>(<span class="no">reg_date</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">month</span> <span class="kw">=</span> <span class="fu"><a href="http://lubridate.tidyverse.org/reference/month.html">month</a></span>(<span class="no">reg_date</span>, <span class="kw">label</span><span class="kw">=</span><span class="fl">TRUE</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">year</span> <span class="kw">=</span> <span class="fu"><a href="http://lubridate.tidyverse.org/reference/year.html">year</a></span>(<span class="no">reg_date</span>))

<span class="co"># arrange by date then remove rows for first 3 months of 2011 where no equivalent data for cases</span>

<span class="no">df2</span> <span class="kw">&lt;-</span> <span class="no">df2</span>[-<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1</span>:<span class="fl">79</span>),]


<span class="co"># plot daily temperature</span>

<span class="fu">ggplot</span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">df2</span>) +
  <span class="fu">geom_line</span>(<span class="kw">mapping</span> <span class="kw">=</span> <span class="fu">aes</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">reg_date</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">TEMP</span>))</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-11-1.png" width="700"></p>
<div class="sourceCode" id="cb14"><html><body><pre class="r">
<span class="co">#calculate moving average temp with different levels of variability</span>

<span class="no">df2movingavetemp</span> <span class="kw">&lt;-</span> <span class="no">df2</span> <span class="kw">%&gt;%</span>
  <span class="fu">select</span>(<span class="no">reg_date</span>, <span class="kw">sratetemp</span> <span class="kw">=</span> <span class="no">TEMP</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">srate_ma5temp</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/zoo/man/rollmean.html">rollmean</a></span>(<span class="no">sratetemp</span>, <span class="kw">k</span> <span class="kw">=</span> <span class="fl">5</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="fl">NA</span>),
         <span class="kw">srate_ma10temp</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/zoo/man/rollmean.html">rollmean</a></span>(<span class="no">sratetemp</span>, <span class="kw">k</span> <span class="kw">=</span> <span class="fl">10</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="fl">NA</span>),
         <span class="kw">srate_ma25temp</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/zoo/man/rollmean.html">rollmean</a></span>(<span class="no">sratetemp</span>, <span class="kw">k</span> <span class="kw">=</span> <span class="fl">25</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="fl">NA</span>),
         <span class="kw">srate_ma70temp</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/zoo/man/rollmean.html">rollmean</a></span>(<span class="no">sratetemp</span>, <span class="kw">k</span> <span class="kw">=</span> <span class="fl">70</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="fl">NA</span>),
         <span class="kw">srate_ma100temp</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/zoo/man/rollmean.html">rollmean</a></span>(<span class="no">sratetemp</span>, <span class="kw">k</span> <span class="kw">=</span> <span class="fl">100</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="fl">NA</span>))


<span class="co">#plot temp moving average</span>

<span class="no">tempma</span> <span class="kw">&lt;-</span> <span class="no">df2movingavetemp</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">reg_date</span> <span class="kw">&gt;=</span> <span class="fu"><a href="http://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span>(<span class="st">"2011-07-02"</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">reg_date</span> <span class="kw">&lt;=</span> <span class="fu"><a href="http://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span>(<span class="st">"2018-12-31"</span>)) <span class="kw">%&gt;%</span>
  <span class="fu">gather</span>(<span class="no">metric</span>, <span class="no">value</span>, <span class="no">srate_ma70temp</span>) <span class="kw">%&gt;%</span>
  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="no">reg_date</span>, <span class="no">value</span>, <span class="kw">color</span> <span class="kw">=</span> <span class="no">metric</span>)) +
  <span class="fu">geom_line</span>()+
  <span class="fu">labs</span>(<span class="kw">title</span> <span class="kw">=</span> <span class="st">"Temperature"</span>,
       <span class="kw">subtitle</span> <span class="kw">=</span> <span class="st">"10-week average"</span>,
       <span class="kw">y</span><span class="kw">=</span><span class="st">"Temperature (Celsius)"</span>,
       <span class="kw">x</span><span class="kw">=</span><span class="st">"Epidemiological week"</span>) +
  <span class="fu">theme</span>(<span class="kw">panel.border</span> <span class="kw">=</span> <span class="fu">element_rect</span>(<span class="kw">colour</span> <span class="kw">=</span> <span class="st">"black"</span>, <span class="kw">fill</span><span class="kw">=</span><span class="fl">NA</span>, <span class="kw">size</span><span class="kw">=</span><span class="fl">0.5</span>),<span class="kw">legend.position</span> <span class="kw">=</span> <span class="st">"none"</span>) +
  <span class="fu">scale_color_manual</span>(<span class="kw">values</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"#264653"</span>)) +
  <span class="fu">scale_x_date</span>(<span class="kw">date_breaks</span> <span class="kw">=</span> <span class="st">"20 weeks"</span>,
               <span class="kw">date_labels</span> <span class="kw">=</span> <span class="st">"%Y-w%W"</span>)  +
  <span class="fu">theme</span>(<span class="kw">panel.border</span> <span class="kw">=</span> <span class="fu">element_rect</span>(<span class="kw">colour</span> <span class="kw">=</span> <span class="st">"black"</span>, <span class="kw">fill</span><span class="kw">=</span><span class="fl">NA</span>, <span class="kw">size</span><span class="kw">=</span><span class="fl">0.5</span>))  +
  <span class="fu">theme</span>(<span class="kw">axis.text</span> <span class="kw">=</span> <span class="fu">element_text</span>(<span class="kw">family</span> <span class="kw">=</span> <span class="st">"Menlo"</span>, <span class="kw">size</span><span class="kw">=</span><span class="fl">8</span>))+
  <span class="fu">theme</span>(<span class="kw">axis.text.x</span> <span class="kw">=</span> <span class="fu">element_text</span>(<span class="kw">angle</span> <span class="kw">=</span> <span class="fl">45</span>, <span class="kw">hjust</span> <span class="kw">=</span> <span class="fl">1</span>))+
  <span class="fu">theme</span>(<span class="kw">title</span> <span class="kw">=</span> <span class="fu">element_text</span>(<span class="kw">family</span> <span class="kw">=</span> <span class="st">"Oswald"</span>, <span class="kw">size</span><span class="kw">=</span><span class="fl">11</span>)) +
  <span class="fu">theme</span>(<span class="kw">axis.title</span> <span class="kw">=</span> <span class="fu">element_text</span>(<span class="kw">family</span> <span class="kw">=</span> <span class="st">"Oswald"</span>, <span class="kw">size</span> <span class="kw">=</span> <span class="fl">11</span>, <span class="kw">vjust</span><span class="kw">=</span>-<span class="fl">2</span>))

<span class="no">tempma</span></pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-11-2.png" width="700"></p>
<p>Precipitation</p>
<div class="sourceCode" id="cb15"><html><body><pre class="r">

<span class="no">prcpma</span> <span class="kw">&lt;-</span> <span class="no">df2</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">reg_date</span> <span class="kw">&gt;=</span> <span class="fu"><a href="http://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span>(<span class="st">"2011-07-02"</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">reg_date</span> <span class="kw">&lt;=</span> <span class="fu"><a href="http://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span>(<span class="st">"2018-12-31"</span>)) <span class="kw">%&gt;%</span>
  <span class="fu">ggplot</span>() +
  <span class="fu">geom_line</span>(<span class="kw">mapping</span> <span class="kw">=</span> <span class="fu">aes</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">reg_date</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">PRCP</span>), <span class="kw">colour</span><span class="kw">=</span><span class="st">"#2a9d8f"</span>)+
  <span class="fu">labs</span>(<span class="kw">title</span> <span class="kw">=</span> <span class="st">"Rainfall"</span>,
       <span class="kw">subtitle</span> <span class="kw">=</span> <span class="st">"Daily rainfall"</span>,
       <span class="kw">y</span><span class="kw">=</span><span class="st">"Precipitation (mm)"</span>,
       <span class="kw">x</span><span class="kw">=</span><span class="st">"Epidemiological week"</span>) +
  <span class="fu">theme</span>(<span class="kw">panel.border</span> <span class="kw">=</span> <span class="fu">element_rect</span>(<span class="kw">colour</span> <span class="kw">=</span> <span class="st">"black"</span>, <span class="kw">fill</span><span class="kw">=</span><span class="fl">NA</span>, <span class="kw">size</span><span class="kw">=</span><span class="fl">0.5</span>),<span class="kw">legend.position</span> <span class="kw">=</span> <span class="st">"none"</span>)  +
  <span class="fu">scale_x_date</span>(<span class="kw">date_breaks</span> <span class="kw">=</span> <span class="st">"20 weeks"</span>,
               <span class="kw">date_labels</span> <span class="kw">=</span> <span class="st">"%Y-w%W"</span>) +
  <span class="fu">theme</span>(<span class="kw">panel.border</span> <span class="kw">=</span> <span class="fu">element_rect</span>(<span class="kw">colour</span> <span class="kw">=</span> <span class="st">"black"</span>, <span class="kw">fill</span><span class="kw">=</span><span class="fl">NA</span>, <span class="kw">size</span><span class="kw">=</span><span class="fl">0.5</span>))  +
  <span class="fu">theme</span>(<span class="kw">axis.text</span> <span class="kw">=</span> <span class="fu">element_text</span>(<span class="kw">family</span> <span class="kw">=</span> <span class="st">"Menlo"</span>, <span class="kw">size</span><span class="kw">=</span><span class="fl">8</span>))+
  <span class="fu">theme</span>(<span class="kw">axis.text.x</span> <span class="kw">=</span> <span class="fu">element_text</span>(<span class="kw">angle</span> <span class="kw">=</span> <span class="fl">45</span>, <span class="kw">hjust</span> <span class="kw">=</span> <span class="fl">1</span>))+
  <span class="fu">theme</span>(<span class="kw">title</span> <span class="kw">=</span> <span class="fu">element_text</span>(<span class="kw">family</span> <span class="kw">=</span> <span class="st">"Oswald"</span>, <span class="kw">size</span><span class="kw">=</span><span class="fl">11</span>)) +
  <span class="fu">theme</span>(<span class="kw">axis.title</span> <span class="kw">=</span> <span class="fu">element_text</span>(<span class="kw">family</span> <span class="kw">=</span> <span class="st">"Oswald"</span>, <span class="kw">size</span> <span class="kw">=</span> <span class="fl">11</span>, <span class="kw">vjust</span><span class="kw">=</span>-<span class="fl">2</span>))

<span class="no">prcpma</span></pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-12-1.png" width="700"></p>
<div class="sourceCode" id="cb16"><html><body><pre class="r">
<span class="co">#calculate moving average rain with different levels of variability</span>

<span class="no">df2movingavePRCP</span> <span class="kw">&lt;-</span> <span class="no">df2</span> <span class="kw">%&gt;%</span>
  <span class="fu">select</span>(<span class="no">reg_date</span>, <span class="kw">srateprcp</span> <span class="kw">=</span> <span class="no">PRCP</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">srate_ma7prcp</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/zoo/man/rollmean.html">rollmean</a></span>(<span class="no">srateprcp</span>, <span class="kw">k</span> <span class="kw">=</span> <span class="fl">7</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="fl">NA</span>),
         <span class="kw">srate_ma10prcp</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/zoo/man/rollmean.html">rollmean</a></span>(<span class="no">srateprcp</span>, <span class="kw">k</span> <span class="kw">=</span> <span class="fl">10</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="fl">NA</span>),
         <span class="kw">srate_ma25prcp</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/zoo/man/rollmean.html">rollmean</a></span>(<span class="no">srateprcp</span>, <span class="kw">k</span> <span class="kw">=</span> <span class="fl">25</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="fl">NA</span>),
         <span class="kw">srate_ma70prcp</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/zoo/man/rollmean.html">rollmean</a></span>(<span class="no">srateprcp</span>, <span class="kw">k</span> <span class="kw">=</span> <span class="fl">70</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="fl">NA</span>),
         <span class="kw">srate_ma100prcp</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/zoo/man/rollmean.html">rollmean</a></span>(<span class="no">srateprcp</span>, <span class="kw">k</span> <span class="kw">=</span> <span class="fl">100</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="fl">NA</span>))

<span class="no">NAprcp</span> <span class="kw">&lt;-</span> <span class="no">df2movingavePRCP</span> <span class="kw">%&gt;%</span>
  <span class="fu">gather</span>(<span class="no">metric</span>, <span class="no">value</span>, <span class="no">srate_ma7prcp</span>) <span class="kw">%&gt;%</span>
  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="no">reg_date</span>, <span class="no">value</span>, <span class="kw">color</span> <span class="kw">=</span> <span class="no">metric</span>)) +
  <span class="fu">geom_line</span>()+
  <span class="fu">labs</span>(<span class="kw">title</span> <span class="kw">=</span> <span class="st">"Precipitation"</span>,
       <span class="kw">y</span><span class="kw">=</span><span class="st">"Precipitation"</span>,
       <span class="kw">x</span><span class="kw">=</span><span class="st">"Epidemiological weeks"</span>) +
  <span class="fu">theme</span>(<span class="kw">panel.border</span> <span class="kw">=</span> <span class="fu">element_rect</span>(<span class="kw">colour</span> <span class="kw">=</span> <span class="st">"black"</span>, <span class="kw">fill</span><span class="kw">=</span><span class="fl">NA</span>, <span class="kw">size</span><span class="kw">=</span><span class="fl">0.5</span>),<span class="kw">legend.position</span> <span class="kw">=</span> <span class="st">"none"</span>) +
  <span class="fu">scale_color_manual</span>(<span class="kw">values</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"#f4a261"</span>))  +
  <span class="fu">scale_x_date</span>(<span class="kw">date_breaks</span> <span class="kw">=</span> <span class="st">"20 weeks"</span>,
               <span class="kw">date_labels</span> <span class="kw">=</span> <span class="st">"%Y-w%W"</span>) +
  <span class="fu">theme</span>(<span class="kw">axis.text.x</span> <span class="kw">=</span> <span class="fu">element_text</span>(<span class="kw">angle</span> <span class="kw">=</span> <span class="fl">45</span>, <span class="kw">hjust</span> <span class="kw">=</span> <span class="fl">1</span>))+
  <span class="fu">theme</span>(<span class="kw">plot.title</span> <span class="kw">=</span> <span class="fu">element_text</span>(<span class="kw">size</span><span class="kw">=</span><span class="fl">12</span>))

<span class="no">NAprcp</span></pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-12-2.png" width="700"></p>
<p><br></p>
<p>Wind speed</p>
<div class="sourceCode" id="cb17"><html><body><pre class="r">

<span class="no">df2movingaveWDSP</span> <span class="kw">&lt;-</span> <span class="no">df2</span> <span class="kw">%&gt;%</span>
  <span class="fu">select</span>(<span class="no">reg_date</span>, <span class="kw">sratewdsp</span> <span class="kw">=</span> <span class="no">WDSP</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">srate_ma5wdsp</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/zoo/man/rollmean.html">rollmean</a></span>(<span class="no">sratewdsp</span>, <span class="kw">k</span> <span class="kw">=</span> <span class="fl">5</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="fl">NA</span>),
         <span class="kw">srate_ma10wdsp</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/zoo/man/rollmean.html">rollmean</a></span>(<span class="no">sratewdsp</span>, <span class="kw">k</span> <span class="kw">=</span> <span class="fl">10</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="fl">NA</span>),
         <span class="kw">srate_ma25wdsp</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/zoo/man/rollmean.html">rollmean</a></span>(<span class="no">sratewdsp</span>, <span class="kw">k</span> <span class="kw">=</span> <span class="fl">25</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="fl">NA</span>),
         <span class="kw">srate_ma70wdsp</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/zoo/man/rollmean.html">rollmean</a></span>(<span class="no">sratewdsp</span>, <span class="kw">k</span> <span class="kw">=</span> <span class="fl">70</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="fl">NA</span>),
         <span class="kw">srate_ma100wdsp</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/zoo/man/rollmean.html">rollmean</a></span>(<span class="no">sratewdsp</span>, <span class="kw">k</span> <span class="kw">=</span> <span class="fl">100</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="fl">NA</span>))

<span class="co">#plot count and wind moving average</span>

<span class="no">wdspma</span> <span class="kw">&lt;-</span> <span class="no">df2movingaveWDSP</span> <span class="kw">%&gt;%</span>
  <span class="fu">gather</span>(<span class="no">metric</span>, <span class="no">value</span>, <span class="no">srate_ma70wdsp</span>) <span class="kw">%&gt;%</span>
  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="no">reg_date</span>, <span class="no">value</span>, <span class="kw">color</span> <span class="kw">=</span> <span class="no">metric</span>)) +
  <span class="fu">geom_line</span>()+
  <span class="fu">labs</span>(<span class="kw">title</span> <span class="kw">=</span> <span class="st">"Wind Speed"</span>,
       <span class="kw">subtitle</span> <span class="kw">=</span> <span class="st">"10 week moving average"</span>,
       <span class="kw">y</span><span class="kw">=</span><span class="st">"Wind speed (m/s)"</span>,
       <span class="kw">x</span><span class="kw">=</span><span class="st">"Epidemiological week"</span>) +
  <span class="fu">theme</span>(<span class="kw">panel.border</span> <span class="kw">=</span> <span class="fu">element_rect</span>(<span class="kw">colour</span> <span class="kw">=</span> <span class="st">"black"</span>, <span class="kw">fill</span><span class="kw">=</span><span class="fl">NA</span>, <span class="kw">size</span><span class="kw">=</span><span class="fl">0.5</span>), <span class="kw">legend.position</span> <span class="kw">=</span> <span class="st">"none"</span>) +
  <span class="fu">scale_color_manual</span>(<span class="kw">values</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"#f4a261"</span>))  +
  <span class="fu">scale_x_date</span>(<span class="kw">date_breaks</span> <span class="kw">=</span> <span class="st">"20 weeks"</span>,
               <span class="kw">date_labels</span> <span class="kw">=</span> <span class="st">"%Y-w%W"</span>) +
  <span class="fu">theme</span>(<span class="kw">axis.text.x</span> <span class="kw">=</span> <span class="fu">element_text</span>(<span class="kw">angle</span> <span class="kw">=</span> <span class="fl">45</span>, <span class="kw">hjust</span> <span class="kw">=</span> <span class="fl">1</span>))+
  <span class="fu">theme</span>(<span class="kw">plot.title</span> <span class="kw">=</span> <span class="fu">element_text</span>(<span class="kw">size</span><span class="kw">=</span><span class="fl">12</span>))

<span class="no">wdspma</span></pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-13-1.png" width="700"></p>
<p><br></p>
<p>Dew point/humidity</p>
<div class="sourceCode" id="cb18"><html><body><pre class="r">

<span class="fu">ggplot</span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">df2</span>) +
  <span class="fu">geom_line</span>(<span class="kw">mapping</span> <span class="kw">=</span> <span class="fu">aes</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">reg_date</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">DEWP</span>))</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-14-1.png" width="700"></p>
<div class="sourceCode" id="cb19"><html><body><pre class="r">
<span class="co">#calculate moving average humidity with different levels of variability</span>

<span class="no">df2movingaveDEWP</span> <span class="kw">&lt;-</span> <span class="no">df2</span> <span class="kw">%&gt;%</span>
  <span class="fu">select</span>(<span class="no">reg_date</span>, <span class="kw">sratedewp</span> <span class="kw">=</span> <span class="no">WDSP</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">srate_ma5dewp</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/zoo/man/rollmean.html">rollmean</a></span>(<span class="no">sratedewp</span>, <span class="kw">k</span> <span class="kw">=</span> <span class="fl">5</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="fl">NA</span>),
         <span class="kw">srate_ma10dewp</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/zoo/man/rollmean.html">rollmean</a></span>(<span class="no">sratedewp</span>, <span class="kw">k</span> <span class="kw">=</span> <span class="fl">10</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="fl">NA</span>),
         <span class="kw">srate_ma25dewp</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/zoo/man/rollmean.html">rollmean</a></span>(<span class="no">sratedewp</span>, <span class="kw">k</span> <span class="kw">=</span> <span class="fl">25</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="fl">NA</span>),
         <span class="kw">srate_ma70dewp</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/zoo/man/rollmean.html">rollmean</a></span>(<span class="no">sratedewp</span>, <span class="kw">k</span> <span class="kw">=</span> <span class="fl">70</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="fl">NA</span>),
         <span class="kw">srate_ma100dewp</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/zoo/man/rollmean.html">rollmean</a></span>(<span class="no">sratedewp</span>, <span class="kw">k</span> <span class="kw">=</span> <span class="fl">100</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="fl">NA</span>))


<span class="co">#plot count and humidity</span>

<span class="no">dewpma</span> <span class="kw">&lt;-</span> <span class="no">df2movingaveDEWP</span> <span class="kw">%&gt;%</span>
  <span class="fu">gather</span>(<span class="no">metric</span>, <span class="no">value</span>, <span class="no">srate_ma70dewp</span>) <span class="kw">%&gt;%</span>
  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="no">reg_date</span>, <span class="no">value</span>, <span class="kw">color</span> <span class="kw">=</span> <span class="no">metric</span>)) +
  <span class="fu">geom_line</span>()+
  <span class="fu">labs</span>(<span class="kw">title</span> <span class="kw">=</span> <span class="st">"Humidity"</span>,
       <span class="kw">subtitle</span> <span class="kw">=</span> <span class="st">"Blantyre, Malawi: 10 week moving average"</span>,
       <span class="kw">y</span><span class="kw">=</span><span class="st">"Dew point (Celsius)"</span>,
       <span class="kw">x</span><span class="kw">=</span><span class="st">"Epidemiological week"</span>) +
  <span class="fu">theme</span>(<span class="kw">panel.border</span> <span class="kw">=</span> <span class="fu">element_rect</span>(<span class="kw">colour</span> <span class="kw">=</span> <span class="st">"black"</span>, <span class="kw">fill</span><span class="kw">=</span><span class="fl">NA</span>, <span class="kw">size</span><span class="kw">=</span><span class="fl">0.5</span>), <span class="kw">legend.position</span> <span class="kw">=</span> <span class="st">"none"</span>) +
  <span class="fu">scale_color_manual</span>(<span class="kw">values</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"#e63946"</span>))  +
  <span class="fu">scale_x_date</span>(<span class="kw">date_breaks</span> <span class="kw">=</span> <span class="st">"20 weeks"</span>,
               <span class="kw">date_labels</span> <span class="kw">=</span> <span class="st">"%Y-w%W"</span>) +
  <span class="fu">theme</span>(<span class="kw">axis.text.x</span> <span class="kw">=</span> <span class="fu">element_text</span>(<span class="kw">angle</span> <span class="kw">=</span> <span class="fl">45</span>, <span class="kw">hjust</span> <span class="kw">=</span> <span class="fl">1</span>))+
  <span class="fu">theme</span>(<span class="kw">plot.title</span> <span class="kw">=</span> <span class="fu">element_text</span>(<span class="kw">size</span><span class="kw">=</span><span class="fl">12</span>))

<span class="no">dewpma</span></pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-14-2.png" width="700"></p>
<p><br></p>
</div>
<div id="figure-3-combine-weather-plots" class="section level2">
<h2 class="hasAnchor">
<a href="#figure-3-combine-weather-plots" class="anchor"></a>10. Figure 3: Combine weather plots</h2>
<div class="sourceCode" id="cb20"><html><body><pre class="r">
<span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/ggarrange.html">ggarrange</a></span>(<span class="no">dewpma</span>,  <span class="no">wdspma</span>, <span class="no">tempma</span>, <span class="no">prcpma</span>,
          <span class="kw">labels</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"A"</span>, <span class="st">"B"</span>, <span class="st">"C"</span>, <span class="st">"D"</span>),
          <span class="kw">ncol</span> <span class="kw">=</span> <span class="fl">2</span>, <span class="kw">nrow</span> <span class="kw">=</span> <span class="fl">2</span>)</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-15-1.png" width="700"></p>
<div class="sourceCode" id="cb21"><html><body><pre class="r">
<span class="fu">ggsave</span>(<span class="fu"><a href="https://rdrr.io/pkg/here/man/here.html">here</a></span>(<span class="st">"figures/figure2.png"</span>), <span class="kw">dpi</span><span class="kw">=</span><span class="fl">600</span>, <span class="kw">width</span><span class="kw">=</span><span class="fl">14</span>, <span class="kw">height</span><span class="kw">=</span><span class="fl">8</span>)</pre></body></html></div>
<p><br></p>
<p>Try an alternative plot, with TB CNRs and weather in one plot</p>
<div class="sourceCode" id="cb22"><html><body><pre class="r">
<span class="no">patchwork</span> <span class="kw">&lt;-</span> (<span class="no">CNR10wma</span> + <span class="no">graphbysex</span>) /
(<span class="no">graphbyHIV</span> + <span class="no">graphbyage</span>) /
(<span class="no">tempma</span> + <span class="no">prcpma</span>)

<span class="no">patchwork</span> + <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_annotation.html">plot_annotation</a></span>(<span class="kw">tag_levels</span> <span class="kw">=</span> <span class="st">'A'</span>)</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-16-1.png" width="700"></p>
<div class="sourceCode" id="cb23"><html><body><pre class="r">
<span class="fu">ggsave</span>(<span class="fu"><a href="https://rdrr.io/pkg/here/man/here.html">here</a></span>(<span class="st">"figures/figure2_alternative.png"</span>), <span class="kw">dpi</span><span class="kw">=</span><span class="fl">600</span>, <span class="kw">width</span><span class="kw">=</span><span class="fl">9</span>, <span class="kw">height</span><span class="kw">=</span><span class="fl">10</span>)</pre></body></html></div>
<p><br></p>
</div>
<div id="regression-analysis" class="section level2">
<h2 class="hasAnchor">
<a href="#regression-analysis" class="anchor"></a>11. Regression analysis</h2>
<p>First load the cleaned data</p>
<div class="sourceCode" id="cb24"><html><body><pre class="r">
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="fl">1988</span>)
<span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span>(<span class="fu"><a href="https://rdrr.io/pkg/here/man/here.html">here</a></span>(<span class="st">"data/tb.dlnm.RData"</span>))
<span class="no">d_q</span>$<span class="no">wk</span> <span class="kw">&lt;-</span> <span class="fu"><a href="http://lubridate.tidyverse.org/reference/week.html">epiweek</a></span>(<span class="fu"><a href="http://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span>(<span class="no">d_q</span>$<span class="no">y_w</span>))
<span class="no">d_q</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span>(<span class="no">d_q</span>,<span class="kw">select</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">y_w</span>,<span class="no">wk</span>,<span class="no">year</span>,<span class="no">n</span>,<span class="no">prcp</span>,<span class="no">temp</span>))</pre></body></html></div>
<p><br></p>
<p>quasiPoisson variant from poisson likelikehood for QAIC estimation</p>
<div class="sourceCode" id="cb25"><html><body><pre class="r"><span class="no">tb.quasipois</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">...</span>){
  <span class="no">res</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html">quasipoisson</a></span>(<span class="no">...</span>)
  <span class="no">res</span>$<span class="no">aic</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html">poisson</a></span>(<span class="no">...</span>)$<span class="no">aic</span>
  <span class="no">res</span>
}

<span class="co">#temp table to hold QAIC values</span>
<span class="no">QAICtable</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="kw">model.no</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">NA</span>,<span class="fl">1</span>),<span class="kw">lag.df</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">NA</span>,<span class="fl">1</span>),<span class="kw">r.df</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">NA</span>,<span class="fl">1</span>),<span class="kw">t.df</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">NA</span>,<span class="fl">1</span>), <span class="kw">QAIC.r</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">NA</span>,<span class="fl">1</span>),<span class="kw">QAIC.t</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">NA</span>,<span class="fl">1</span>),<span class="kw">QAIC.rt</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">NA</span>,<span class="fl">1</span>))</pre></body></html></div>
<p><br></p>
<p>loop through each model (with unique degrees of freedom for lag &amp; each weather covariate)</p>
<div class="sourceCode" id="cb26"><html><body><pre class="r"><span class="no">n</span><span class="kw">=</span><span class="fl">1</span>
    <span class="kw">for</span>(<span class="no">k</span> <span class="kw">in</span> <span class="fl">3</span>:<span class="fl">5</span>){
      <span class="kw">for</span>(<span class="no">j</span> <span class="kw">in</span> <span class="fl">3</span>:<span class="fl">5</span>){
        <span class="kw">for</span>(<span class="no">i</span> <span class="kw">in</span> <span class="fl">3</span>:<span class="fl">5</span>){

      <span class="co">#set degrees of freedom (DoF) for natural spline via knots</span>
      <span class="no">lagk</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/dlnm/man/logknots.html">logknots</a></span>(<span class="fl">5</span>, <span class="kw">fun</span><span class="kw">=</span><span class="st">"ns"</span>, <span class="kw">df</span><span class="kw">=</span><span class="no">i</span>)
      <span class="no">vark.r</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/pkg/dlnm/man/equalknots.html">equalknots</a></span>(<span class="no">d_q</span>$<span class="no">prcp</span>, <span class="kw">fun</span><span class="kw">=</span><span class="st">"ns"</span>, <span class="kw">df</span><span class="kw">=</span><span class="no">j</span>)
      <span class="no">vark.t</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/pkg/dlnm/man/equalknots.html">equalknots</a></span>(<span class="no">d_q</span>$<span class="no">temp</span>, <span class="kw">fun</span><span class="kw">=</span><span class="st">"ns"</span>, <span class="kw">df</span><span class="kw">=</span><span class="no">k</span>)

      <span class="co">#construst cross basis (cb) functions and set plaausible DoF for natural spline via knots</span>
      <span class="no">cb.rain</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/dlnm/man/crossbasis.html">crossbasis</a></span>(<span class="no">d_q</span>$<span class="no">prcp</span>, <span class="kw">lag</span><span class="kw">=</span><span class="fl">20</span>, <span class="kw">argvar</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">fun</span><span class="kw">=</span><span class="st">"ns"</span>, <span class="kw">knots</span><span class="kw">=</span><span class="no">vark.r</span>), <span class="kw">arglag</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">knots</span><span class="kw">=</span><span class="no">lagk</span>))
      <span class="no">cb.temp</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/dlnm/man/crossbasis.html">crossbasis</a></span>(<span class="no">d_q</span>$<span class="no">temp</span>, <span class="kw">lag</span><span class="kw">=</span><span class="fl">20</span>, <span class="kw">argvar</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">fun</span><span class="kw">=</span><span class="st">"ns"</span>, <span class="kw">knots</span><span class="kw">=</span><span class="no">vark.t</span>), <span class="kw">arglag</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">knots</span><span class="kw">=</span><span class="no">lagk</span>))

      <span class="co">#construct plausible generalised linear models to fit to the data</span>
      <span class="no">model.r</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span>(<span class="no">d_q</span>$<span class="no">n</span> ~ <span class="no">cb.rain</span> + <span class="no">wk</span> + <span class="no">year</span>, <span class="kw">family</span><span class="kw">=</span><span class="fu">tb.quasipois</span>(), <span class="no">d_q</span>)
      <span class="no">model.t</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span>(<span class="no">d_q</span>$<span class="no">n</span> ~ <span class="no">cb.temp</span> + <span class="no">wk</span> + <span class="no">year</span>, <span class="kw">family</span><span class="kw">=</span><span class="fu">tb.quasipois</span>(), <span class="no">d_q</span>)
      <span class="no">model.rt</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span>(<span class="no">d_q</span>$<span class="no">n</span> ~ <span class="no">cb.rain</span> + <span class="no">wk</span> + <span class="no">cb.temp</span> + <span class="no">year</span>, <span class="kw">family</span><span class="kw">=</span><span class="fu">tb.quasipois</span>(), <span class="no">d_q</span>)

      <span class="co">#output the QAIC values to internal table</span>
      <span class="no">QAICtable</span>[<span class="no">n</span>,] <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">n</span>,<span class="no">i</span>,<span class="no">j</span>,<span class="no">k</span>,
                         <span class="fu"><a href="https://rdrr.io/pkg/MuMIn/man/QAIC.html">QAIC</a></span>(<span class="no">model.r</span>, <span class="kw">chat</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(<span class="no">model.r</span>)$<span class="no">dispersion</span>),
                         <span class="fu"><a href="https://rdrr.io/pkg/MuMIn/man/QAIC.html">QAIC</a></span>(<span class="no">model.t</span>, <span class="kw">chat</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(<span class="no">model.t</span>)$<span class="no">dispersion</span>),
                         <span class="fu"><a href="https://rdrr.io/pkg/MuMIn/man/QAIC.html">QAIC</a></span>(<span class="no">model.rt</span>, <span class="kw">chat</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(<span class="no">model.rt</span>)$<span class="no">dispersion</span>))
      <span class="no">n</span><span class="kw">=</span><span class="no">n</span>+<span class="fl">1</span>
        }
      }
    }</pre></body></html></div>
<p><br></p>
<p>Predict the effects of weather on TB notifications models for rain-lag and temp-lag seperately are most optimal for generating minimum QAIC score</p>
<p>reconstruct cross-basis functions for rainfall and temperature given the optimal DoF</p>
<div class="sourceCode" id="cb27"><html><body><pre class="r"><span class="no">lagk</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/pkg/dlnm/man/logknots.html">logknots</a></span>(<span class="fl">20</span>, <span class="kw">fun</span><span class="kw">=</span><span class="st">"ns"</span>, <span class="kw">df</span><span class="kw">=</span><span class="fl">3</span>)
<span class="no">vark</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/pkg/dlnm/man/equalknots.html">equalknots</a></span>(<span class="no">d_q</span>$<span class="no">prcp</span>, <span class="kw">fun</span><span class="kw">=</span><span class="st">"ns"</span>, <span class="kw">df</span><span class="kw">=</span><span class="fl">3</span>)
<span class="no">cb.rain</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/dlnm/man/crossbasis.html">crossbasis</a></span>(<span class="no">d_q</span>$<span class="no">prcp</span>, <span class="kw">lag</span><span class="kw">=</span><span class="fl">20</span>, <span class="kw">argvar</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">knots</span><span class="kw">=</span><span class="no">vark</span>), <span class="kw">arglag</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">knots</span><span class="kw">=</span><span class="no">lagk</span>))

<span class="no">lagk</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/pkg/dlnm/man/logknots.html">logknots</a></span>(<span class="fl">20</span>, <span class="kw">fun</span><span class="kw">=</span><span class="st">"ns"</span>, <span class="kw">df</span><span class="kw">=</span><span class="fl">3</span>)
<span class="no">vark</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/pkg/dlnm/man/equalknots.html">equalknots</a></span>(<span class="no">d_q</span>$<span class="no">temp</span>, <span class="kw">fun</span><span class="kw">=</span><span class="st">"ns"</span>, <span class="kw">df</span><span class="kw">=</span><span class="fl">3</span>)
<span class="no">cb.temp</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/dlnm/man/crossbasis.html">crossbasis</a></span>(<span class="no">d_q</span>$<span class="no">temp</span>, <span class="kw">lag</span><span class="kw">=</span><span class="fl">20</span>, <span class="kw">argvar</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">knots</span><span class="kw">=</span><span class="no">vark</span>), <span class="kw">arglag</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">knots</span><span class="kw">=</span><span class="no">lagk</span>))

<span class="co">#fit two models for rainfall and temperature seperately in generalised linear framework</span>
<span class="no">model.r</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span>(<span class="no">n</span> ~ <span class="no">cb.rain</span> + <span class="no">wk</span> + <span class="no">year</span>, <span class="kw">family</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/stats/family.html">quasipoisson</a></span>(), <span class="kw">na.action</span><span class="kw">=</span><span class="no">na.exclude</span>, <span class="no">d_q</span>)
<span class="no">model.t</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span>(<span class="no">n</span> ~ <span class="no">cb.temp</span> + <span class="no">wk</span> + <span class="no">year</span>, <span class="kw">family</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/stats/family.html">quasipoisson</a></span>(), <span class="kw">na.action</span><span class="kw">=</span><span class="no">na.exclude</span>, <span class="no">d_q</span>)

<span class="co">#validate rainfall model by minimising high partial/auto-correlation (outside blue dotted lines)</span>
<span class="fu"><a href="https://rdrr.io/r/stats/acf.html">pacf</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span>(<span class="no">model.r</span>,<span class="kw">type</span><span class="kw">=</span><span class="st">"deviance"</span>),<span class="kw">na.action</span><span class="kw">=</span><span class="no">na.omit</span>,<span class="kw">main</span><span class="kw">=</span><span class="st">"Partial autocorrelation"</span>,<span class="kw">xlim</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>,<span class="fl">20</span>))</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-20-1.png" width="700"></p>
<div class="sourceCode" id="cb28"><html><body><pre class="r"><span class="no">model.r</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span>(<span class="no">model.r</span>,<span class="no">.</span>~<span class="no">.</span>+<span class="fu"><a href="https://rdrr.io/r/stats/lag.html">lag</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span>(<span class="no">model.r</span>,<span class="kw">type</span><span class="kw">=</span><span class="st">"deviance"</span>),<span class="fl">1</span>))
<span class="no">model.r</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span>(<span class="no">model.r</span>,<span class="no">.</span>~<span class="no">.</span>+<span class="fu"><a href="https://rdrr.io/r/stats/lag.html">lag</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span>(<span class="no">model.r</span>,<span class="kw">type</span><span class="kw">=</span><span class="st">"deviance"</span>),<span class="fl">2</span>))

<span class="co">#validate temperature model by minimising high partial/auto-correlation (outside blue dotted lines)</span>
<span class="fu"><a href="https://rdrr.io/r/stats/acf.html">pacf</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span>(<span class="no">model.t</span>,<span class="kw">type</span><span class="kw">=</span><span class="st">"deviance"</span>),<span class="kw">na.action</span><span class="kw">=</span><span class="no">na.omit</span>,<span class="kw">main</span><span class="kw">=</span><span class="st">"Partial autocorrelation"</span>,<span class="kw">xlim</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>,<span class="fl">20</span>))</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-20-2.png" width="700"></p>
<div class="sourceCode" id="cb29"><html><body><pre class="r"><span class="no">model.t</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span>(<span class="no">model.t</span>,<span class="no">.</span>~<span class="no">.</span>+<span class="fu"><a href="https://rdrr.io/r/stats/lag.html">lag</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span>(<span class="no">model.t</span>,<span class="kw">type</span><span class="kw">=</span><span class="st">"deviance"</span>),<span class="fl">2</span>))
<span class="no">model.t</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span>(<span class="no">model.t</span>,<span class="no">.</span>~<span class="no">.</span>+<span class="fu"><a href="https://rdrr.io/r/stats/lag.html">lag</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span>(<span class="no">model.t</span>,<span class="kw">type</span><span class="kw">=</span><span class="st">"deviance"</span>),<span class="fl">13</span>))
<span class="no">model.t</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span>(<span class="no">model.t</span>,<span class="no">.</span>~<span class="no">.</span>+<span class="fu"><a href="https://rdrr.io/r/stats/lag.html">lag</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span>(<span class="no">model.t</span>,<span class="kw">type</span><span class="kw">=</span><span class="st">"deviance"</span>),<span class="fl">17</span>))

<span class="co">#predict (nowcast) the effect on TB notification of rainfall/temperature</span>
<span class="no">pred.rain</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/dlnm/man/crosspred.html">crosspred</a></span>(<span class="no">cb.rain</span>, <span class="no">model.r</span>, <span class="kw">cen</span><span class="kw">=</span><span class="fl">0</span>, <span class="kw">by</span><span class="kw">=</span><span class="fl">0.2</span>)
<span class="no">pred.temp</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/dlnm/man/crosspred.html">crosspred</a></span>(<span class="no">cb.temp</span>, <span class="no">model.t</span>, <span class="kw">cen</span><span class="kw">=</span><span class="fl">17</span>, <span class="kw">by</span><span class="kw">=</span><span class="fl">0.2</span>)

<span class="co">#plot 3D, countour and curves for rainfall on TB notifications</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span>(<span class="kw">mgp</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">2.3</span>,<span class="fl">1</span>,<span class="fl">0</span>),<span class="kw">mai</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.9</span>,<span class="fl">0.9</span>,<span class="fl">0.3</span>,<span class="fl">0.2</span>))
<span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">pred.rain</span>, <span class="st">"contour"</span>, <span class="kw">key.title</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html">title</a></span>(<span class="st">"TBN"</span>), <span class="kw">plot.title</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html">title</a></span>(<span class="st">"A"</span>, <span class="kw">xlab</span> <span class="kw">=</span><span class="st">"Weekly mean rainfall (mm)"</span>, <span class="kw">ylab</span> <span class="kw">=</span> <span class="st">"Weekly lag"</span>, <span class="kw">cex.lab</span><span class="kw">=</span><span class="fl">1</span>, <span class="kw">cex.axis</span><span class="kw">=</span><span class="fl">1</span>))</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-20-3.png" width="700"></p>
<div class="sourceCode" id="cb30"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">pred.rain</span>, <span class="st">"slices"</span>, <span class="kw">type</span><span class="kw">=</span><span class="st">"p"</span>, <span class="kw">pch</span><span class="kw">=</span><span class="fl">19</span>, <span class="kw">cex</span><span class="kw">=</span><span class="fl">1.3</span>, <span class="kw">var</span><span class="kw">=</span><span class="fl">18</span>, <span class="kw">col</span><span class="kw">=</span><span class="st">"purple"</span>, <span class="kw">ci.level</span><span class="kw">=</span><span class="fl">0.5</span>, <span class="kw">ci</span><span class="kw">=</span><span class="st">"bars"</span>, <span class="kw">ylab</span><span class="kw">=</span><span class="st">"Report ratio"</span>, <span class="kw">xlab</span><span class="kw">=</span><span class="st">"Weekly lag"</span>, <span class="kw">main</span><span class="kw">=</span><span class="st">"B"</span>)</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-20-4.png" width="700"></p>
<div class="sourceCode" id="cb31"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">pred.rain</span>, <span class="st">"slices"</span>, <span class="kw">type</span><span class="kw">=</span><span class="st">"p"</span>, <span class="kw">pch</span><span class="kw">=</span><span class="fl">19</span>, <span class="kw">cex</span><span class="kw">=</span><span class="fl">1.3</span>, <span class="kw">var</span><span class="kw">=</span><span class="fl">30</span>, <span class="kw">col</span><span class="kw">=</span><span class="st">"purple"</span>, <span class="kw">ci.level</span><span class="kw">=</span><span class="fl">0.5</span>, <span class="kw">ci</span><span class="kw">=</span><span class="st">"bars"</span>, <span class="kw">ylab</span><span class="kw">=</span><span class="st">"Report ratio"</span>, <span class="kw">xlab</span><span class="kw">=</span><span class="st">"Weekly lag"</span>, <span class="kw">main</span><span class="kw">=</span><span class="st">"C"</span>)</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-20-5.png" width="700"></p>
<div class="sourceCode" id="cb32"><html><body><pre class="r">
<span class="co">#plot 3D, countour and curves for temperature on TB notifications</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span>(<span class="kw">mgp</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">2.3</span>,<span class="fl">1</span>,<span class="fl">0</span>),<span class="kw">mai</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.9</span>,<span class="fl">0.9</span>,<span class="fl">0.3</span>,<span class="fl">0.2</span>))
<span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">pred.temp</span>, <span class="st">"contour"</span>, <span class="kw">key.title</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html">title</a></span>(<span class="st">"TBN"</span>), <span class="kw">plot.title</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html">title</a></span>(<span class="st">"D"</span>, <span class="kw">xlab</span> <span class="kw">=</span><span class="st">"Weekly mean temperature (°C)"</span>, <span class="kw">ylab</span> <span class="kw">=</span> <span class="st">"Weekly lag"</span>, <span class="kw">cex.lab</span><span class="kw">=</span><span class="fl">1</span>, <span class="kw">cex.axis</span><span class="kw">=</span><span class="fl">1</span>))</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-20-6.png" width="700"></p>
<div class="sourceCode" id="cb33"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">pred.temp</span>, <span class="st">"slices"</span>, <span class="kw">type</span><span class="kw">=</span><span class="st">"p"</span>, <span class="kw">pch</span><span class="kw">=</span><span class="fl">19</span>, <span class="kw">cex</span><span class="kw">=</span><span class="fl">1.3</span>, <span class="kw">var</span><span class="kw">=</span><span class="fl">20</span>, <span class="kw">col</span><span class="kw">=</span><span class="st">"red2"</span>, <span class="kw">ci.level</span><span class="kw">=</span><span class="fl">0.5</span>, <span class="kw">ci</span><span class="kw">=</span><span class="st">"bars"</span>, <span class="kw">ylab</span><span class="kw">=</span><span class="st">"Report ratio"</span>, <span class="kw">xlab</span><span class="kw">=</span><span class="st">"Weekly lag"</span>, <span class="kw">main</span><span class="kw">=</span><span class="st">"E"</span>)</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-20-7.png" width="700"></p>
<div class="sourceCode" id="cb34"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">pred.temp</span>, <span class="st">"slices"</span>, <span class="kw">type</span><span class="kw">=</span><span class="st">"p"</span>, <span class="kw">pch</span><span class="kw">=</span><span class="fl">19</span>, <span class="kw">cex</span><span class="kw">=</span><span class="fl">1.3</span>, <span class="kw">var</span><span class="kw">=</span><span class="fl">30</span>, <span class="kw">col</span><span class="kw">=</span><span class="st">"red2"</span>, <span class="kw">ci.level</span><span class="kw">=</span><span class="fl">0.5</span>, <span class="kw">ci</span><span class="kw">=</span><span class="st">"bars"</span>, <span class="kw">ylab</span><span class="kw">=</span><span class="st">"Report ratio"</span>, <span class="kw">xlab</span><span class="kw">=</span><span class="st">"Weekly lag"</span>, <span class="kw">main</span><span class="kw">=</span><span class="st">"F"</span>)</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-20-8.png" width="700"></p>
<p><br></p>
<p>Model diagnostics and goodness of fit</p>
<div class="sourceCode" id="cb35"><html><body><pre class="r">
#compute mean absolute percentage error (MAPE) between observed and predicted values
sort(d_q$y_w, decreasing=FALSE)
  [1] "2011-07-04" "2011-07-11" "2011-07-18" "2011-08-01" "2011-08-08"
  [6] "2011-08-15" "2011-08-22" "2011-08-29" "2011-09-05" "2011-09-19"
 [11] "2011-09-26" "2011-10-03" "2011-10-10" "2011-10-17" "2011-10-24"
 [16] "2011-10-31" "2011-11-07" "2011-11-14" "2011-11-21" "2011-11-28"
 [21] "2011-12-05" "2011-12-12" "2011-12-19" "2011-12-26" "2012-01-02"
 [26] "2012-01-09" "2012-01-16" "2012-01-23" "2012-01-30" "2012-02-06"
 [31] "2012-02-13" "2012-02-20" "2012-02-27" "2012-03-05" "2012-03-12"
 [36] "2012-03-19" "2012-03-26" "2012-04-02" "2012-04-09" "2012-04-16"
 [41] "2012-04-23" "2012-04-30" "2012-05-07" "2012-05-14" "2012-05-21"
 [46] "2012-05-28" "2012-06-04" "2012-06-11" "2012-06-18" "2012-06-25"
 [51] "2012-07-02" "2012-07-09" "2012-07-16" "2012-07-23" "2012-07-30"
 [56] "2012-08-06" "2012-08-13" "2012-08-20" "2012-08-27" "2012-09-03"
 [61] "2012-09-10" "2012-09-17" "2012-09-24" "2012-10-01" "2012-10-08"
 [66] "2012-10-15" "2012-10-22" "2012-10-29" "2012-11-05" "2012-11-12"
 [71] "2012-11-19" "2012-11-26" "2012-12-03" "2012-12-10" "2012-12-17"
 [76] "2012-12-24" "2012-12-31" "2013-01-07" "2013-01-14" "2013-01-21"
 [81] "2013-01-28" "2013-02-04" "2013-02-11" "2013-02-18" "2013-02-25"
 [86] "2013-03-04" "2013-03-11" "2013-03-18" "2013-03-25" "2013-04-01"
 [91] "2013-04-08" "2013-04-15" "2013-04-22" "2013-05-06" "2013-05-13"
 [96] "2013-05-20" "2013-05-27" "2013-06-03" "2013-06-10" "2013-06-17"
[101] "2013-06-24" "2013-07-01" "2013-07-08" "2013-07-15" "2013-07-22"
[106] "2013-07-29" "2013-08-05" "2013-08-12" "2013-08-19" "2013-08-26"
[111] "2013-09-02" "2013-09-09" "2013-09-16" "2013-09-23" "2013-09-30"
[116] "2013-10-07" "2013-10-14" "2013-10-21" "2013-10-28" "2013-11-04"
[121] "2013-11-11" "2013-11-18" "2013-11-25" "2013-12-02" "2013-12-09"
[126] "2013-12-16" "2013-12-23" "2013-12-30" "2014-01-06" "2014-01-13"
[131] "2014-01-20" "2014-01-27" "2014-02-03" "2014-02-10" "2014-02-17"
[136] "2014-03-03" "2014-03-10" "2014-03-17" "2014-03-24" "2014-03-31"
[141] "2014-04-07" "2014-04-14" "2014-04-21" "2014-04-28" "2014-05-05"
[146] "2014-05-12" "2014-05-26" "2014-06-02" "2014-06-09" "2014-06-16"
[151] "2014-06-23" "2014-06-30" "2014-07-07" "2014-07-14" "2014-07-21"
[156] "2014-07-28" "2014-08-04" "2014-08-11" "2014-08-18" "2014-08-25"
[161] "2014-09-01" "2014-09-08" "2014-09-15" "2014-09-22" "2014-09-29"
[166] "2014-10-06" "2014-10-13" "2014-10-20" "2014-10-27" "2014-11-10"
[171] "2014-11-17" "2014-11-24" "2014-12-01" "2014-12-22" "2014-12-29"
[176] "2015-01-05" "2015-01-12" "2015-01-19" "2015-01-26" "2015-02-02"
[181] "2015-02-09" "2015-02-16" "2015-02-23" "2015-03-02" "2015-03-09"
[186] "2015-03-16" "2015-03-23" "2015-03-30" "2015-04-06" "2015-04-27"
[191] "2015-05-04" "2015-05-11" "2015-05-18" "2015-05-25" "2015-06-01"
[196] "2015-06-08" "2015-06-15" "2015-06-22" "2015-06-29" "2015-07-06"
[201] "2015-07-13" "2015-07-20" "2015-07-27" "2015-08-03" "2015-08-10"
[206] "2015-08-17" "2015-08-24" "2015-08-31" "2015-09-07" "2015-09-14"
[211] "2015-09-21" "2015-09-28" "2015-10-05" "2015-10-12" "2015-10-19"
[216] "2015-10-26" "2015-11-02" "2015-11-09" "2015-11-16" "2015-11-23"
[221] "2015-11-30" "2015-12-07" "2016-01-04" "2016-01-18" "2016-01-25"
[226] "2016-02-01" "2016-02-08" "2016-02-15" "2016-02-22" "2016-02-29"
[231] "2016-03-07" "2016-03-14" "2016-03-21" "2016-03-28" "2016-04-04"
[236] "2016-04-11" "2016-04-18" "2016-04-25" "2016-05-02" "2016-05-09"
[241] "2016-05-16" "2016-05-23" "2016-05-30" "2016-06-06" "2016-06-13"
[246] "2016-06-20" "2016-06-27" "2016-07-04" "2016-07-25" "2016-08-01"
[251] "2016-08-08" "2016-08-15" "2016-08-22" "2016-08-29" "2016-09-05"
[256] "2016-09-12" "2016-09-19" "2016-09-26" "2016-10-03" "2016-10-10"
[261] "2016-10-17" "2016-10-31" "2016-11-07" "2016-11-14" "2016-11-21"
[266] "2016-11-28" "2016-12-05" "2016-12-12" "2016-12-19" "2016-12-26"
[271] "2017-01-02" "2017-01-09" "2017-01-16" "2017-01-23" "2017-01-30"
[276] "2017-02-06" "2017-02-13" "2017-02-20" "2017-02-27" "2017-03-06"
[281] "2017-03-13" "2017-03-20" "2017-03-27" "2017-04-10" "2017-04-17"
[286] "2017-04-24" "2017-05-01" "2017-05-08" "2017-05-15" "2017-05-22"
[291] "2017-05-29" "2017-06-05" "2017-06-12" "2017-06-19" "2017-06-26"
[296] "2017-07-03" "2017-07-10" "2017-07-17" "2017-07-24" "2017-07-31"
[301] "2017-08-07" "2017-08-14" "2017-08-21" "2017-08-28" "2017-09-04"
[306] "2017-09-11" "2017-09-18" "2017-09-25" "2017-10-02" "2017-10-09"
[311] "2017-10-16" "2017-10-23" "2017-10-30" "2017-11-06" "2017-11-13"
[316] "2017-11-20" "2017-11-27" "2017-12-04" "2017-12-11" "2017-12-18"
[321] "2017-12-25" "2018-01-01" "2018-01-08" "2018-01-15" "2018-01-22"
[326] "2018-01-29" "2018-02-05" "2018-02-12" "2018-02-19" "2018-02-26"
[331] "2018-03-05" "2018-03-12" "2018-03-19" "2018-03-26" "2018-04-02"
[336] "2018-04-09" "2018-04-16" "2018-04-23" "2018-04-30" "2018-05-07"
[341] "2018-05-14" "2018-05-21" "2018-05-28" "2018-06-04" "2018-06-11"
[346] "2018-06-18" "2018-06-25" "2018-07-02" "2018-07-09" "2018-07-16"
[351] "2018-07-23" "2018-07-30" "2018-08-06" "2018-08-13" "2018-08-20"
[356] "2018-08-27" "2018-09-03" "2018-09-10" "2018-09-17" "2018-09-24"
[361] "2018-10-01" "2018-10-08" "2018-10-15" "2018-10-22" "2018-10-29"
[366] "2018-11-05" "2018-11-12" "2018-11-19" "2018-11-26" "2018-12-03"
[371] "2018-12-10" "2018-12-17" "2018-12-24"
errors.r &lt;- subset(subset(d_q,select=c(y_w,n)), date(y_w)&gt;='2011-12-26')
errors.r$pred.r &lt;- model.r$fitted.values
mape(errors.r$n,errors.r$pred.r)*100
[1] 17.82107
errors.r &lt;- subset(subset(d_q,select=c(y_w,n)), date(y_w)&gt;='2012-07-16')
errors.r$pred.t &lt;- model.t$fitted.values
mape(errors.r$n,errors.r$pred.t)*100
[1] 17.25454

#plot TB notification diagnostics for all covariates
par(mfrow=c(2,4),mai=c(0.6,0.6,0.1,0.2))</pre></body></html></div>
<p><br></p>
<p>Extract the data for combined plot</p>
<div class="sourceCode" id="cb36"><html><body><pre class="r"><span class="co">#rainfall</span>
<span class="no">a_rain</span> <span class="kw">&lt;-</span> <span class="no">pred.rain</span>$<span class="no">matRRfit</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu">rownames_to_column</span>(<span class="kw">var</span><span class="kw">=</span><span class="st">"var"</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">var</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">var</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">var</span><span class="kw">==</span><span class="fl">18</span> <span class="kw">|</span> <span class="no">var</span><span class="kw">==</span><span class="fl">30</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">comparison</span> <span class="kw">=</span> <span class="fu">case_when</span>(<span class="no">var</span><span class="kw">==</span><span class="fl">18</span> ~ <span class="st">"Mid (18mm) vs. low (0mm)"</span>,
                                <span class="no">var</span><span class="kw">==</span><span class="fl">30</span> ~ <span class="st">"High (30mm) vs. low (0mm)"</span>),
         <span class="kw">variable</span><span class="kw">=</span><span class="st">"Overall"</span>,
         <span class="kw">model</span> <span class="kw">=</span> <span class="st">"Rainfall"</span>) <span class="kw">%&gt;%</span>
  <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> <span class="no">lag0</span>:<span class="no">lag20</span>)

<span class="no">a_rain_ci_lo</span> <span class="kw">&lt;-</span> <span class="no">pred.rain</span>$<span class="no">matRRlow</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu">rownames_to_column</span>(<span class="kw">var</span><span class="kw">=</span><span class="st">"var"</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">var</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">var</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">var</span><span class="kw">==</span><span class="fl">18</span> <span class="kw">|</span> <span class="no">var</span><span class="kw">==</span><span class="fl">30</span>) <span class="kw">%&gt;%</span>
  <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> <span class="no">lag0</span>:<span class="no">lag20</span>) <span class="kw">%&gt;%</span>
  <span class="fu">rename</span>(<span class="kw">ci_lo</span><span class="kw">=</span><span class="no">value</span>)

<span class="no">a_rain_ci_hi</span> <span class="kw">&lt;-</span> <span class="no">pred.rain</span>$<span class="no">matRRhigh</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu">rownames_to_column</span>(<span class="kw">var</span><span class="kw">=</span><span class="st">"var"</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">var</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">var</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">var</span><span class="kw">==</span><span class="fl">18</span> <span class="kw">|</span> <span class="no">var</span><span class="kw">==</span><span class="fl">30</span>) <span class="kw">%&gt;%</span>
  <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> <span class="no">lag0</span>:<span class="no">lag20</span>) <span class="kw">%&gt;%</span>
  <span class="fu">rename</span>(<span class="kw">ci_hi</span><span class="kw">=</span><span class="no">value</span>)

<span class="no">a1</span> <span class="kw">&lt;-</span> <span class="fu">left_join</span>(<span class="no">a_rain</span>, <span class="no">a_rain_ci_lo</span>)
<span class="no">a1</span> <span class="kw">&lt;-</span> <span class="fu">left_join</span>(<span class="no">a1</span>, <span class="no">a_rain_ci_hi</span>)

<span class="co">#temp</span>
<span class="no">a_temp</span> <span class="kw">&lt;-</span> <span class="no">pred.temp</span>$<span class="no">matRRfit</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu">rownames_to_column</span>(<span class="kw">var</span><span class="kw">=</span><span class="st">"var"</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">var</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">var</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">var</span><span class="kw">==</span><span class="fl">20</span> <span class="kw">|</span> <span class="no">var</span><span class="kw">==</span><span class="fl">30</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">comparison</span> <span class="kw">=</span> <span class="fu">case_when</span>(<span class="no">var</span><span class="kw">==</span><span class="fl">20</span> ~ <span class="st">"Mid (20°C) vs. low (17°C)"</span>,
                                <span class="no">var</span><span class="kw">==</span><span class="fl">30</span> ~ <span class="st">"High (30°C) vs. low (17°C)"</span>),
         <span class="kw">variable</span><span class="kw">=</span><span class="st">"Overall"</span>,
         <span class="kw">model</span> <span class="kw">=</span> <span class="st">"Temperature"</span>) <span class="kw">%&gt;%</span>
  <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> <span class="no">lag0</span>:<span class="no">lag20</span>)

<span class="no">a_temp_ci_lo</span> <span class="kw">&lt;-</span> <span class="no">pred.temp</span>$<span class="no">matRRlow</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu">rownames_to_column</span>(<span class="kw">var</span><span class="kw">=</span><span class="st">"var"</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">var</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">var</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">var</span><span class="kw">==</span><span class="fl">20</span> <span class="kw">|</span> <span class="no">var</span><span class="kw">==</span><span class="fl">30</span>) <span class="kw">%&gt;%</span>
  <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> <span class="no">lag0</span>:<span class="no">lag20</span>) <span class="kw">%&gt;%</span>
  <span class="fu">rename</span>(<span class="kw">ci_lo</span><span class="kw">=</span><span class="no">value</span>)

<span class="no">a_temp_ci_hi</span> <span class="kw">&lt;-</span> <span class="no">pred.temp</span>$<span class="no">matRRhigh</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu">rownames_to_column</span>(<span class="kw">var</span><span class="kw">=</span><span class="st">"var"</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">var</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">var</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">var</span><span class="kw">==</span><span class="fl">20</span> <span class="kw">|</span> <span class="no">var</span><span class="kw">==</span><span class="fl">30</span>) <span class="kw">%&gt;%</span>
  <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> <span class="no">lag0</span>:<span class="no">lag20</span>) <span class="kw">%&gt;%</span>
  <span class="fu">rename</span>(<span class="kw">ci_hi</span><span class="kw">=</span><span class="no">value</span>)

<span class="no">a2</span> <span class="kw">&lt;-</span> <span class="fu">left_join</span>(<span class="no">a_temp</span>, <span class="no">a_temp_ci_lo</span>)
<span class="no">a2</span> <span class="kw">&lt;-</span> <span class="fu">left_join</span>(<span class="no">a2</span>, <span class="no">a_temp_ci_hi</span>)

<span class="no">a</span> <span class="kw">&lt;-</span> <span class="fu">bind_rows</span>(<span class="no">a1</span>, <span class="no">a2</span>)

<span class="no">a</span> <span class="kw">&lt;-</span> <span class="no">a</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">lag</span> <span class="kw">=</span> <span class="fu">parse_number</span>(<span class="no">name</span>))

<span class="no">a</span> <span class="kw">%&gt;%</span>
  <span class="fu">ggplot</span>() +
  <span class="fu">geom_pointrange</span>(<span class="fu">aes</span>(<span class="kw">x</span><span class="kw">=</span><span class="no">lag</span>, <span class="kw">y</span><span class="kw">=</span><span class="no">value</span>, <span class="kw">ymin</span><span class="kw">=</span><span class="no">ci_lo</span>, <span class="kw">ymax</span><span class="kw">=</span><span class="no">ci_hi</span>, <span class="kw">group</span><span class="kw">=</span><span class="no">comparison</span>, <span class="kw">colour</span><span class="kw">=</span><span class="no">comparison</span>),
                  <span class="kw">position</span><span class="kw">=</span><span class="fu">position_jitterdodge</span>()) +
  <span class="fu">facet_grid</span>(<span class="no">comparison</span>~<span class="no">model</span>)</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-22-1.png" width="700"></p>
<p><br></p>
<div class="sourceCode" id="cb37"><html><body><pre class="r">
<span class="co">#rainfall</span>
<span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">d_q</span>$<span class="no">y_w</span>, <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span>(<span class="no">model.r</span>,<span class="kw">type</span><span class="kw">=</span><span class="st">"deviance"</span>), <span class="kw">pch</span><span class="kw">=</span><span class="fl">19</span>, <span class="kw">cex</span><span class="kw">=</span><span class="fl">0.8</span>, <span class="kw">col</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/grDevices/gray.html">grey</a></span>(<span class="fl">0.6</span>), <span class="kw">ylab</span><span class="kw">=</span><span class="st">"Residuals"</span>,<span class="kw">xlab</span><span class="kw">=</span><span class="st">""</span>,<span class="kw">cex.lab</span><span class="kw">=</span><span class="fl">1.2</span>,<span class="kw">cex.axis</span><span class="kw">=</span><span class="fl">1.2</span>); <span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span>(<span class="kw">h</span><span class="kw">=</span><span class="fl">0</span>,<span class="kw">lty</span><span class="kw">=</span><span class="fl">3</span>,<span class="kw">lwd</span><span class="kw">=</span><span class="fl">3</span>); <span class="fu"><a href="https://rdrr.io/r/graphics/title.html">title</a></span>(<span class="st">"A"</span>,<span class="kw">adj</span><span class="kw">=</span><span class="fl">0.95</span>, <span class="kw">line</span><span class="kw">=</span>-<span class="fl">1</span>)</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-23-1.png" width="700"></p>
<div class="sourceCode" id="cb38"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/stats/acf.html">pacf</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span>(<span class="no">model.r</span>, <span class="kw">type</span><span class="kw">=</span><span class="st">"deviance"</span>), <span class="kw">na.action</span><span class="kw">=</span><span class="no">na.omit</span>, <span class="kw">xlim</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>,<span class="fl">20</span>), <span class="kw">xlab</span><span class="kw">=</span><span class="st">""</span>, <span class="kw">cex.lab</span><span class="kw">=</span><span class="fl">1.2</span>, <span class="kw">cex.axis</span><span class="kw">=</span><span class="fl">1.2</span>); <span class="fu"><a href="https://rdrr.io/r/graphics/title.html">title</a></span>(<span class="st">"B"</span>,<span class="kw">adj</span><span class="kw">=</span><span class="fl">0.95</span>, <span class="kw">line</span><span class="kw">=</span>-<span class="fl">1</span>)</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-23-2.png" width="700"></p>
<div class="sourceCode" id="cb39"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/stats/acf.html">acf</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span>(<span class="no">model.r</span>,<span class="kw">type</span><span class="kw">=</span><span class="st">"deviance"</span>),<span class="kw">na.action</span><span class="kw">=</span><span class="no">na.omit</span>, <span class="kw">xlim</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>,<span class="fl">20</span>),<span class="kw">xlab</span><span class="kw">=</span><span class="st">""</span>, <span class="kw">cex.lab</span><span class="kw">=</span><span class="fl">1.2</span>, <span class="kw">cex.axis</span><span class="kw">=</span><span class="fl">1.2</span>); <span class="fu"><a href="https://rdrr.io/r/graphics/title.html">title</a></span>(<span class="st">"C"</span>,<span class="kw">adj</span><span class="kw">=</span><span class="fl">0.95</span>, <span class="kw">line</span><span class="kw">=</span>-<span class="fl">1</span>)</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-23-3.png" width="700"></p>
<div class="sourceCode" id="cb40"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="no">d_q</span>$<span class="no">n</span>), <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(<span class="no">model.r</span>,<span class="kw">type</span><span class="kw">=</span><span class="st">"response"</span>)), <span class="kw">col</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"orange2"</span>,<span class="st">"gray30"</span>), <span class="kw">xlab</span><span class="kw">=</span><span class="st">""</span>, <span class="kw">ylab</span><span class="kw">=</span><span class="st">"Observed TB notification"</span>, <span class="kw">pch</span><span class="kw">=</span><span class="fl">19</span>, <span class="kw">cex</span><span class="kw">=</span><span class="fl">0.8</span>, <span class="kw">cex.lab</span><span class="kw">=</span><span class="fl">1.2</span>, <span class="kw">cex.axis</span><span class="kw">=</span><span class="fl">1.2</span>); <span class="fu"><a href="https://rdrr.io/r/graphics/title.html">title</a></span>(<span class="st">"D"</span>,<span class="kw">adj</span><span class="kw">=</span><span class="fl">0.95</span>, <span class="kw">line</span><span class="kw">=</span>-<span class="fl">1</span>)
<span class="fu"><a href="https://rdrr.io/r/graphics/mtext.html">mtext</a></span>(<span class="st">"MAPE=17.8%"</span>,<span class="kw">side</span><span class="kw">=</span><span class="fl">3</span>,<span class="kw">line</span><span class="kw">=</span>-<span class="fl">16.5</span>,<span class="kw">adj</span><span class="kw">=</span><span class="fl">0.9</span>,<span class="kw">cex</span><span class="kw">=</span><span class="fl">0.7</span>)
<span class="fu"><a href="https://rdrr.io/r/graphics/legend.html">legend</a></span>(<span class="st">"topleft"</span>, <span class="kw">legend</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"observed"</span>, <span class="st">"predicted"</span>), <span class="kw">col</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"grey30"</span>,<span class="st">"orange2"</span>), <span class="kw">cex</span><span class="kw">=</span><span class="fl">0.8</span>, <span class="kw">pch</span><span class="kw">=</span><span class="fl">19</span>)</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-23-4.png" width="700"></p>
<div class="sourceCode" id="cb41"><html><body><pre class="r">
<span class="co">#temperature</span>
<span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">d_q</span>$<span class="no">y_w</span>, <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span>(<span class="no">model.t</span>,<span class="kw">type</span><span class="kw">=</span><span class="st">"deviance"</span>), <span class="kw">pch</span><span class="kw">=</span><span class="fl">19</span>, <span class="kw">cex</span><span class="kw">=</span><span class="fl">0.8</span>, <span class="kw">col</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/grDevices/gray.html">grey</a></span>(<span class="fl">0.6</span>), <span class="kw">ylab</span><span class="kw">=</span><span class="st">"Residuals"</span>,<span class="kw">xlab</span><span class="kw">=</span><span class="st">"Year"</span>,<span class="kw">cex.lab</span><span class="kw">=</span><span class="fl">1.2</span>,<span class="kw">cex.axis</span><span class="kw">=</span><span class="fl">1.2</span>); <span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span>(<span class="kw">h</span><span class="kw">=</span><span class="fl">0</span>,<span class="kw">lty</span><span class="kw">=</span><span class="fl">3</span>,<span class="kw">lwd</span><span class="kw">=</span><span class="fl">3</span>); <span class="fu"><a href="https://rdrr.io/r/graphics/title.html">title</a></span>(<span class="st">"E"</span>,<span class="kw">adj</span><span class="kw">=</span><span class="fl">0.95</span>, <span class="kw">line</span><span class="kw">=</span>-<span class="fl">1</span>)</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-23-5.png" width="700"></p>
<div class="sourceCode" id="cb42"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/stats/acf.html">pacf</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span>(<span class="no">model.t</span>, <span class="kw">type</span><span class="kw">=</span><span class="st">"deviance"</span>), <span class="kw">na.action</span><span class="kw">=</span><span class="no">na.omit</span>, <span class="kw">xlim</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>,<span class="fl">20</span>), <span class="kw">xlab</span><span class="kw">=</span><span class="st">"Weekly lag"</span>, <span class="kw">cex.lab</span><span class="kw">=</span><span class="fl">1.2</span>, <span class="kw">cex.axis</span><span class="kw">=</span><span class="fl">1.2</span>); <span class="fu"><a href="https://rdrr.io/r/graphics/title.html">title</a></span>(<span class="st">"F"</span>,<span class="kw">adj</span><span class="kw">=</span><span class="fl">0.95</span>, <span class="kw">line</span><span class="kw">=</span>-<span class="fl">1</span>)</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-23-6.png" width="700"></p>
<div class="sourceCode" id="cb43"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/stats/acf.html">acf</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span>(<span class="no">model.t</span>,<span class="kw">type</span><span class="kw">=</span><span class="st">"deviance"</span>),<span class="kw">na.action</span><span class="kw">=</span><span class="no">na.omit</span>, <span class="kw">xlim</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>,<span class="fl">20</span>),<span class="kw">xlab</span><span class="kw">=</span><span class="st">"Weekly lag"</span>, <span class="kw">cex.lab</span><span class="kw">=</span><span class="fl">1.2</span>, <span class="kw">cex.axis</span><span class="kw">=</span><span class="fl">1.2</span>); <span class="fu"><a href="https://rdrr.io/r/graphics/title.html">title</a></span>(<span class="st">"G"</span>,<span class="kw">adj</span><span class="kw">=</span><span class="fl">0.95</span>, <span class="kw">line</span><span class="kw">=</span>-<span class="fl">1</span>)</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-23-7.png" width="700"></p>
<div class="sourceCode" id="cb44"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="no">d_q</span>$<span class="no">n</span>), <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(<span class="no">model.t</span>,<span class="kw">type</span><span class="kw">=</span><span class="st">"response"</span>)), <span class="kw">col</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"orange2"</span>,<span class="st">"gray30"</span>), <span class="kw">xlab</span><span class="kw">=</span><span class="st">"Predicted TB notification"</span>, <span class="kw">ylab</span><span class="kw">=</span><span class="st">"Observed TB notification"</span>, <span class="kw">pch</span><span class="kw">=</span><span class="fl">19</span>, <span class="kw">cex</span><span class="kw">=</span><span class="fl">0.8</span>, <span class="kw">cex.lab</span><span class="kw">=</span><span class="fl">1.2</span>, <span class="kw">cex.axis</span><span class="kw">=</span><span class="fl">1.2</span>); <span class="fu"><a href="https://rdrr.io/r/graphics/title.html">title</a></span>(<span class="st">"H"</span>,<span class="kw">adj</span><span class="kw">=</span><span class="fl">0.95</span>, <span class="kw">line</span><span class="kw">=</span>-<span class="fl">1</span>)
<span class="fu"><a href="https://rdrr.io/r/graphics/mtext.html">mtext</a></span>(<span class="st">"MAPE=17.3%"</span>,<span class="kw">side</span><span class="kw">=</span><span class="fl">3</span>,<span class="kw">line</span><span class="kw">=</span>-<span class="fl">16.5</span>,<span class="kw">adj</span><span class="kw">=</span><span class="fl">0.9</span>,<span class="kw">cex</span><span class="kw">=</span><span class="fl">0.7</span>)</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-23-8.png" width="700"> stratified analyses on covariates mediating effects of weather on TB notification</p>
<div class="sourceCode" id="cb45"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span>(<span class="fu"><a href="https://rdrr.io/pkg/here/man/here.html">here</a></span>(<span class="st">"data/tb_cases_2011_2018.rda"</span>))

<span class="co">#load age, sex, hiv and micro datasets</span>
<span class="no">d_q_sex</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span>(<span class="no">tb_cases_2011_2018</span>,<span class="kw">select</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">reg_date</span>,<span class="no">sex</span>)),!<span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="no">sex</span>))
<span class="no">d_q_hiv</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span>(<span class="no">tb_cases_2011_2018</span>,<span class="kw">select</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">reg_date</span>,<span class="no">hiv</span>)),!<span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="no">hiv</span>))
<span class="no">d_q_age</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span>(<span class="no">tb_cases_2011_2018</span>,<span class="kw">select</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">reg_date</span>,<span class="no">age</span>)),!<span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="no">age</span>))
<span class="no">d_q_micro</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span>(<span class="no">tb_cases_2011_2018</span>,<span class="kw">select</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">reg_date</span>,<span class="no">smr_xpert_any</span>)),!<span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="no">smr_xpert_any</span>))
<span class="fu"><a href="https://rdrr.io/r/base/rm.html">remove</a></span>(<span class="no">tb_cases_2011_2018</span>)

<span class="co">#combine the sex dataset with weather dataset</span>
<span class="no">d_q_sex</span>$<span class="no">year</span> <span class="kw">&lt;-</span> <span class="fu"><a href="http://lubridate.tidyverse.org/reference/year.html">year</a></span>(<span class="no">d_q_sex</span>$<span class="no">reg_date</span>)
<span class="no">d_q_sex</span>$<span class="no">sex</span> <span class="kw">&lt;-</span> <span class="fu">if_else</span>(<span class="no">d_q_sex</span>$<span class="no">sex</span><span class="kw">==</span><span class="st">"Female"</span>,<span class="fl">0</span>,<span class="fl">1</span>)
<span class="no">d_q_sex</span>$<span class="no">wk</span> <span class="kw">&lt;-</span> <span class="fu"><a href="http://lubridate.tidyverse.org/reference/week.html">epiweek</a></span>(<span class="fu"><a href="http://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span>(<span class="no">d_q_sex</span>$<span class="no">reg_date</span>))
<span class="no">d_q_sex</span> <span class="kw">&lt;-</span> <span class="no">d_q_sex</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">group_by</a></span>(<span class="no">year</span>,<span class="no">wk</span>,<span class="no">sex</span>) <span class="kw">%&gt;%</span> <span class="fu">tally</span>()
<span class="no">d_q_sex</span> <span class="kw">&lt;-</span> <span class="fu">rename</span>(<span class="no">d_q_sex</span>,<span class="st">"ncase"</span><span class="kw">=</span><span class="st">"n"</span>)
<span class="no">d_q_sex</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/merge.html">merge</a></span>(<span class="kw">x</span><span class="kw">=</span><span class="no">d_q_sex</span>, <span class="kw">y</span><span class="kw">=</span><span class="no">d_q</span>, <span class="kw">by</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"year"</span>,<span class="st">"wk"</span>),<span class="kw">all.y</span><span class="kw">=</span><span class="fl">TRUE</span>), <span class="kw">select</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">y_w</span>,<span class="no">wk</span>,<span class="no">year</span>,<span class="no">sex</span>,<span class="no">ncase</span>,<span class="no">prcp</span>,<span class="no">temp</span>))

<span class="co">#combine the hiv dataset with weather dataset</span>
<span class="no">d_q_hiv</span>$<span class="no">year</span> <span class="kw">&lt;-</span> <span class="fu"><a href="http://lubridate.tidyverse.org/reference/year.html">year</a></span>(<span class="no">d_q_hiv</span>$<span class="no">reg_date</span>)
<span class="no">d_q_hiv</span>$<span class="no">hiv</span> <span class="kw">&lt;-</span> <span class="fu">if_else</span>(<span class="no">d_q_hiv</span>$<span class="no">hiv</span><span class="kw">==</span><span class="st">"a) HIV-negative"</span>,<span class="fl">0</span>,<span class="fl">1</span>)
<span class="no">d_q_hiv</span>$<span class="no">wk</span> <span class="kw">&lt;-</span> <span class="fu"><a href="http://lubridate.tidyverse.org/reference/week.html">epiweek</a></span>(<span class="fu"><a href="http://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span>(<span class="no">d_q_hiv</span>$<span class="no">reg_date</span>))
<span class="no">d_q_hiv</span> <span class="kw">&lt;-</span> <span class="no">d_q_hiv</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">group_by</a></span>(<span class="no">year</span>,<span class="no">wk</span>,<span class="no">hiv</span>) <span class="kw">%&gt;%</span> <span class="fu">tally</span>()
<span class="no">d_q_hiv</span> <span class="kw">&lt;-</span> <span class="fu">rename</span>(<span class="no">d_q_hiv</span>,<span class="st">"ncase"</span><span class="kw">=</span><span class="st">"n"</span>)
<span class="no">d_q_hiv</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/merge.html">merge</a></span>(<span class="kw">x</span><span class="kw">=</span><span class="no">d_q_hiv</span>, <span class="kw">y</span><span class="kw">=</span><span class="no">d_q</span>, <span class="kw">by</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"year"</span>,<span class="st">"wk"</span>),<span class="kw">all.y</span><span class="kw">=</span><span class="fl">TRUE</span>), <span class="kw">select</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">y_w</span>,<span class="no">wk</span>,<span class="no">year</span>,<span class="no">hiv</span>,<span class="no">ncase</span>,<span class="no">prcp</span>,<span class="no">temp</span>))

<span class="co">#combine the age dataset with weather dataset</span>
<span class="no">d_q_age</span>$<span class="no">year</span> <span class="kw">&lt;-</span> <span class="fu"><a href="http://lubridate.tidyverse.org/reference/year.html">year</a></span>(<span class="no">d_q_age</span>$<span class="no">reg_date</span>)
<span class="no">d_q_age</span>$<span class="no">age</span> <span class="kw">&lt;-</span> <span class="fu">if_else</span>(<span class="no">d_q_age</span>$<span class="no">age</span><span class="kw">&lt;=</span><span class="fl">24</span>,<span class="fl">0</span>,<span class="fu">if_else</span>(<span class="no">d_q_age</span>$<span class="no">age</span><span class="kw">&gt;</span><span class="fl">24</span> <span class="kw">&amp;</span> <span class="no">d_q_age</span>$<span class="no">age</span><span class="kw">&lt;=</span><span class="fl">49</span>,<span class="fl">1</span>,<span class="fl">2</span>))
<span class="no">d_q_age</span>$<span class="no">wk</span> <span class="kw">&lt;-</span> <span class="fu"><a href="http://lubridate.tidyverse.org/reference/week.html">epiweek</a></span>(<span class="fu"><a href="http://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span>(<span class="no">d_q_age</span>$<span class="no">reg_date</span>))
<span class="no">d_q_age</span> <span class="kw">&lt;-</span> <span class="no">d_q_age</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">group_by</a></span>(<span class="no">year</span>,<span class="no">wk</span>,<span class="no">age</span>) <span class="kw">%&gt;%</span> <span class="fu">tally</span>()
<span class="no">d_q_age</span> <span class="kw">&lt;-</span> <span class="fu">rename</span>(<span class="no">d_q_age</span>,<span class="st">"ncase"</span><span class="kw">=</span><span class="st">"n"</span>)
<span class="no">d_q_age</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/merge.html">merge</a></span>(<span class="kw">x</span><span class="kw">=</span><span class="no">d_q_age</span>, <span class="kw">y</span><span class="kw">=</span><span class="no">d_q</span>, <span class="kw">by</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"year"</span>,<span class="st">"wk"</span>),<span class="kw">all.y</span><span class="kw">=</span><span class="fl">TRUE</span>), <span class="kw">select</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">y_w</span>,<span class="no">wk</span>,<span class="no">year</span>,<span class="no">age</span>,<span class="no">ncase</span>,<span class="no">prcp</span>,<span class="no">temp</span>))

<span class="co">#combine the micro dataset with weather dataset</span>
<span class="no">d_q_micro</span>$<span class="no">year</span> <span class="kw">&lt;-</span> <span class="fu"><a href="http://lubridate.tidyverse.org/reference/year.html">year</a></span>(<span class="no">d_q_micro</span>$<span class="no">reg_date</span>)
<span class="no">d_q_micro</span>$<span class="no">smr_xpert_any</span> <span class="kw">&lt;-</span> <span class="fu">if_else</span>(<span class="no">d_q_micro</span>$<span class="no">smr_xpert_any</span><span class="kw">==</span><span class="st">"b) Smr/Xpert-positive"</span>,<span class="fl">1</span>,<span class="fl">0</span>)
<span class="no">d_q_micro</span>$<span class="no">wk</span> <span class="kw">&lt;-</span> <span class="fu"><a href="http://lubridate.tidyverse.org/reference/week.html">epiweek</a></span>(<span class="fu"><a href="http://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span>(<span class="no">d_q_micro</span>$<span class="no">reg_date</span>))
<span class="no">d_q_micro</span> <span class="kw">&lt;-</span> <span class="no">d_q_micro</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">group_by</a></span>(<span class="no">year</span>,<span class="no">wk</span>,<span class="no">smr_xpert_any</span>) <span class="kw">%&gt;%</span> <span class="fu">tally</span>()
<span class="no">d_q_micro</span> <span class="kw">&lt;-</span> <span class="fu">rename</span>(<span class="no">d_q_micro</span>,<span class="st">"ncase"</span><span class="kw">=</span><span class="st">"n"</span>)
<span class="no">d_q_micro</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/merge.html">merge</a></span>(<span class="kw">x</span><span class="kw">=</span><span class="no">d_q_micro</span>, <span class="kw">y</span><span class="kw">=</span><span class="no">d_q</span>, <span class="kw">by</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"year"</span>,<span class="st">"wk"</span>),<span class="kw">all.y</span><span class="kw">=</span><span class="fl">TRUE</span>), <span class="kw">select</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">y_w</span>,<span class="no">wk</span>,<span class="no">year</span>,<span class="no">smr_xpert_any</span>,<span class="no">ncase</span>,<span class="no">prcp</span>,<span class="no">temp</span>))</pre></body></html></div>
<p><br></p>
<p>stratification by female sex reconstruct cross-basis functions for rainfall and temperature given the optimal DoF</p>
<div class="sourceCode" id="cb46"><html><body><pre class="r">
d_q_sex0 &lt;- subset(d_q_sex,sex==0)

sort(d_q_sex0$prcp, decreasing=FALSE)
  [1]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
  [7]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [13]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [19]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [25]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [31]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [37]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [43]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [49]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [55]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [61]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [67]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [73]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [79]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [85]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [91]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [97]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[103]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[109]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[115]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[121]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[127]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[133]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[139]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[145]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[151]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[157]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[163]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[169]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[175]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[181]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[187]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[193]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[199]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[205]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[211]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[217]  0.04285714  0.04285714  0.05000000  0.07142857  0.07500000  0.08333333
[223]  0.11428571  0.13333333  0.13333333  0.14285714  0.14285714  0.14285714
[229]  0.14285714  0.15714286  0.16666667  0.18571429  0.18571429  0.21428571
[235]  0.21666667  0.25000000  0.25000000  0.26666667  0.33333333  0.33333333
[241]  0.40000000  0.41666667  0.41666667  0.41666667  0.43333333  0.46666667
[247]  0.47142857  0.50000000  0.51428571  0.55000000  0.58000000  0.60000000
[253]  0.62000000  0.68571429  0.75714286  0.76000000  0.80000000  0.84285714
[259]  0.95000000  0.96000000  1.01428571  1.05000000  1.13333333  1.20000000
[265]  1.22000000  1.40000000  1.40000000  1.42000000  1.48333333  1.52857143
[271]  1.57142857  1.62857143  1.68333333  1.70000000  1.70000000  1.72000000
[277]  1.85000000  2.00000000  2.08000000  2.11666667  2.18000000  2.21428571
[283]  2.24000000  2.38000000  2.52500000  2.53333333  2.57142857  2.65000000
[289]  2.68571429  2.75000000  2.87142857  2.96666667  2.96666667  3.16666667
[295]  3.26666667  3.26666667  3.30000000  3.30000000  3.30000000  3.35000000
[301]  3.60000000  3.60000000  3.81428571  3.85000000  3.95000000  3.98333333
[307]  3.98333333  4.02000000  4.10000000  4.20000000  4.31666667  4.54285714
[313]  4.56666667  4.70000000  4.71428571  4.82000000  4.82500000  4.83333333
[319]  4.92000000  5.03333333  5.05000000  5.20000000  5.21428571  5.24000000
[325]  5.35000000  5.52857143  5.60000000  5.62857143  5.68333333  5.85000000
[331]  5.88333333  6.07142857  6.20000000  6.22500000  6.46666667  6.50000000
[337]  7.22500000  7.27142857  7.30000000  7.38333333  7.48333333  7.65714286
[343]  7.96000000  8.50000000  8.94285714  9.10000000  9.66666667  9.70000000
[349]  9.72000000  9.77500000 10.80000000 11.13333333 11.16000000 11.17500000
[355] 11.26666667 11.55000000 11.75000000 11.80000000 11.98571429 12.72857143
[361] 12.87500000 13.80000000 13.82500000 14.15714286 14.58571429 15.75000000
[367] 20.40000000 20.58571429 21.72500000 22.80000000 25.41428571 28.41428571
[373] 31.70000000
lagk=logknots(20, fun="ns", df=3)
vark=equalknots(d_q_sex0$prcp, fun="ns", df=3)
cb.rain &lt;- crossbasis(d_q_sex0$prcp, lag=20, argvar=list(knots=vark), arglag=list(knots=lagk))

lagk=logknots(20, fun="ns", df=3)
vark=equalknots(d_q_sex0$temp, fun="ns", df=3)
cb.temp &lt;- crossbasis(d_q_sex0$temp, lag=20, argvar=list(knots=vark), arglag=list(knots=lagk))

#fit two models for rainfall and temperature seperately in generalised linear framework
model.r &lt;- glm(ncase ~ cb.rain + wk + year, family=quasipoisson(), na.action=na.exclude, d_q_sex0)
model.t &lt;- glm(ncase ~ cb.temp + wk + year, family=quasipoisson(), na.action=na.exclude, d_q_sex0)

#validate rainfall model by minimising high partial/auto-correlation (outside blue dotted lines)
pacf(residuals(model.r,type="deviance"),na.action=na.omit,main="Partial autocorrelation",xlim=c(0,20))</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-25-1.png" width="700"></p>
<div class="sourceCode" id="cb47"><html><body><pre class="r">
<span class="co">#validate temperature model by minimising high partial/auto-correlation (outside blue dotted lines)</span>
<span class="fu"><a href="https://rdrr.io/r/stats/acf.html">pacf</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span>(<span class="no">model.t</span>,<span class="kw">type</span><span class="kw">=</span><span class="st">"deviance"</span>),<span class="kw">na.action</span><span class="kw">=</span><span class="no">na.omit</span>,<span class="kw">main</span><span class="kw">=</span><span class="st">"Partial autocorrelation"</span>,<span class="kw">xlim</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>,<span class="fl">20</span>))</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-25-2.png" width="700"></p>
<div class="sourceCode" id="cb48"><html><body><pre class="r">
<span class="co">#predict (nowcast) the effect on TB notification of rainfall/temperature</span>
<span class="no">pred.rain</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/dlnm/man/crosspred.html">crosspred</a></span>(<span class="no">cb.rain</span>, <span class="no">model.r</span>, <span class="kw">cen</span><span class="kw">=</span><span class="fl">0</span>, <span class="kw">by</span><span class="kw">=</span><span class="fl">0.2</span>)
<span class="no">pred.temp</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/dlnm/man/crosspred.html">crosspred</a></span>(<span class="no">cb.temp</span>, <span class="no">model.t</span>, <span class="kw">cen</span><span class="kw">=</span><span class="fl">17</span>, <span class="kw">by</span><span class="kw">=</span><span class="fl">0.2</span>)

<span class="co">#plot 3D, countour and curves for rainfall on TB notifications</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span>(<span class="kw">mgp</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">2.3</span>,<span class="fl">1</span>,<span class="fl">0</span>),<span class="kw">mai</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.9</span>,<span class="fl">0.9</span>,<span class="fl">0.3</span>,<span class="fl">0.2</span>))
<span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">pred.rain</span>, <span class="st">"contour"</span>, <span class="kw">key.title</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html">title</a></span>(<span class="st">"TBN"</span>), <span class="kw">plot.title</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html">title</a></span>(<span class="st">"A"</span>, <span class="kw">xlab</span> <span class="kw">=</span><span class="st">"Weekly mean rainfall (mm)"</span>, <span class="kw">ylab</span> <span class="kw">=</span> <span class="st">"Weekly lag"</span>, <span class="kw">cex.lab</span><span class="kw">=</span><span class="fl">1</span>, <span class="kw">cex.axis</span><span class="kw">=</span><span class="fl">1</span>))</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-25-3.png" width="700"></p>
<div class="sourceCode" id="cb49"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">pred.rain</span>, <span class="st">"slices"</span>, <span class="kw">type</span><span class="kw">=</span><span class="st">"p"</span>, <span class="kw">pch</span><span class="kw">=</span><span class="fl">19</span>, <span class="kw">cex</span><span class="kw">=</span><span class="fl">1.3</span>, <span class="kw">var</span><span class="kw">=</span><span class="fl">18</span>, <span class="kw">col</span><span class="kw">=</span><span class="st">"purple"</span>, <span class="kw">ci.level</span><span class="kw">=</span><span class="fl">0.5</span>, <span class="kw">ci</span><span class="kw">=</span><span class="st">"bars"</span>, <span class="kw">ylab</span><span class="kw">=</span><span class="st">"Report ratio"</span>, <span class="kw">xlab</span><span class="kw">=</span><span class="st">"Weekly lag"</span>, <span class="kw">main</span><span class="kw">=</span><span class="st">"B"</span>)</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-25-4.png" width="700"></p>
<div class="sourceCode" id="cb50"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">pred.rain</span>, <span class="st">"slices"</span>, <span class="kw">type</span><span class="kw">=</span><span class="st">"p"</span>, <span class="kw">pch</span><span class="kw">=</span><span class="fl">19</span>, <span class="kw">cex</span><span class="kw">=</span><span class="fl">1.3</span>, <span class="kw">var</span><span class="kw">=</span><span class="fl">30</span>, <span class="kw">col</span><span class="kw">=</span><span class="st">"purple"</span>, <span class="kw">ci.level</span><span class="kw">=</span><span class="fl">0.5</span>, <span class="kw">ci</span><span class="kw">=</span><span class="st">"bars"</span>, <span class="kw">ylab</span><span class="kw">=</span><span class="st">"Report ratio"</span>, <span class="kw">xlab</span><span class="kw">=</span><span class="st">"Weekly lag"</span>, <span class="kw">main</span><span class="kw">=</span><span class="st">"C"</span>)</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-25-5.png" width="700"></p>
<div class="sourceCode" id="cb51"><html><body><pre class="r">
<span class="co">#plot 3D, countour and curves for temperature on TB notifications</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span>(<span class="kw">mgp</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">2.3</span>,<span class="fl">1</span>,<span class="fl">0</span>),<span class="kw">mai</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.9</span>,<span class="fl">0.9</span>,<span class="fl">0.3</span>,<span class="fl">0.2</span>))
<span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">pred.temp</span>, <span class="st">"contour"</span>, <span class="kw">key.title</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html">title</a></span>(<span class="st">"TBN"</span>), <span class="kw">plot.title</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html">title</a></span>(<span class="st">"D"</span>, <span class="kw">xlab</span> <span class="kw">=</span><span class="st">"Weekly mean temperature (°C)"</span>, <span class="kw">ylab</span> <span class="kw">=</span> <span class="st">"Weekly lag"</span>, <span class="kw">cex.lab</span><span class="kw">=</span><span class="fl">1</span>, <span class="kw">cex.axis</span><span class="kw">=</span><span class="fl">1</span>))</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-25-6.png" width="700"></p>
<div class="sourceCode" id="cb52"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">pred.temp</span>, <span class="st">"slices"</span>, <span class="kw">type</span><span class="kw">=</span><span class="st">"p"</span>, <span class="kw">pch</span><span class="kw">=</span><span class="fl">19</span>, <span class="kw">cex</span><span class="kw">=</span><span class="fl">1.3</span>, <span class="kw">var</span><span class="kw">=</span><span class="fl">20</span>, <span class="kw">col</span><span class="kw">=</span><span class="st">"red2"</span>, <span class="kw">ci.level</span><span class="kw">=</span><span class="fl">0.5</span>, <span class="kw">ci</span><span class="kw">=</span><span class="st">"bars"</span>, <span class="kw">ylab</span><span class="kw">=</span><span class="st">"Report ratio"</span>, <span class="kw">xlab</span><span class="kw">=</span><span class="st">"Weekly lag"</span>, <span class="kw">main</span><span class="kw">=</span><span class="st">"E"</span>)</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-25-7.png" width="700"></p>
<div class="sourceCode" id="cb53"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">pred.temp</span>, <span class="st">"slices"</span>, <span class="kw">type</span><span class="kw">=</span><span class="st">"p"</span>, <span class="kw">pch</span><span class="kw">=</span><span class="fl">19</span>, <span class="kw">cex</span><span class="kw">=</span><span class="fl">1.3</span>, <span class="kw">var</span><span class="kw">=</span><span class="fl">30</span>, <span class="kw">col</span><span class="kw">=</span><span class="st">"red2"</span>, <span class="kw">ci.level</span><span class="kw">=</span><span class="fl">0.5</span>, <span class="kw">ci</span><span class="kw">=</span><span class="st">"bars"</span>, <span class="kw">ylab</span><span class="kw">=</span><span class="st">"Report ratio"</span>, <span class="kw">xlab</span><span class="kw">=</span><span class="st">"Weekly lag"</span>, <span class="kw">main</span><span class="kw">=</span><span class="st">"F"</span>)</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-25-8.png" width="700"></p>
<p><br></p>
<p>Extract the data for combined plot</p>
<div class="sourceCode" id="cb54"><html><body><pre class="r"><span class="co">#rainfall</span>
<span class="no">b_rain</span> <span class="kw">&lt;-</span> <span class="no">pred.rain</span>$<span class="no">matRRfit</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu">rownames_to_column</span>(<span class="kw">var</span><span class="kw">=</span><span class="st">"var"</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">var</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">var</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">var</span><span class="kw">==</span><span class="fl">18</span> <span class="kw">|</span> <span class="no">var</span><span class="kw">==</span><span class="fl">30</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">comparison</span> <span class="kw">=</span> <span class="fu">case_when</span>(<span class="no">var</span><span class="kw">==</span><span class="fl">18</span> ~ <span class="st">"Mid (18mm) vs. low (0mm)"</span>,
                                <span class="no">var</span><span class="kw">==</span><span class="fl">30</span> ~ <span class="st">"High (30mm) vs. low (0mm)"</span>),
         <span class="kw">variable</span><span class="kw">=</span><span class="st">"Female"</span>,
         <span class="kw">model</span> <span class="kw">=</span> <span class="st">"Rainfall"</span>) <span class="kw">%&gt;%</span>
  <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> <span class="no">lag0</span>:<span class="no">lag20</span>)

<span class="no">b_rain_ci_lo</span> <span class="kw">&lt;-</span> <span class="no">pred.rain</span>$<span class="no">matRRlow</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu">rownames_to_column</span>(<span class="kw">var</span><span class="kw">=</span><span class="st">"var"</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">var</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">var</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">var</span><span class="kw">==</span><span class="fl">18</span> <span class="kw">|</span> <span class="no">var</span><span class="kw">==</span><span class="fl">30</span>) <span class="kw">%&gt;%</span>
  <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> <span class="no">lag0</span>:<span class="no">lag20</span>) <span class="kw">%&gt;%</span>
  <span class="fu">rename</span>(<span class="kw">ci_lo</span><span class="kw">=</span><span class="no">value</span>)

<span class="no">b_rain_ci_hi</span> <span class="kw">&lt;-</span> <span class="no">pred.rain</span>$<span class="no">matRRhigh</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu">rownames_to_column</span>(<span class="kw">var</span><span class="kw">=</span><span class="st">"var"</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">var</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">var</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">var</span><span class="kw">==</span><span class="fl">18</span> <span class="kw">|</span> <span class="no">var</span><span class="kw">==</span><span class="fl">30</span>) <span class="kw">%&gt;%</span>
  <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> <span class="no">lag0</span>:<span class="no">lag20</span>) <span class="kw">%&gt;%</span>
  <span class="fu">rename</span>(<span class="kw">ci_hi</span><span class="kw">=</span><span class="no">value</span>)

<span class="no">b1</span> <span class="kw">&lt;-</span> <span class="fu">left_join</span>(<span class="no">b_rain</span>, <span class="no">b_rain_ci_lo</span>)
<span class="no">b1</span> <span class="kw">&lt;-</span> <span class="fu">left_join</span>(<span class="no">b1</span>, <span class="no">b_rain_ci_hi</span>)

<span class="co">#temp</span>
<span class="no">b_temp</span> <span class="kw">&lt;-</span> <span class="no">pred.temp</span>$<span class="no">matRRfit</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu">rownames_to_column</span>(<span class="kw">var</span><span class="kw">=</span><span class="st">"var"</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">var</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">var</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">var</span><span class="kw">==</span><span class="fl">20</span> <span class="kw">|</span> <span class="no">var</span><span class="kw">==</span><span class="fl">30</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">comparison</span> <span class="kw">=</span> <span class="fu">case_when</span>(<span class="no">var</span><span class="kw">==</span><span class="fl">20</span> ~ <span class="st">"Mid (20°C) vs. low (17°C)"</span>,
                                <span class="no">var</span><span class="kw">==</span><span class="fl">30</span> ~ <span class="st">"High (30°C) vs. low (17°C)"</span>),
         <span class="kw">variable</span><span class="kw">=</span><span class="st">"Female"</span>,
         <span class="kw">model</span> <span class="kw">=</span> <span class="st">"Temperature"</span>) <span class="kw">%&gt;%</span>
  <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> <span class="no">lag0</span>:<span class="no">lag20</span>)

<span class="no">b_temp_ci_lo</span> <span class="kw">&lt;-</span> <span class="no">pred.temp</span>$<span class="no">matRRlow</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu">rownames_to_column</span>(<span class="kw">var</span><span class="kw">=</span><span class="st">"var"</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">var</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">var</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">var</span><span class="kw">==</span><span class="fl">20</span> <span class="kw">|</span> <span class="no">var</span><span class="kw">==</span><span class="fl">30</span>) <span class="kw">%&gt;%</span>
  <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> <span class="no">lag0</span>:<span class="no">lag20</span>) <span class="kw">%&gt;%</span>
  <span class="fu">rename</span>(<span class="kw">ci_lo</span><span class="kw">=</span><span class="no">value</span>)

<span class="no">b_temp_ci_hi</span> <span class="kw">&lt;-</span> <span class="no">pred.temp</span>$<span class="no">matRRhigh</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu">rownames_to_column</span>(<span class="kw">var</span><span class="kw">=</span><span class="st">"var"</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">var</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">var</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">var</span><span class="kw">==</span><span class="fl">20</span> <span class="kw">|</span> <span class="no">var</span><span class="kw">==</span><span class="fl">30</span>) <span class="kw">%&gt;%</span>
  <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> <span class="no">lag0</span>:<span class="no">lag20</span>) <span class="kw">%&gt;%</span>
  <span class="fu">rename</span>(<span class="kw">ci_hi</span><span class="kw">=</span><span class="no">value</span>)

<span class="no">b2</span> <span class="kw">&lt;-</span> <span class="fu">left_join</span>(<span class="no">b_temp</span>, <span class="no">b_temp_ci_lo</span>)
<span class="no">b2</span> <span class="kw">&lt;-</span> <span class="fu">left_join</span>(<span class="no">b2</span>, <span class="no">b_temp_ci_hi</span>)

<span class="no">b</span> <span class="kw">&lt;-</span> <span class="fu">bind_rows</span>(<span class="no">b1</span>, <span class="no">b2</span>)

<span class="no">b</span> <span class="kw">&lt;-</span> <span class="no">b</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">lag</span> <span class="kw">=</span> <span class="fu">parse_number</span>(<span class="no">name</span>))

<span class="no">b</span> <span class="kw">%&gt;%</span>
  <span class="fu">ggplot</span>() +
  <span class="fu">geom_pointrange</span>(<span class="fu">aes</span>(<span class="kw">x</span><span class="kw">=</span><span class="no">lag</span>, <span class="kw">y</span><span class="kw">=</span><span class="no">value</span>, <span class="kw">ymin</span><span class="kw">=</span><span class="no">ci_lo</span>, <span class="kw">ymax</span><span class="kw">=</span><span class="no">ci_hi</span>, <span class="kw">group</span><span class="kw">=</span><span class="no">comparison</span>, <span class="kw">colour</span><span class="kw">=</span><span class="no">comparison</span>),
                  <span class="kw">position</span><span class="kw">=</span><span class="fu">position_jitterdodge</span>()) +
  <span class="fu">facet_grid</span>(<span class="no">comparison</span>~<span class="no">model</span>)</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-26-1.png" width="700"></p>
<p><br></p>
<p>stratification by male sex reconstruct cross-basis functions for rainfall and temperature given the optimal DoF</p>
<div class="sourceCode" id="cb55"><html><body><pre class="r">
d_q_sex1 &lt;- subset(d_q_sex,sex==1)

sort(d_q_sex1$prcp, decreasing=FALSE)
  [1]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
  [7]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [13]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [19]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [25]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [31]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [37]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [43]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [49]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [55]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [61]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [67]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [73]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [79]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [85]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [91]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [97]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[103]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[109]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[115]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[121]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[127]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[133]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[139]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[145]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[151]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[157]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[163]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[169]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[175]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[181]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[187]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[193]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[199]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[205]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[211]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[217]  0.04285714  0.04285714  0.05000000  0.07142857  0.07500000  0.08333333
[223]  0.11428571  0.13333333  0.13333333  0.14285714  0.14285714  0.14285714
[229]  0.14285714  0.15714286  0.16666667  0.18571429  0.18571429  0.21428571
[235]  0.21666667  0.25000000  0.25000000  0.26666667  0.33333333  0.33333333
[241]  0.40000000  0.41666667  0.41666667  0.41666667  0.43333333  0.46666667
[247]  0.47142857  0.50000000  0.51428571  0.55000000  0.58000000  0.60000000
[253]  0.62000000  0.68571429  0.75714286  0.76000000  0.80000000  0.84285714
[259]  0.95000000  0.96000000  1.01428571  1.05000000  1.13333333  1.20000000
[265]  1.22000000  1.40000000  1.40000000  1.42000000  1.48333333  1.52857143
[271]  1.57142857  1.62857143  1.68333333  1.70000000  1.70000000  1.72000000
[277]  1.85000000  2.00000000  2.08000000  2.11666667  2.18000000  2.21428571
[283]  2.24000000  2.38000000  2.52500000  2.53333333  2.57142857  2.65000000
[289]  2.68571429  2.75000000  2.87142857  2.96666667  2.96666667  3.16666667
[295]  3.26666667  3.26666667  3.30000000  3.30000000  3.30000000  3.35000000
[301]  3.60000000  3.60000000  3.81428571  3.85000000  3.95000000  3.98333333
[307]  3.98333333  4.02000000  4.10000000  4.20000000  4.31666667  4.54285714
[313]  4.56666667  4.70000000  4.71428571  4.82000000  4.82500000  4.83333333
[319]  4.92000000  5.03333333  5.05000000  5.20000000  5.21428571  5.24000000
[325]  5.35000000  5.52857143  5.60000000  5.62857143  5.68333333  5.85000000
[331]  5.88333333  6.07142857  6.20000000  6.22500000  6.46666667  6.50000000
[337]  7.22500000  7.27142857  7.30000000  7.38333333  7.48333333  7.65714286
[343]  7.96000000  8.50000000  8.94285714  9.10000000  9.66666667  9.70000000
[349]  9.72000000  9.77500000 10.80000000 11.13333333 11.16000000 11.17500000
[355] 11.26666667 11.55000000 11.75000000 11.80000000 11.98571429 12.72857143
[361] 12.87500000 13.80000000 13.82500000 14.15714286 14.58571429 15.75000000
[367] 20.40000000 20.58571429 21.72500000 22.80000000 25.41428571 28.41428571
[373] 31.70000000
lagk=logknots(20, fun="ns", df=3)
vark=equalknots(d_q_sex1$prcp, fun="ns", df=3)
cb.rain &lt;- crossbasis(d_q_sex1$prcp, lag=20, argvar=list(knots=vark), arglag=list(knots=lagk))

sort(d_q_sex1$temp, decreasing=FALSE)
  [1] 16.64286 17.90000 18.38571 18.53333 18.85714 18.96000 19.22857 19.25714
  [9] 19.52857 20.08571 20.16667 20.34286 20.41667 20.48333 20.58571 20.61667
 [17] 20.65714 20.67143 20.70000 20.77500 20.78571 20.96667 20.97143 21.03333
 [25] 21.04000 21.04286 21.07143 21.07143 21.10000 21.12857 21.18333 21.21429
 [33] 21.24286 21.27143 21.28000 21.33333 21.42000 21.45000 21.45714 21.47143
 [41] 21.55714 21.55714 21.56667 21.57143 21.58000 21.67143 21.71429 21.72857
 [49] 21.73333 21.74286 21.80000 21.81429 21.84286 21.87143 21.90000 21.90000
 [57] 21.91429 21.94286 22.08571 22.10000 22.22000 22.24286 22.24286 22.26667
 [65] 22.28000 22.28571 22.31429 22.33333 22.35714 22.40000 22.44286 22.47143
 [73] 22.50000 22.55714 22.56667 22.57143 22.57500 22.58571 22.58571 22.60000
 [81] 22.70000 22.75714 22.77143 22.78000 22.78571 22.80000 22.86667 22.95714
 [89] 22.98000 23.00000 23.02500 23.02857 23.06667 23.10000 23.10000 23.11429
 [97] 23.11429 23.22857 23.24286 23.28571 23.31429 23.31667 23.32857 23.34286
[105] 23.40000 23.40000 23.40000 23.41429 23.48000 23.48571 23.54286 23.67143
[113] 23.71429 23.71429 23.75000 23.77143 23.77500 23.82857 23.82857 23.87143
[121] 23.90000 23.90000 23.90000 23.95714 24.00000 24.00000 24.02857 24.05000
[129] 24.05000 24.08571 24.08571 24.11429 24.15714 24.20000 24.23333 24.25000
[137] 24.25000 24.25000 24.25714 24.30000 24.32857 24.32857 24.35714 24.37143
[145] 24.37500 24.37500 24.45714 24.48000 24.51429 24.52000 24.55714 24.57500
[153] 24.58000 24.61429 24.62857 24.65000 24.67143 24.70000 24.70000 24.73333
[161] 24.77143 24.78000 24.78333 24.80000 24.82500 24.86667 24.87143 24.87500
[169] 24.88571 24.90000 24.91667 24.93333 24.95714 24.98333 25.00000 25.00000
[177] 25.01667 25.03333 25.06000 25.08571 25.10000 25.10000 25.11429 25.12857
[185] 25.14286 25.15714 25.17143 25.20000 25.20000 25.20000 25.20000 25.22500
[193] 25.22857 25.25714 25.27500 25.30000 25.31429 25.34286 25.35000 25.35714
[201] 25.38571 25.40000 25.44286 25.53333 25.60000 25.60000 25.62857 25.62857
[209] 25.62857 25.64286 25.64286 25.64286 25.65000 25.68333 25.68571 25.70000
[217] 25.72857 25.75000 25.75714 25.76000 25.77143 25.78333 25.78571 25.78571
[225] 25.84286 25.86667 25.91429 25.92857 25.94286 25.98000 26.02500 26.03333
[233] 26.03333 26.04286 26.04286 26.08571 26.14000 26.15714 26.15714 26.16667
[241] 26.18333 26.18571 26.21429 26.21429 26.22000 26.22857 26.25000 26.25714
[249] 26.28000 26.33333 26.35000 26.41429 26.41667 26.41667 26.41667 26.42500
[257] 26.45000 26.47143 26.51429 26.53333 26.54286 26.60000 26.66667 26.67143
[265] 26.70000 26.71429 26.72857 26.76000 26.78571 26.80000 26.87143 26.87143
[273] 26.88571 26.92500 26.92857 26.94286 26.94286 26.95714 26.97143 27.00000
[281] 27.00000 27.01429 27.03333 27.05000 27.10000 27.21429 27.25714 27.27143
[289] 27.27143 27.27143 27.28333 27.28571 27.37143 27.40000 27.42857 27.45000
[297] 27.45714 27.54000 27.55000 27.61429 27.66000 27.75000 27.76000 27.77143
[305] 27.78571 27.80000 27.87143 27.87143 27.88333 27.98000 28.00000 28.00000
[313] 28.01429 28.02857 28.05714 28.05714 28.10000 28.16667 28.20000 28.22000
[321] 28.22857 28.25000 28.25714 28.25714 28.25714 28.27143 28.28333 28.32857
[329] 28.36000 28.36667 28.38571 28.45714 28.46667 28.48571 28.55000 28.57143
[337] 28.60000 28.60000 28.65714 28.66667 28.74286 28.77143 28.80000 28.87143
[345] 28.87500 28.97500 29.14286 29.16667 29.21667 29.25714 29.34000 29.43333
[353] 29.47143 29.61429 29.70000 29.71667 29.90000 30.02857 30.02857 30.05000
[361] 30.23333 30.26000 30.46667 30.74286 30.88000 30.96667 30.97143 31.25714
[369] 31.32857 31.52857 31.67143 32.20000 34.00000
lagk=logknots(20, fun="ns", df=3)
vark=equalknots(d_q_sex1$temp, fun="ns", df=3)
cb.temp &lt;- crossbasis(d_q_sex1$temp, lag=20, argvar=list(knots=vark), arglag=list(knots=lagk))

#fit two models for rainfall and temperature seperately in generalised linear framework
model.r &lt;- glm(ncase ~ cb.rain + wk + year, family=quasipoisson(), na.action=na.exclude, d_q_sex1)
model.t &lt;- glm(ncase ~ cb.temp + wk + year, family=quasipoisson(), na.action=na.exclude, d_q_sex1)

#validate rainfall model by minimising high partial/auto-correlation (outside blue dotted lines)
pacf(residuals(model.r,type="deviance"),na.action=na.omit,main="Partial autocorrelation",xlim=c(0,20))</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-27-1.png" width="700"></p>
<div class="sourceCode" id="cb56"><html><body><pre class="r">
<span class="co">#validate temperature model by minimising high partial/auto-correlation (outside blue dotted lines)</span>
<span class="fu"><a href="https://rdrr.io/r/stats/acf.html">pacf</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span>(<span class="no">model.t</span>,<span class="kw">type</span><span class="kw">=</span><span class="st">"deviance"</span>),<span class="kw">na.action</span><span class="kw">=</span><span class="no">na.omit</span>,<span class="kw">main</span><span class="kw">=</span><span class="st">"Partial autocorrelation"</span>,<span class="kw">xlim</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>,<span class="fl">20</span>))</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-27-2.png" width="700"></p>
<div class="sourceCode" id="cb57"><html><body><pre class="r"><span class="no">model.t</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span>(<span class="no">model.t</span>,<span class="no">.</span>~<span class="no">.</span>+<span class="fu"><a href="https://rdrr.io/r/stats/lag.html">lag</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span>(<span class="no">model.t</span>,<span class="kw">type</span><span class="kw">=</span><span class="st">"deviance"</span>),<span class="fl">9</span>))

<span class="co">#predict (nowcast) the effect on TB notification of rainfall/temperature</span>
<span class="no">pred.rain</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/dlnm/man/crosspred.html">crosspred</a></span>(<span class="no">cb.rain</span>, <span class="no">model.r</span>, <span class="kw">cen</span><span class="kw">=</span><span class="fl">0</span>, <span class="kw">by</span><span class="kw">=</span><span class="fl">0.2</span>)
<span class="no">pred.temp</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/dlnm/man/crosspred.html">crosspred</a></span>(<span class="no">cb.temp</span>, <span class="no">model.t</span>, <span class="kw">cen</span><span class="kw">=</span><span class="fl">17</span>, <span class="kw">by</span><span class="kw">=</span><span class="fl">0.2</span>)

<span class="co">#plot 3D, countour and curves for rainfall on TB notifications</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span>(<span class="kw">mgp</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">2.3</span>,<span class="fl">1</span>,<span class="fl">0</span>),<span class="kw">mai</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.9</span>,<span class="fl">0.9</span>,<span class="fl">0.3</span>,<span class="fl">0.2</span>))
<span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">pred.rain</span>, <span class="st">"contour"</span>, <span class="kw">key.title</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html">title</a></span>(<span class="st">"TBN"</span>), <span class="kw">plot.title</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html">title</a></span>(<span class="st">"A"</span>, <span class="kw">xlab</span> <span class="kw">=</span><span class="st">"Weekly mean rainfall (mm)"</span>, <span class="kw">ylab</span> <span class="kw">=</span> <span class="st">"Weekly lag"</span>, <span class="kw">cex.lab</span><span class="kw">=</span><span class="fl">1</span>, <span class="kw">cex.axis</span><span class="kw">=</span><span class="fl">1</span>))</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-27-3.png" width="700"></p>
<div class="sourceCode" id="cb58"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">pred.rain</span>, <span class="st">"slices"</span>, <span class="kw">type</span><span class="kw">=</span><span class="st">"p"</span>, <span class="kw">pch</span><span class="kw">=</span><span class="fl">19</span>, <span class="kw">cex</span><span class="kw">=</span><span class="fl">1.3</span>, <span class="kw">var</span><span class="kw">=</span><span class="fl">18</span>, <span class="kw">col</span><span class="kw">=</span><span class="st">"purple"</span>, <span class="kw">ci.level</span><span class="kw">=</span><span class="fl">0.5</span>, <span class="kw">ci</span><span class="kw">=</span><span class="st">"bars"</span>, <span class="kw">ylab</span><span class="kw">=</span><span class="st">"Report ratio"</span>, <span class="kw">xlab</span><span class="kw">=</span><span class="st">"Weekly lag"</span>, <span class="kw">main</span><span class="kw">=</span><span class="st">"B"</span>)</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-27-4.png" width="700"></p>
<div class="sourceCode" id="cb59"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">pred.rain</span>, <span class="st">"slices"</span>, <span class="kw">type</span><span class="kw">=</span><span class="st">"p"</span>, <span class="kw">pch</span><span class="kw">=</span><span class="fl">19</span>, <span class="kw">cex</span><span class="kw">=</span><span class="fl">1.3</span>, <span class="kw">var</span><span class="kw">=</span><span class="fl">30</span>, <span class="kw">col</span><span class="kw">=</span><span class="st">"purple"</span>, <span class="kw">ci.level</span><span class="kw">=</span><span class="fl">0.5</span>, <span class="kw">ci</span><span class="kw">=</span><span class="st">"bars"</span>, <span class="kw">ylab</span><span class="kw">=</span><span class="st">"Report ratio"</span>, <span class="kw">xlab</span><span class="kw">=</span><span class="st">"Weekly lag"</span>, <span class="kw">main</span><span class="kw">=</span><span class="st">"C"</span>)</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-27-5.png" width="700"></p>
<div class="sourceCode" id="cb60"><html><body><pre class="r">
<span class="co">#plot 3D, countour and curves for temperature on TB notifications</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span>(<span class="kw">mgp</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">2.3</span>,<span class="fl">1</span>,<span class="fl">0</span>),<span class="kw">mai</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.9</span>,<span class="fl">0.9</span>,<span class="fl">0.3</span>,<span class="fl">0.2</span>))
<span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">pred.temp</span>, <span class="st">"contour"</span>, <span class="kw">key.title</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html">title</a></span>(<span class="st">"TBN"</span>), <span class="kw">plot.title</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html">title</a></span>(<span class="st">"D"</span>, <span class="kw">xlab</span> <span class="kw">=</span><span class="st">"Weekly mean temperature (°C)"</span>, <span class="kw">ylab</span> <span class="kw">=</span> <span class="st">"Weekly lag"</span>, <span class="kw">cex.lab</span><span class="kw">=</span><span class="fl">1</span>, <span class="kw">cex.axis</span><span class="kw">=</span><span class="fl">1</span>))</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-27-6.png" width="700"></p>
<div class="sourceCode" id="cb61"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">pred.temp</span>, <span class="st">"slices"</span>, <span class="kw">type</span><span class="kw">=</span><span class="st">"p"</span>, <span class="kw">pch</span><span class="kw">=</span><span class="fl">19</span>, <span class="kw">cex</span><span class="kw">=</span><span class="fl">1.3</span>, <span class="kw">var</span><span class="kw">=</span><span class="fl">20</span>, <span class="kw">col</span><span class="kw">=</span><span class="st">"red2"</span>, <span class="kw">ci.level</span><span class="kw">=</span><span class="fl">0.5</span>, <span class="kw">ci</span><span class="kw">=</span><span class="st">"bars"</span>, <span class="kw">ylab</span><span class="kw">=</span><span class="st">"Report ratio"</span>, <span class="kw">xlab</span><span class="kw">=</span><span class="st">"Weekly lag"</span>, <span class="kw">main</span><span class="kw">=</span><span class="st">"E"</span>)</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-27-7.png" width="700"></p>
<div class="sourceCode" id="cb62"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">pred.temp</span>, <span class="st">"slices"</span>, <span class="kw">type</span><span class="kw">=</span><span class="st">"p"</span>, <span class="kw">pch</span><span class="kw">=</span><span class="fl">19</span>, <span class="kw">cex</span><span class="kw">=</span><span class="fl">1.3</span>, <span class="kw">var</span><span class="kw">=</span><span class="fl">30</span>, <span class="kw">col</span><span class="kw">=</span><span class="st">"red2"</span>, <span class="kw">ci.level</span><span class="kw">=</span><span class="fl">0.5</span>, <span class="kw">ci</span><span class="kw">=</span><span class="st">"bars"</span>, <span class="kw">ylab</span><span class="kw">=</span><span class="st">"Report ratio"</span>, <span class="kw">xlab</span><span class="kw">=</span><span class="st">"Weekly lag"</span>, <span class="kw">main</span><span class="kw">=</span><span class="st">"F"</span>)</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-27-8.png" width="700"></p>
<p><br></p>
<p>Extract the data for combined plot</p>
<div class="sourceCode" id="cb63"><html><body><pre class="r"><span class="co">#rainfall</span>
<span class="no">c_rain</span> <span class="kw">&lt;-</span> <span class="no">pred.rain</span>$<span class="no">matRRfit</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu">rownames_to_column</span>(<span class="kw">var</span><span class="kw">=</span><span class="st">"var"</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">var</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">var</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">var</span><span class="kw">==</span><span class="fl">18</span> <span class="kw">|</span> <span class="no">var</span><span class="kw">==</span><span class="fl">30</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">comparison</span> <span class="kw">=</span> <span class="fu">case_when</span>(<span class="no">var</span><span class="kw">==</span><span class="fl">18</span> ~ <span class="st">"Mid (18mm) vs. low (0mm)"</span>,
                                <span class="no">var</span><span class="kw">==</span><span class="fl">30</span> ~ <span class="st">"High (30mm) vs. low (0mm)"</span>),
         <span class="kw">variable</span><span class="kw">=</span><span class="st">"Male"</span>,
         <span class="kw">model</span> <span class="kw">=</span> <span class="st">"Rainfall"</span>) <span class="kw">%&gt;%</span>
  <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> <span class="no">lag0</span>:<span class="no">lag20</span>)

<span class="no">c_rain_ci_lo</span> <span class="kw">&lt;-</span> <span class="no">pred.rain</span>$<span class="no">matRRlow</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu">rownames_to_column</span>(<span class="kw">var</span><span class="kw">=</span><span class="st">"var"</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">var</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">var</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">var</span><span class="kw">==</span><span class="fl">18</span> <span class="kw">|</span> <span class="no">var</span><span class="kw">==</span><span class="fl">30</span>) <span class="kw">%&gt;%</span>
  <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> <span class="no">lag0</span>:<span class="no">lag20</span>) <span class="kw">%&gt;%</span>
  <span class="fu">rename</span>(<span class="kw">ci_lo</span><span class="kw">=</span><span class="no">value</span>)

<span class="no">c_rain_ci_hi</span> <span class="kw">&lt;-</span> <span class="no">pred.rain</span>$<span class="no">matRRhigh</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu">rownames_to_column</span>(<span class="kw">var</span><span class="kw">=</span><span class="st">"var"</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">var</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">var</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">var</span><span class="kw">==</span><span class="fl">18</span> <span class="kw">|</span> <span class="no">var</span><span class="kw">==</span><span class="fl">30</span>) <span class="kw">%&gt;%</span>
  <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> <span class="no">lag0</span>:<span class="no">lag20</span>) <span class="kw">%&gt;%</span>
  <span class="fu">rename</span>(<span class="kw">ci_hi</span><span class="kw">=</span><span class="no">value</span>)

<span class="no">c1</span> <span class="kw">&lt;-</span> <span class="fu">left_join</span>(<span class="no">c_rain</span>, <span class="no">c_rain_ci_lo</span>)
<span class="no">c1</span> <span class="kw">&lt;-</span> <span class="fu">left_join</span>(<span class="no">c1</span>, <span class="no">c_rain_ci_hi</span>)

<span class="co">#temp</span>
<span class="no">c_temp</span> <span class="kw">&lt;-</span> <span class="no">pred.temp</span>$<span class="no">matRRfit</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu">rownames_to_column</span>(<span class="kw">var</span><span class="kw">=</span><span class="st">"var"</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">var</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">var</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">var</span><span class="kw">==</span><span class="fl">20</span> <span class="kw">|</span> <span class="no">var</span><span class="kw">==</span><span class="fl">30</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">comparison</span> <span class="kw">=</span> <span class="fu">case_when</span>(<span class="no">var</span><span class="kw">==</span><span class="fl">20</span> ~ <span class="st">"Mid (20°C) vs. low (17°C)"</span>,
                                <span class="no">var</span><span class="kw">==</span><span class="fl">30</span> ~ <span class="st">"High (30°C) vs. low (17°C)"</span>),
         <span class="kw">variable</span><span class="kw">=</span><span class="st">"Male"</span>,
         <span class="kw">model</span> <span class="kw">=</span> <span class="st">"Temperature"</span>) <span class="kw">%&gt;%</span>
  <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> <span class="no">lag0</span>:<span class="no">lag20</span>)

<span class="no">c_temp_ci_lo</span> <span class="kw">&lt;-</span> <span class="no">pred.temp</span>$<span class="no">matRRlow</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu">rownames_to_column</span>(<span class="kw">var</span><span class="kw">=</span><span class="st">"var"</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">var</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">var</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">var</span><span class="kw">==</span><span class="fl">20</span> <span class="kw">|</span> <span class="no">var</span><span class="kw">==</span><span class="fl">30</span>) <span class="kw">%&gt;%</span>
  <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> <span class="no">lag0</span>:<span class="no">lag20</span>) <span class="kw">%&gt;%</span>
  <span class="fu">rename</span>(<span class="kw">ci_lo</span><span class="kw">=</span><span class="no">value</span>)

<span class="no">c_temp_ci_hi</span> <span class="kw">&lt;-</span> <span class="no">pred.temp</span>$<span class="no">matRRhigh</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu">rownames_to_column</span>(<span class="kw">var</span><span class="kw">=</span><span class="st">"var"</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">var</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">var</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">var</span><span class="kw">==</span><span class="fl">20</span> <span class="kw">|</span> <span class="no">var</span><span class="kw">==</span><span class="fl">30</span>) <span class="kw">%&gt;%</span>
  <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> <span class="no">lag0</span>:<span class="no">lag20</span>) <span class="kw">%&gt;%</span>
  <span class="fu">rename</span>(<span class="kw">ci_hi</span><span class="kw">=</span><span class="no">value</span>)

<span class="no">c2</span> <span class="kw">&lt;-</span> <span class="fu">left_join</span>(<span class="no">c_temp</span>, <span class="no">c_temp_ci_lo</span>)
<span class="no">c2</span> <span class="kw">&lt;-</span> <span class="fu">left_join</span>(<span class="no">c2</span>, <span class="no">c_temp_ci_hi</span>)

<span class="no">c</span> <span class="kw">&lt;-</span> <span class="fu">bind_rows</span>(<span class="no">c1</span>, <span class="no">c2</span>)

<span class="no">c</span> <span class="kw">&lt;-</span> <span class="no">c</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">lag</span> <span class="kw">=</span> <span class="fu">parse_number</span>(<span class="no">name</span>))

<span class="no">c</span> <span class="kw">%&gt;%</span>
  <span class="fu">ggplot</span>() +
  <span class="fu">geom_pointrange</span>(<span class="fu">aes</span>(<span class="kw">x</span><span class="kw">=</span><span class="no">lag</span>, <span class="kw">y</span><span class="kw">=</span><span class="no">value</span>, <span class="kw">ymin</span><span class="kw">=</span><span class="no">ci_lo</span>, <span class="kw">ymax</span><span class="kw">=</span><span class="no">ci_hi</span>, <span class="kw">group</span><span class="kw">=</span><span class="no">comparison</span>, <span class="kw">colour</span><span class="kw">=</span><span class="no">comparison</span>),
                  <span class="kw">position</span><span class="kw">=</span><span class="fu">position_jitterdodge</span>()) +
  <span class="fu">facet_grid</span>(<span class="no">comparison</span>~<span class="no">model</span>)</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-28-1.png" width="700"></p>
<p><br></p>
<p>stratification by hiv negative reconstruct cross-basis functions for rainfall and temperature given the optimal DoF</p>
<div class="sourceCode" id="cb64"><html><body><pre class="r">
d_q_hiv0 &lt;- subset(d_q_hiv,hiv==0)

sort(d_q_hiv0$prcp, decreasing=FALSE)
  [1]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
  [7]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [13]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [19]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [25]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [31]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [37]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [43]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [49]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [55]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [61]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [67]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [73]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [79]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [85]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [91]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [97]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[103]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[109]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[115]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[121]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[127]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[133]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[139]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[145]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[151]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[157]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[163]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[169]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[175]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[181]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[187]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[193]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[199]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[205]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[211]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[217]  0.04285714  0.04285714  0.05000000  0.07142857  0.07500000  0.08333333
[223]  0.11428571  0.13333333  0.13333333  0.14285714  0.14285714  0.14285714
[229]  0.14285714  0.15714286  0.16666667  0.18571429  0.18571429  0.21428571
[235]  0.21666667  0.25000000  0.25000000  0.26666667  0.33333333  0.33333333
[241]  0.40000000  0.41666667  0.41666667  0.41666667  0.43333333  0.46666667
[247]  0.47142857  0.50000000  0.51428571  0.55000000  0.58000000  0.60000000
[253]  0.62000000  0.68571429  0.75714286  0.76000000  0.80000000  0.84285714
[259]  0.95000000  0.96000000  1.01428571  1.05000000  1.13333333  1.20000000
[265]  1.22000000  1.40000000  1.40000000  1.42000000  1.48333333  1.52857143
[271]  1.57142857  1.62857143  1.68333333  1.70000000  1.70000000  1.72000000
[277]  1.85000000  2.00000000  2.08000000  2.11666667  2.18000000  2.21428571
[283]  2.24000000  2.38000000  2.52500000  2.53333333  2.57142857  2.65000000
[289]  2.68571429  2.75000000  2.87142857  2.96666667  2.96666667  3.16666667
[295]  3.26666667  3.26666667  3.30000000  3.30000000  3.30000000  3.35000000
[301]  3.60000000  3.60000000  3.81428571  3.85000000  3.95000000  3.98333333
[307]  3.98333333  4.02000000  4.10000000  4.20000000  4.31666667  4.54285714
[313]  4.56666667  4.70000000  4.71428571  4.82000000  4.82500000  4.83333333
[319]  4.92000000  5.03333333  5.05000000  5.20000000  5.21428571  5.24000000
[325]  5.35000000  5.52857143  5.60000000  5.62857143  5.68333333  5.85000000
[331]  5.88333333  6.07142857  6.20000000  6.22500000  6.46666667  6.50000000
[337]  7.22500000  7.27142857  7.30000000  7.38333333  7.48333333  7.65714286
[343]  7.96000000  8.50000000  8.94285714  9.10000000  9.66666667  9.70000000
[349]  9.72000000  9.77500000 10.80000000 11.13333333 11.16000000 11.17500000
[355] 11.26666667 11.55000000 11.75000000 11.80000000 11.98571429 12.72857143
[361] 12.87500000 13.80000000 13.82500000 14.15714286 14.58571429 15.75000000
[367] 20.40000000 20.58571429 21.72500000 22.80000000 25.41428571 28.41428571
[373] 31.70000000
lagk=logknots(20, fun="ns", df=3)
vark=equalknots(d_q_hiv0$prcp, fun="ns", df=3)
cb.rain &lt;- crossbasis(d_q_hiv0$prcp, lag=20, argvar=list(knots=vark), arglag=list(knots=lagk))

sort(d_q_hiv0$temp, decreasing=FALSE)
  [1] 16.64286 17.90000 18.38571 18.53333 18.85714 18.96000 19.22857 19.25714
  [9] 19.52857 20.08571 20.16667 20.34286 20.41667 20.48333 20.58571 20.61667
 [17] 20.65714 20.67143 20.70000 20.77500 20.78571 20.96667 20.97143 21.03333
 [25] 21.04000 21.04286 21.07143 21.07143 21.10000 21.12857 21.18333 21.21429
 [33] 21.24286 21.27143 21.28000 21.33333 21.42000 21.45000 21.45714 21.47143
 [41] 21.55714 21.55714 21.56667 21.57143 21.58000 21.67143 21.71429 21.72857
 [49] 21.73333 21.74286 21.80000 21.81429 21.84286 21.87143 21.90000 21.90000
 [57] 21.91429 21.94286 22.08571 22.10000 22.22000 22.24286 22.24286 22.26667
 [65] 22.28000 22.28571 22.31429 22.33333 22.35714 22.40000 22.44286 22.47143
 [73] 22.50000 22.55714 22.56667 22.57143 22.57500 22.58571 22.58571 22.60000
 [81] 22.70000 22.75714 22.77143 22.78000 22.78571 22.80000 22.86667 22.95714
 [89] 22.98000 23.00000 23.02500 23.02857 23.06667 23.10000 23.10000 23.11429
 [97] 23.11429 23.22857 23.24286 23.28571 23.31429 23.31667 23.32857 23.34286
[105] 23.40000 23.40000 23.40000 23.41429 23.48000 23.48571 23.54286 23.67143
[113] 23.71429 23.71429 23.75000 23.77143 23.77500 23.82857 23.82857 23.87143
[121] 23.90000 23.90000 23.90000 23.95714 24.00000 24.00000 24.02857 24.05000
[129] 24.05000 24.08571 24.08571 24.11429 24.15714 24.20000 24.23333 24.25000
[137] 24.25000 24.25000 24.25714 24.30000 24.32857 24.32857 24.35714 24.37143
[145] 24.37500 24.37500 24.45714 24.48000 24.51429 24.52000 24.55714 24.57500
[153] 24.58000 24.61429 24.62857 24.65000 24.67143 24.70000 24.70000 24.73333
[161] 24.77143 24.78000 24.78333 24.80000 24.82500 24.86667 24.87143 24.87500
[169] 24.88571 24.90000 24.91667 24.93333 24.95714 24.98333 25.00000 25.00000
[177] 25.01667 25.03333 25.06000 25.08571 25.10000 25.10000 25.11429 25.12857
[185] 25.14286 25.15714 25.17143 25.20000 25.20000 25.20000 25.20000 25.22500
[193] 25.22857 25.25714 25.27500 25.30000 25.31429 25.34286 25.35000 25.35714
[201] 25.38571 25.40000 25.44286 25.53333 25.60000 25.60000 25.62857 25.62857
[209] 25.62857 25.64286 25.64286 25.64286 25.65000 25.68333 25.68571 25.70000
[217] 25.72857 25.75000 25.75714 25.76000 25.77143 25.78333 25.78571 25.78571
[225] 25.84286 25.86667 25.91429 25.92857 25.94286 25.98000 26.02500 26.03333
[233] 26.03333 26.04286 26.04286 26.08571 26.14000 26.15714 26.15714 26.16667
[241] 26.18333 26.18571 26.21429 26.21429 26.22000 26.22857 26.25000 26.25714
[249] 26.28000 26.33333 26.35000 26.41429 26.41667 26.41667 26.41667 26.42500
[257] 26.45000 26.47143 26.51429 26.53333 26.54286 26.60000 26.66667 26.67143
[265] 26.70000 26.71429 26.72857 26.76000 26.78571 26.80000 26.87143 26.87143
[273] 26.88571 26.92500 26.92857 26.94286 26.94286 26.95714 26.97143 27.00000
[281] 27.00000 27.01429 27.03333 27.05000 27.10000 27.21429 27.25714 27.27143
[289] 27.27143 27.27143 27.28333 27.28571 27.37143 27.40000 27.42857 27.45000
[297] 27.45714 27.54000 27.55000 27.61429 27.66000 27.75000 27.76000 27.77143
[305] 27.78571 27.80000 27.87143 27.87143 27.88333 27.98000 28.00000 28.00000
[313] 28.01429 28.02857 28.05714 28.05714 28.10000 28.16667 28.20000 28.22000
[321] 28.22857 28.25000 28.25714 28.25714 28.25714 28.27143 28.28333 28.32857
[329] 28.36000 28.36667 28.38571 28.45714 28.46667 28.48571 28.55000 28.57143
[337] 28.60000 28.60000 28.65714 28.66667 28.74286 28.77143 28.80000 28.87143
[345] 28.87500 28.97500 29.14286 29.16667 29.21667 29.25714 29.34000 29.43333
[353] 29.47143 29.61429 29.70000 29.71667 29.90000 30.02857 30.02857 30.05000
[361] 30.23333 30.26000 30.46667 30.74286 30.88000 30.96667 30.97143 31.25714
[369] 31.32857 31.52857 31.67143 32.20000 34.00000
lagk=logknots(20, fun="ns", df=3)
vark=equalknots(d_q_hiv0$temp, fun="ns", df=3)
cb.temp &lt;- crossbasis(d_q_hiv0$temp, lag=20, argvar=list(knots=vark), arglag=list(knots=lagk))

#fit two models for rainfall and temperature seperately in generalised linear framework
model.r &lt;- glm(ncase ~ cb.rain + wk + year, family=quasipoisson(), na.action=na.exclude, d_q_hiv0)
model.t &lt;- glm(ncase ~ cb.temp + wk + year, family=quasipoisson(), na.action=na.exclude, d_q_hiv0)

#validate rainfall model by minimising high partial/auto-correlation (outside blue dotted lines)
pacf(residuals(model.r,type="deviance"),na.action=na.omit,main="Partial autocorrelation",xlim=c(0,20))</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-29-1.png" width="700"></p>
<div class="sourceCode" id="cb65"><html><body><pre class="r"><span class="no">model.r</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span>(<span class="no">model.r</span>,<span class="no">.</span>~<span class="no">.</span>+<span class="fu"><a href="https://rdrr.io/r/stats/lag.html">lag</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span>(<span class="no">model.r</span>,<span class="kw">type</span><span class="kw">=</span><span class="st">"deviance"</span>),<span class="fl">1</span>))
<span class="no">model.r</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span>(<span class="no">model.r</span>,<span class="no">.</span>~<span class="no">.</span>+<span class="fu"><a href="https://rdrr.io/r/stats/lag.html">lag</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span>(<span class="no">model.r</span>,<span class="kw">type</span><span class="kw">=</span><span class="st">"deviance"</span>),<span class="fl">2</span>))

<span class="co">#validate temperature model by minimising high partial/auto-correlation (outside blue dotted lines)</span>
<span class="fu"><a href="https://rdrr.io/r/stats/acf.html">pacf</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span>(<span class="no">model.t</span>,<span class="kw">type</span><span class="kw">=</span><span class="st">"deviance"</span>),<span class="kw">na.action</span><span class="kw">=</span><span class="no">na.omit</span>,<span class="kw">main</span><span class="kw">=</span><span class="st">"Partial autocorrelation"</span>,<span class="kw">xlim</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>,<span class="fl">20</span>))</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-29-2.png" width="700"></p>
<div class="sourceCode" id="cb66"><html><body><pre class="r"><span class="no">model.t</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span>(<span class="no">model.t</span>,<span class="no">.</span>~<span class="no">.</span>+<span class="fu"><a href="https://rdrr.io/r/stats/lag.html">lag</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span>(<span class="no">model.t</span>,<span class="kw">type</span><span class="kw">=</span><span class="st">"deviance"</span>),<span class="fl">2</span>))

<span class="co">#predict (nowcast) the effect on TB notification of rainfall/temperature</span>
<span class="no">pred.rain</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/dlnm/man/crosspred.html">crosspred</a></span>(<span class="no">cb.rain</span>, <span class="no">model.r</span>, <span class="kw">cen</span><span class="kw">=</span><span class="fl">0</span>, <span class="kw">by</span><span class="kw">=</span><span class="fl">0.2</span>)
<span class="no">pred.temp</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/dlnm/man/crosspred.html">crosspred</a></span>(<span class="no">cb.temp</span>, <span class="no">model.t</span>, <span class="kw">cen</span><span class="kw">=</span><span class="fl">17</span>, <span class="kw">by</span><span class="kw">=</span><span class="fl">0.2</span>)

<span class="co">#plot 3D, countour and curves for rainfall on TB notifications</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span>(<span class="kw">mgp</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">2.3</span>,<span class="fl">1</span>,<span class="fl">0</span>),<span class="kw">mai</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.9</span>,<span class="fl">0.9</span>,<span class="fl">0.3</span>,<span class="fl">0.2</span>))
<span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">pred.rain</span>, <span class="st">"contour"</span>, <span class="kw">key.title</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html">title</a></span>(<span class="st">"TBN"</span>), <span class="kw">plot.title</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html">title</a></span>(<span class="st">"A"</span>, <span class="kw">xlab</span> <span class="kw">=</span><span class="st">"Weekly mean rainfall (mm)"</span>, <span class="kw">ylab</span> <span class="kw">=</span> <span class="st">"Weekly lag"</span>, <span class="kw">cex.lab</span><span class="kw">=</span><span class="fl">1</span>, <span class="kw">cex.axis</span><span class="kw">=</span><span class="fl">1</span>))</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-29-3.png" width="700"></p>
<div class="sourceCode" id="cb67"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">pred.rain</span>, <span class="st">"slices"</span>, <span class="kw">type</span><span class="kw">=</span><span class="st">"p"</span>, <span class="kw">pch</span><span class="kw">=</span><span class="fl">19</span>, <span class="kw">cex</span><span class="kw">=</span><span class="fl">1.3</span>, <span class="kw">var</span><span class="kw">=</span><span class="fl">18</span>, <span class="kw">col</span><span class="kw">=</span><span class="st">"purple"</span>, <span class="kw">ci.level</span><span class="kw">=</span><span class="fl">0.5</span>, <span class="kw">ci</span><span class="kw">=</span><span class="st">"bars"</span>, <span class="kw">ylab</span><span class="kw">=</span><span class="st">"Report ratio"</span>, <span class="kw">xlab</span><span class="kw">=</span><span class="st">"Weekly lag"</span>, <span class="kw">main</span><span class="kw">=</span><span class="st">"B"</span>)</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-29-4.png" width="700"></p>
<div class="sourceCode" id="cb68"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">pred.rain</span>, <span class="st">"slices"</span>, <span class="kw">type</span><span class="kw">=</span><span class="st">"p"</span>, <span class="kw">pch</span><span class="kw">=</span><span class="fl">19</span>, <span class="kw">cex</span><span class="kw">=</span><span class="fl">1.3</span>, <span class="kw">var</span><span class="kw">=</span><span class="fl">30</span>, <span class="kw">col</span><span class="kw">=</span><span class="st">"purple"</span>, <span class="kw">ci.level</span><span class="kw">=</span><span class="fl">0.5</span>, <span class="kw">ci</span><span class="kw">=</span><span class="st">"bars"</span>, <span class="kw">ylab</span><span class="kw">=</span><span class="st">"Report ratio"</span>, <span class="kw">xlab</span><span class="kw">=</span><span class="st">"Weekly lag"</span>, <span class="kw">main</span><span class="kw">=</span><span class="st">"C"</span>)</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-29-5.png" width="700"></p>
<div class="sourceCode" id="cb69"><html><body><pre class="r">
<span class="co">#plot 3D, countour and curves for temperature on TB notifications</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span>(<span class="kw">mgp</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">2.3</span>,<span class="fl">1</span>,<span class="fl">0</span>),<span class="kw">mai</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.9</span>,<span class="fl">0.9</span>,<span class="fl">0.3</span>,<span class="fl">0.2</span>))
<span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">pred.temp</span>, <span class="st">"contour"</span>, <span class="kw">key.title</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html">title</a></span>(<span class="st">"TBN"</span>), <span class="kw">plot.title</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html">title</a></span>(<span class="st">"D"</span>, <span class="kw">xlab</span> <span class="kw">=</span><span class="st">"Weekly mean temperature (°C)"</span>, <span class="kw">ylab</span> <span class="kw">=</span> <span class="st">"Weekly lag"</span>, <span class="kw">cex.lab</span><span class="kw">=</span><span class="fl">1</span>, <span class="kw">cex.axis</span><span class="kw">=</span><span class="fl">1</span>))</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-29-6.png" width="700"></p>
<div class="sourceCode" id="cb70"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">pred.temp</span>, <span class="st">"slices"</span>, <span class="kw">type</span><span class="kw">=</span><span class="st">"p"</span>, <span class="kw">pch</span><span class="kw">=</span><span class="fl">19</span>, <span class="kw">cex</span><span class="kw">=</span><span class="fl">1.3</span>, <span class="kw">var</span><span class="kw">=</span><span class="fl">20</span>, <span class="kw">col</span><span class="kw">=</span><span class="st">"red2"</span>, <span class="kw">ci.level</span><span class="kw">=</span><span class="fl">0.5</span>, <span class="kw">ci</span><span class="kw">=</span><span class="st">"bars"</span>, <span class="kw">ylab</span><span class="kw">=</span><span class="st">"Report ratio"</span>, <span class="kw">xlab</span><span class="kw">=</span><span class="st">"Weekly lag"</span>, <span class="kw">main</span><span class="kw">=</span><span class="st">"E"</span>)</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-29-7.png" width="700"></p>
<div class="sourceCode" id="cb71"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">pred.temp</span>, <span class="st">"slices"</span>, <span class="kw">type</span><span class="kw">=</span><span class="st">"p"</span>, <span class="kw">pch</span><span class="kw">=</span><span class="fl">19</span>, <span class="kw">cex</span><span class="kw">=</span><span class="fl">1.3</span>, <span class="kw">var</span><span class="kw">=</span><span class="fl">30</span>, <span class="kw">col</span><span class="kw">=</span><span class="st">"red2"</span>, <span class="kw">ci.level</span><span class="kw">=</span><span class="fl">0.5</span>, <span class="kw">ci</span><span class="kw">=</span><span class="st">"bars"</span>, <span class="kw">ylab</span><span class="kw">=</span><span class="st">"Report ratio"</span>, <span class="kw">xlab</span><span class="kw">=</span><span class="st">"Weekly lag"</span>, <span class="kw">main</span><span class="kw">=</span><span class="st">"F"</span>)</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-29-8.png" width="700"></p>
<p><br></p>
<p>Extract the data for combined plot</p>
<div class="sourceCode" id="cb72"><html><body><pre class="r"><span class="co">#rainfall</span>
<span class="no">d_rain</span> <span class="kw">&lt;-</span> <span class="no">pred.rain</span>$<span class="no">matRRfit</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu">rownames_to_column</span>(<span class="kw">var</span><span class="kw">=</span><span class="st">"var"</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">var</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">var</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">var</span><span class="kw">==</span><span class="fl">18</span> <span class="kw">|</span> <span class="no">var</span><span class="kw">==</span><span class="fl">30</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">comparison</span> <span class="kw">=</span> <span class="fu">case_when</span>(<span class="no">var</span><span class="kw">==</span><span class="fl">18</span> ~ <span class="st">"Mid (18mm) vs. low (0mm)"</span>,
                                <span class="no">var</span><span class="kw">==</span><span class="fl">30</span> ~ <span class="st">"High (30mm) vs. low (0mm)"</span>),
         <span class="kw">variable</span><span class="kw">=</span><span class="st">"HIV-negative"</span>,
         <span class="kw">model</span> <span class="kw">=</span> <span class="st">"Rainfall"</span>) <span class="kw">%&gt;%</span>
  <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> <span class="no">lag0</span>:<span class="no">lag20</span>)

<span class="no">d_rain_ci_lo</span> <span class="kw">&lt;-</span> <span class="no">pred.rain</span>$<span class="no">matRRlow</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu">rownames_to_column</span>(<span class="kw">var</span><span class="kw">=</span><span class="st">"var"</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">var</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">var</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">var</span><span class="kw">==</span><span class="fl">18</span> <span class="kw">|</span> <span class="no">var</span><span class="kw">==</span><span class="fl">30</span>) <span class="kw">%&gt;%</span>
  <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> <span class="no">lag0</span>:<span class="no">lag20</span>) <span class="kw">%&gt;%</span>
  <span class="fu">rename</span>(<span class="kw">ci_lo</span><span class="kw">=</span><span class="no">value</span>)

<span class="no">d_rain_ci_hi</span> <span class="kw">&lt;-</span> <span class="no">pred.rain</span>$<span class="no">matRRhigh</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu">rownames_to_column</span>(<span class="kw">var</span><span class="kw">=</span><span class="st">"var"</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">var</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">var</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">var</span><span class="kw">==</span><span class="fl">18</span> <span class="kw">|</span> <span class="no">var</span><span class="kw">==</span><span class="fl">30</span>) <span class="kw">%&gt;%</span>
  <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> <span class="no">lag0</span>:<span class="no">lag20</span>) <span class="kw">%&gt;%</span>
  <span class="fu">rename</span>(<span class="kw">ci_hi</span><span class="kw">=</span><span class="no">value</span>)

<span class="no">d1</span> <span class="kw">&lt;-</span> <span class="fu">left_join</span>(<span class="no">d_rain</span>, <span class="no">d_rain_ci_lo</span>)
<span class="no">d1</span> <span class="kw">&lt;-</span> <span class="fu">left_join</span>(<span class="no">d1</span>, <span class="no">d_rain_ci_hi</span>)

<span class="co">#temp</span>
<span class="no">d_temp</span> <span class="kw">&lt;-</span> <span class="no">pred.temp</span>$<span class="no">matRRfit</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu">rownames_to_column</span>(<span class="kw">var</span><span class="kw">=</span><span class="st">"var"</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">var</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">var</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">var</span><span class="kw">==</span><span class="fl">20</span> <span class="kw">|</span> <span class="no">var</span><span class="kw">==</span><span class="fl">30</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">comparison</span> <span class="kw">=</span> <span class="fu">case_when</span>(<span class="no">var</span><span class="kw">==</span><span class="fl">20</span> ~ <span class="st">"Mid (20°C) vs. low (17°C)"</span>,
                                <span class="no">var</span><span class="kw">==</span><span class="fl">30</span> ~ <span class="st">"High (30°C) vs. low (17°C)"</span>),
         <span class="kw">variable</span><span class="kw">=</span><span class="st">"HIV-negative"</span>,
         <span class="kw">model</span> <span class="kw">=</span> <span class="st">"Temperature"</span>) <span class="kw">%&gt;%</span>
  <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> <span class="no">lag0</span>:<span class="no">lag20</span>)

<span class="no">d_temp_ci_lo</span> <span class="kw">&lt;-</span> <span class="no">pred.temp</span>$<span class="no">matRRlow</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu">rownames_to_column</span>(<span class="kw">var</span><span class="kw">=</span><span class="st">"var"</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">var</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">var</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">var</span><span class="kw">==</span><span class="fl">20</span> <span class="kw">|</span> <span class="no">var</span><span class="kw">==</span><span class="fl">30</span>) <span class="kw">%&gt;%</span>
  <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> <span class="no">lag0</span>:<span class="no">lag20</span>) <span class="kw">%&gt;%</span>
  <span class="fu">rename</span>(<span class="kw">ci_lo</span><span class="kw">=</span><span class="no">value</span>)

<span class="no">d_temp_ci_hi</span> <span class="kw">&lt;-</span> <span class="no">pred.temp</span>$<span class="no">matRRhigh</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu">rownames_to_column</span>(<span class="kw">var</span><span class="kw">=</span><span class="st">"var"</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">var</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">var</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">var</span><span class="kw">==</span><span class="fl">20</span> <span class="kw">|</span> <span class="no">var</span><span class="kw">==</span><span class="fl">30</span>) <span class="kw">%&gt;%</span>
  <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> <span class="no">lag0</span>:<span class="no">lag20</span>) <span class="kw">%&gt;%</span>
  <span class="fu">rename</span>(<span class="kw">ci_hi</span><span class="kw">=</span><span class="no">value</span>)

<span class="no">d2</span> <span class="kw">&lt;-</span> <span class="fu">left_join</span>(<span class="no">d_temp</span>, <span class="no">d_temp_ci_lo</span>)
<span class="no">d2</span> <span class="kw">&lt;-</span> <span class="fu">left_join</span>(<span class="no">d2</span>, <span class="no">d_temp_ci_hi</span>)

<span class="no">d</span> <span class="kw">&lt;-</span> <span class="fu">bind_rows</span>(<span class="no">d1</span>, <span class="no">d2</span>)

<span class="no">d</span> <span class="kw">&lt;-</span> <span class="no">d</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">lag</span> <span class="kw">=</span> <span class="fu">parse_number</span>(<span class="no">name</span>))

<span class="no">d</span> <span class="kw">%&gt;%</span>
  <span class="fu">ggplot</span>() +
  <span class="fu">geom_pointrange</span>(<span class="fu">aes</span>(<span class="kw">x</span><span class="kw">=</span><span class="no">lag</span>, <span class="kw">y</span><span class="kw">=</span><span class="no">value</span>, <span class="kw">ymin</span><span class="kw">=</span><span class="no">ci_lo</span>, <span class="kw">ymax</span><span class="kw">=</span><span class="no">ci_hi</span>, <span class="kw">group</span><span class="kw">=</span><span class="no">comparison</span>, <span class="kw">colour</span><span class="kw">=</span><span class="no">comparison</span>),
                  <span class="kw">position</span><span class="kw">=</span><span class="fu">position_jitterdodge</span>()) +
  <span class="fu">facet_grid</span>(<span class="no">comparison</span>~<span class="no">model</span>)</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-30-1.png" width="700"></p>
<p><br></p>
<p>Stratification by HIV positive reconstruct cross-basis functions for rainfall and temperature given the optimal DoF</p>
<div class="sourceCode" id="cb73"><html><body><pre class="r">d_q_hiv1 &lt;- subset(d_q_hiv,hiv==1)

sort(d_q_hiv1$prcp, decreasing=FALSE)
  [1]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
  [7]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [13]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [19]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [25]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [31]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [37]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [43]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [49]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [55]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [61]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [67]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [73]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [79]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [85]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [91]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [97]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[103]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[109]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[115]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[121]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[127]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[133]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[139]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[145]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[151]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[157]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[163]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[169]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[175]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[181]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[187]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[193]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[199]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[205]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[211]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[217]  0.04285714  0.04285714  0.05000000  0.07142857  0.07500000  0.08333333
[223]  0.11428571  0.13333333  0.13333333  0.14285714  0.14285714  0.14285714
[229]  0.14285714  0.15714286  0.16666667  0.18571429  0.18571429  0.21428571
[235]  0.21666667  0.25000000  0.25000000  0.26666667  0.33333333  0.33333333
[241]  0.40000000  0.41666667  0.41666667  0.41666667  0.43333333  0.46666667
[247]  0.47142857  0.50000000  0.51428571  0.55000000  0.58000000  0.60000000
[253]  0.62000000  0.68571429  0.75714286  0.76000000  0.80000000  0.84285714
[259]  0.95000000  0.96000000  1.01428571  1.05000000  1.13333333  1.20000000
[265]  1.22000000  1.40000000  1.40000000  1.42000000  1.48333333  1.52857143
[271]  1.57142857  1.62857143  1.68333333  1.70000000  1.70000000  1.72000000
[277]  1.85000000  2.00000000  2.08000000  2.11666667  2.18000000  2.21428571
[283]  2.24000000  2.38000000  2.52500000  2.53333333  2.57142857  2.65000000
[289]  2.68571429  2.75000000  2.87142857  2.96666667  2.96666667  3.16666667
[295]  3.26666667  3.26666667  3.30000000  3.30000000  3.30000000  3.35000000
[301]  3.60000000  3.60000000  3.81428571  3.85000000  3.95000000  3.98333333
[307]  3.98333333  4.02000000  4.10000000  4.20000000  4.31666667  4.54285714
[313]  4.56666667  4.70000000  4.71428571  4.82000000  4.82500000  4.83333333
[319]  4.92000000  5.03333333  5.05000000  5.20000000  5.21428571  5.24000000
[325]  5.35000000  5.52857143  5.60000000  5.62857143  5.68333333  5.85000000
[331]  5.88333333  6.07142857  6.20000000  6.22500000  6.46666667  6.50000000
[337]  7.22500000  7.27142857  7.30000000  7.38333333  7.48333333  7.65714286
[343]  7.96000000  8.50000000  8.94285714  9.10000000  9.66666667  9.70000000
[349]  9.72000000  9.77500000 10.80000000 11.13333333 11.16000000 11.17500000
[355] 11.26666667 11.55000000 11.75000000 11.80000000 11.98571429 12.72857143
[361] 12.87500000 13.80000000 13.82500000 14.15714286 14.58571429 15.75000000
[367] 20.40000000 20.58571429 21.72500000 22.80000000 25.41428571 28.41428571
[373] 31.70000000
lagk=logknots(20, fun="ns", df=3)
vark=equalknots(d_q_hiv1$prcp, fun="ns", df=3)
cb.rain &lt;- crossbasis(d_q_hiv1$prcp, lag=20, argvar=list(knots=vark), arglag=list(knots=lagk))

sort(d_q_hiv1$temp, decreasing=FALSE)
  [1] 16.64286 17.90000 18.38571 18.53333 18.85714 18.96000 19.22857 19.25714
  [9] 19.52857 20.08571 20.16667 20.34286 20.41667 20.48333 20.58571 20.61667
 [17] 20.65714 20.67143 20.70000 20.77500 20.78571 20.96667 20.97143 21.03333
 [25] 21.04000 21.04286 21.07143 21.07143 21.10000 21.12857 21.18333 21.21429
 [33] 21.24286 21.27143 21.28000 21.33333 21.42000 21.45000 21.45714 21.47143
 [41] 21.55714 21.55714 21.56667 21.57143 21.58000 21.67143 21.71429 21.72857
 [49] 21.73333 21.74286 21.80000 21.81429 21.84286 21.87143 21.90000 21.90000
 [57] 21.91429 21.94286 22.08571 22.10000 22.22000 22.24286 22.24286 22.26667
 [65] 22.28000 22.28571 22.31429 22.33333 22.35714 22.40000 22.44286 22.47143
 [73] 22.50000 22.55714 22.56667 22.57143 22.57500 22.58571 22.58571 22.60000
 [81] 22.70000 22.75714 22.77143 22.78000 22.78571 22.80000 22.86667 22.95714
 [89] 22.98000 23.00000 23.02500 23.02857 23.06667 23.10000 23.10000 23.11429
 [97] 23.11429 23.22857 23.24286 23.28571 23.31429 23.31667 23.32857 23.34286
[105] 23.40000 23.40000 23.40000 23.41429 23.48000 23.48571 23.54286 23.67143
[113] 23.71429 23.71429 23.75000 23.77143 23.77500 23.82857 23.82857 23.87143
[121] 23.90000 23.90000 23.90000 23.95714 24.00000 24.00000 24.02857 24.05000
[129] 24.05000 24.08571 24.08571 24.11429 24.15714 24.20000 24.23333 24.25000
[137] 24.25000 24.25000 24.25714 24.30000 24.32857 24.32857 24.35714 24.37143
[145] 24.37500 24.37500 24.45714 24.48000 24.51429 24.52000 24.55714 24.57500
[153] 24.58000 24.61429 24.62857 24.65000 24.67143 24.70000 24.70000 24.73333
[161] 24.77143 24.78000 24.78333 24.80000 24.82500 24.86667 24.87143 24.87500
[169] 24.88571 24.90000 24.91667 24.93333 24.95714 24.98333 25.00000 25.00000
[177] 25.01667 25.03333 25.06000 25.08571 25.10000 25.10000 25.11429 25.12857
[185] 25.14286 25.15714 25.17143 25.20000 25.20000 25.20000 25.20000 25.22500
[193] 25.22857 25.25714 25.27500 25.30000 25.31429 25.34286 25.35000 25.35714
[201] 25.38571 25.40000 25.44286 25.53333 25.60000 25.60000 25.62857 25.62857
[209] 25.62857 25.64286 25.64286 25.64286 25.65000 25.68333 25.68571 25.70000
[217] 25.72857 25.75000 25.75714 25.76000 25.77143 25.78333 25.78571 25.78571
[225] 25.84286 25.86667 25.91429 25.92857 25.94286 25.98000 26.02500 26.03333
[233] 26.03333 26.04286 26.04286 26.08571 26.14000 26.15714 26.15714 26.16667
[241] 26.18333 26.18571 26.21429 26.21429 26.22000 26.22857 26.25000 26.25714
[249] 26.28000 26.33333 26.35000 26.41429 26.41667 26.41667 26.41667 26.42500
[257] 26.45000 26.47143 26.51429 26.53333 26.54286 26.60000 26.66667 26.67143
[265] 26.70000 26.71429 26.72857 26.76000 26.78571 26.80000 26.87143 26.87143
[273] 26.88571 26.92500 26.92857 26.94286 26.94286 26.95714 26.97143 27.00000
[281] 27.00000 27.01429 27.03333 27.05000 27.10000 27.21429 27.25714 27.27143
[289] 27.27143 27.27143 27.28333 27.28571 27.37143 27.40000 27.42857 27.45000
[297] 27.45714 27.54000 27.55000 27.61429 27.66000 27.75000 27.76000 27.77143
[305] 27.78571 27.80000 27.87143 27.87143 27.88333 27.98000 28.00000 28.00000
[313] 28.01429 28.02857 28.05714 28.05714 28.10000 28.16667 28.20000 28.22000
[321] 28.22857 28.25000 28.25714 28.25714 28.25714 28.27143 28.28333 28.32857
[329] 28.36000 28.36667 28.38571 28.45714 28.46667 28.48571 28.55000 28.57143
[337] 28.60000 28.60000 28.65714 28.66667 28.74286 28.77143 28.80000 28.87143
[345] 28.87500 28.97500 29.14286 29.16667 29.21667 29.25714 29.34000 29.43333
[353] 29.47143 29.61429 29.70000 29.71667 29.90000 30.02857 30.02857 30.05000
[361] 30.23333 30.26000 30.46667 30.74286 30.88000 30.96667 30.97143 31.25714
[369] 31.32857 31.52857 31.67143 32.20000 34.00000
lagk=logknots(20, fun="ns", df=3)
vark=equalknots(d_q_hiv1$temp, fun="ns", df=3)
cb.temp &lt;- crossbasis(d_q_hiv1$temp, lag=20, argvar=list(knots=vark), arglag=list(knots=lagk))

#fit two models for rainfall and temperature seperately in generalised linear framework
model.r &lt;- glm(ncase ~ cb.rain + wk + year, family=quasipoisson(), na.action=na.exclude, d_q_hiv1)
model.t &lt;- glm(ncase ~ cb.temp + wk + year, family=quasipoisson(), na.action=na.exclude, d_q_hiv1)

#validate rainfall model by minimising high partial/auto-correlation (outside blue dotted lines)
pacf(residuals(model.r,type="deviance"),na.action=na.omit,main="Partial autocorrelation",xlim=c(0,20))</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-31-1.png" width="700"></p>
<div class="sourceCode" id="cb74"><html><body><pre class="r"><span class="no">model.r</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span>(<span class="no">model.r</span>,<span class="no">.</span>~<span class="no">.</span>+<span class="fu"><a href="https://rdrr.io/r/stats/lag.html">lag</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span>(<span class="no">model.r</span>,<span class="kw">type</span><span class="kw">=</span><span class="st">"deviance"</span>),<span class="fl">2</span>))
<span class="no">model.r</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span>(<span class="no">model.r</span>,<span class="no">.</span>~<span class="no">.</span>+<span class="fu"><a href="https://rdrr.io/r/stats/lag.html">lag</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span>(<span class="no">model.r</span>,<span class="kw">type</span><span class="kw">=</span><span class="st">"deviance"</span>),<span class="fl">14</span>))

<span class="co">#validate temperature model by minimising high partial/auto-correlation (outside blue dotted lines)</span>
<span class="fu"><a href="https://rdrr.io/r/stats/acf.html">pacf</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span>(<span class="no">model.t</span>,<span class="kw">type</span><span class="kw">=</span><span class="st">"deviance"</span>),<span class="kw">na.action</span><span class="kw">=</span><span class="no">na.omit</span>,<span class="kw">main</span><span class="kw">=</span><span class="st">"Partial autocorrelation"</span>,<span class="kw">xlim</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>,<span class="fl">20</span>))</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-31-2.png" width="700"></p>
<div class="sourceCode" id="cb75"><html><body><pre class="r"><span class="no">model.t</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span>(<span class="no">model.t</span>,<span class="no">.</span>~<span class="no">.</span>+<span class="fu"><a href="https://rdrr.io/r/stats/lag.html">lag</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span>(<span class="no">model.t</span>,<span class="kw">type</span><span class="kw">=</span><span class="st">"deviance"</span>),<span class="fl">2</span>))
<span class="no">model.t</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span>(<span class="no">model.t</span>,<span class="no">.</span>~<span class="no">.</span>+<span class="fu"><a href="https://rdrr.io/r/stats/lag.html">lag</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span>(<span class="no">model.t</span>,<span class="kw">type</span><span class="kw">=</span><span class="st">"deviance"</span>),<span class="fl">14</span>))

<span class="co">#predict (nowcast) the effect on TB notification of rainfall/temperature</span>
<span class="no">pred.rain</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/dlnm/man/crosspred.html">crosspred</a></span>(<span class="no">cb.rain</span>, <span class="no">model.r</span>, <span class="kw">cen</span><span class="kw">=</span><span class="fl">0</span>, <span class="kw">by</span><span class="kw">=</span><span class="fl">0.2</span>)
<span class="no">pred.temp</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/dlnm/man/crosspred.html">crosspred</a></span>(<span class="no">cb.temp</span>, <span class="no">model.t</span>, <span class="kw">cen</span><span class="kw">=</span><span class="fl">17</span>, <span class="kw">by</span><span class="kw">=</span><span class="fl">0.2</span>)

<span class="co">#plot 3D, countour and curves for rainfall on TB notifications</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span>(<span class="kw">mgp</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">2.3</span>,<span class="fl">1</span>,<span class="fl">0</span>),<span class="kw">mai</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.9</span>,<span class="fl">0.9</span>,<span class="fl">0.3</span>,<span class="fl">0.2</span>))
<span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">pred.rain</span>, <span class="st">"contour"</span>, <span class="kw">key.title</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html">title</a></span>(<span class="st">"TBN"</span>), <span class="kw">plot.title</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html">title</a></span>(<span class="st">"A"</span>, <span class="kw">xlab</span> <span class="kw">=</span><span class="st">"Weekly mean rainfall (mm)"</span>, <span class="kw">ylab</span> <span class="kw">=</span> <span class="st">"Weekly lag"</span>, <span class="kw">cex.lab</span><span class="kw">=</span><span class="fl">1</span>, <span class="kw">cex.axis</span><span class="kw">=</span><span class="fl">1</span>))</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-31-3.png" width="700"></p>
<div class="sourceCode" id="cb76"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">pred.rain</span>, <span class="st">"slices"</span>, <span class="kw">type</span><span class="kw">=</span><span class="st">"p"</span>, <span class="kw">pch</span><span class="kw">=</span><span class="fl">19</span>, <span class="kw">cex</span><span class="kw">=</span><span class="fl">1.3</span>, <span class="kw">var</span><span class="kw">=</span><span class="fl">18</span>, <span class="kw">col</span><span class="kw">=</span><span class="st">"purple"</span>, <span class="kw">ci.level</span><span class="kw">=</span><span class="fl">0.5</span>, <span class="kw">ci</span><span class="kw">=</span><span class="st">"bars"</span>, <span class="kw">ylab</span><span class="kw">=</span><span class="st">"Report ratio"</span>, <span class="kw">xlab</span><span class="kw">=</span><span class="st">"Weekly lag"</span>, <span class="kw">main</span><span class="kw">=</span><span class="st">"B"</span>)</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-31-4.png" width="700"></p>
<div class="sourceCode" id="cb77"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">pred.rain</span>, <span class="st">"slices"</span>, <span class="kw">type</span><span class="kw">=</span><span class="st">"p"</span>, <span class="kw">pch</span><span class="kw">=</span><span class="fl">19</span>, <span class="kw">cex</span><span class="kw">=</span><span class="fl">1.3</span>, <span class="kw">var</span><span class="kw">=</span><span class="fl">30</span>, <span class="kw">col</span><span class="kw">=</span><span class="st">"purple"</span>, <span class="kw">ci.level</span><span class="kw">=</span><span class="fl">0.5</span>, <span class="kw">ci</span><span class="kw">=</span><span class="st">"bars"</span>, <span class="kw">ylab</span><span class="kw">=</span><span class="st">"Report ratio"</span>, <span class="kw">xlab</span><span class="kw">=</span><span class="st">"Weekly lag"</span>, <span class="kw">main</span><span class="kw">=</span><span class="st">"C"</span>)</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-31-5.png" width="700"></p>
<div class="sourceCode" id="cb78"><html><body><pre class="r">
<span class="co">#plot 3D, countour and curves for temperature on TB notifications</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span>(<span class="kw">mgp</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">2.3</span>,<span class="fl">1</span>,<span class="fl">0</span>),<span class="kw">mai</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.9</span>,<span class="fl">0.9</span>,<span class="fl">0.3</span>,<span class="fl">0.2</span>))
<span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">pred.temp</span>, <span class="st">"contour"</span>, <span class="kw">key.title</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html">title</a></span>(<span class="st">"TBN"</span>), <span class="kw">plot.title</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html">title</a></span>(<span class="st">"D"</span>, <span class="kw">xlab</span> <span class="kw">=</span><span class="st">"Weekly mean temperature (°C)"</span>, <span class="kw">ylab</span> <span class="kw">=</span> <span class="st">"Weekly lag"</span>, <span class="kw">cex.lab</span><span class="kw">=</span><span class="fl">1</span>, <span class="kw">cex.axis</span><span class="kw">=</span><span class="fl">1</span>))</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-31-6.png" width="700"></p>
<div class="sourceCode" id="cb79"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">pred.temp</span>, <span class="st">"slices"</span>, <span class="kw">type</span><span class="kw">=</span><span class="st">"p"</span>, <span class="kw">pch</span><span class="kw">=</span><span class="fl">19</span>, <span class="kw">cex</span><span class="kw">=</span><span class="fl">1.3</span>, <span class="kw">var</span><span class="kw">=</span><span class="fl">20</span>, <span class="kw">col</span><span class="kw">=</span><span class="st">"red2"</span>, <span class="kw">ci.level</span><span class="kw">=</span><span class="fl">0.5</span>, <span class="kw">ci</span><span class="kw">=</span><span class="st">"bars"</span>, <span class="kw">ylab</span><span class="kw">=</span><span class="st">"Report ratio"</span>, <span class="kw">xlab</span><span class="kw">=</span><span class="st">"Weekly lag"</span>, <span class="kw">main</span><span class="kw">=</span><span class="st">"E"</span>)</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-31-7.png" width="700"></p>
<div class="sourceCode" id="cb80"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">pred.temp</span>, <span class="st">"slices"</span>, <span class="kw">type</span><span class="kw">=</span><span class="st">"p"</span>, <span class="kw">pch</span><span class="kw">=</span><span class="fl">19</span>, <span class="kw">cex</span><span class="kw">=</span><span class="fl">1.3</span>, <span class="kw">var</span><span class="kw">=</span><span class="fl">30</span>, <span class="kw">col</span><span class="kw">=</span><span class="st">"red2"</span>, <span class="kw">ci.level</span><span class="kw">=</span><span class="fl">0.5</span>, <span class="kw">ci</span><span class="kw">=</span><span class="st">"bars"</span>, <span class="kw">ylab</span><span class="kw">=</span><span class="st">"Report ratio"</span>, <span class="kw">xlab</span><span class="kw">=</span><span class="st">"Weekly lag"</span>, <span class="kw">main</span><span class="kw">=</span><span class="st">"F"</span>)</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-31-8.png" width="700"></p>
<p><br></p>
<p>Extract the data for combined plot</p>
<div class="sourceCode" id="cb81"><html><body><pre class="r"><span class="co">#rainfall</span>
<span class="no">e_rain</span> <span class="kw">&lt;-</span> <span class="no">pred.rain</span>$<span class="no">matRRfit</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu">rownames_to_column</span>(<span class="kw">var</span><span class="kw">=</span><span class="st">"var"</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">var</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">var</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">var</span><span class="kw">==</span><span class="fl">18</span> <span class="kw">|</span> <span class="no">var</span><span class="kw">==</span><span class="fl">30</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">comparison</span> <span class="kw">=</span> <span class="fu">case_when</span>(<span class="no">var</span><span class="kw">==</span><span class="fl">18</span> ~ <span class="st">"Mid (18mm) vs. low (0mm)"</span>,
                                <span class="no">var</span><span class="kw">==</span><span class="fl">30</span> ~ <span class="st">"High (30mm) vs. low (0mm)"</span>),
         <span class="kw">variable</span><span class="kw">=</span><span class="st">"HIV-positive"</span>,
         <span class="kw">model</span> <span class="kw">=</span> <span class="st">"Rainfall"</span>) <span class="kw">%&gt;%</span>
  <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> <span class="no">lag0</span>:<span class="no">lag20</span>)

<span class="no">e_rain_ci_lo</span> <span class="kw">&lt;-</span> <span class="no">pred.rain</span>$<span class="no">matRRlow</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu">rownames_to_column</span>(<span class="kw">var</span><span class="kw">=</span><span class="st">"var"</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">var</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">var</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">var</span><span class="kw">==</span><span class="fl">18</span> <span class="kw">|</span> <span class="no">var</span><span class="kw">==</span><span class="fl">30</span>) <span class="kw">%&gt;%</span>
  <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> <span class="no">lag0</span>:<span class="no">lag20</span>) <span class="kw">%&gt;%</span>
  <span class="fu">rename</span>(<span class="kw">ci_lo</span><span class="kw">=</span><span class="no">value</span>)

<span class="no">e_rain_ci_hi</span> <span class="kw">&lt;-</span> <span class="no">pred.rain</span>$<span class="no">matRRhigh</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu">rownames_to_column</span>(<span class="kw">var</span><span class="kw">=</span><span class="st">"var"</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">var</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">var</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">var</span><span class="kw">==</span><span class="fl">18</span> <span class="kw">|</span> <span class="no">var</span><span class="kw">==</span><span class="fl">30</span>) <span class="kw">%&gt;%</span>
  <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> <span class="no">lag0</span>:<span class="no">lag20</span>) <span class="kw">%&gt;%</span>
  <span class="fu">rename</span>(<span class="kw">ci_hi</span><span class="kw">=</span><span class="no">value</span>)

<span class="no">e1</span> <span class="kw">&lt;-</span> <span class="fu">left_join</span>(<span class="no">e_rain</span>, <span class="no">e_rain_ci_lo</span>)
<span class="no">e1</span> <span class="kw">&lt;-</span> <span class="fu">left_join</span>(<span class="no">e1</span>, <span class="no">e_rain_ci_hi</span>)

<span class="co">#temp</span>
<span class="no">e_temp</span> <span class="kw">&lt;-</span> <span class="no">pred.temp</span>$<span class="no">matRRfit</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu">rownames_to_column</span>(<span class="kw">var</span><span class="kw">=</span><span class="st">"var"</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">var</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">var</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">var</span><span class="kw">==</span><span class="fl">20</span> <span class="kw">|</span> <span class="no">var</span><span class="kw">==</span><span class="fl">30</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">comparison</span> <span class="kw">=</span> <span class="fu">case_when</span>(<span class="no">var</span><span class="kw">==</span><span class="fl">20</span> ~ <span class="st">"Mid (20°C) vs. low (17°C)"</span>,
                                <span class="no">var</span><span class="kw">==</span><span class="fl">30</span> ~ <span class="st">"High (30°C) vs. low (17°C)"</span>),
         <span class="kw">variable</span><span class="kw">=</span><span class="st">"HIV-positive"</span>,
         <span class="kw">model</span> <span class="kw">=</span> <span class="st">"Temperature"</span>) <span class="kw">%&gt;%</span>
  <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> <span class="no">lag0</span>:<span class="no">lag20</span>)

<span class="no">e_temp_ci_lo</span> <span class="kw">&lt;-</span> <span class="no">pred.temp</span>$<span class="no">matRRlow</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu">rownames_to_column</span>(<span class="kw">var</span><span class="kw">=</span><span class="st">"var"</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">var</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">var</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">var</span><span class="kw">==</span><span class="fl">20</span> <span class="kw">|</span> <span class="no">var</span><span class="kw">==</span><span class="fl">30</span>) <span class="kw">%&gt;%</span>
  <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> <span class="no">lag0</span>:<span class="no">lag20</span>) <span class="kw">%&gt;%</span>
  <span class="fu">rename</span>(<span class="kw">ci_lo</span><span class="kw">=</span><span class="no">value</span>)

<span class="no">e_temp_ci_hi</span> <span class="kw">&lt;-</span> <span class="no">pred.temp</span>$<span class="no">matRRhigh</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu">rownames_to_column</span>(<span class="kw">var</span><span class="kw">=</span><span class="st">"var"</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">var</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">var</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">var</span><span class="kw">==</span><span class="fl">20</span> <span class="kw">|</span> <span class="no">var</span><span class="kw">==</span><span class="fl">30</span>) <span class="kw">%&gt;%</span>
  <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> <span class="no">lag0</span>:<span class="no">lag20</span>) <span class="kw">%&gt;%</span>
  <span class="fu">rename</span>(<span class="kw">ci_hi</span><span class="kw">=</span><span class="no">value</span>)

<span class="no">e2</span> <span class="kw">&lt;-</span> <span class="fu">left_join</span>(<span class="no">e_temp</span>, <span class="no">e_temp_ci_lo</span>)
<span class="no">e2</span> <span class="kw">&lt;-</span> <span class="fu">left_join</span>(<span class="no">e2</span>, <span class="no">e_temp_ci_hi</span>)

<span class="no">e</span> <span class="kw">&lt;-</span> <span class="fu">bind_rows</span>(<span class="no">e1</span>, <span class="no">e2</span>)

<span class="no">e</span> <span class="kw">&lt;-</span> <span class="no">e</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">lag</span> <span class="kw">=</span> <span class="fu">parse_number</span>(<span class="no">name</span>))

<span class="no">e</span> <span class="kw">%&gt;%</span>
  <span class="fu">ggplot</span>() +
  <span class="fu">geom_pointrange</span>(<span class="fu">aes</span>(<span class="kw">x</span><span class="kw">=</span><span class="no">lag</span>, <span class="kw">y</span><span class="kw">=</span><span class="no">value</span>, <span class="kw">ymin</span><span class="kw">=</span><span class="no">ci_lo</span>, <span class="kw">ymax</span><span class="kw">=</span><span class="no">ci_hi</span>, <span class="kw">group</span><span class="kw">=</span><span class="no">comparison</span>, <span class="kw">colour</span><span class="kw">=</span><span class="no">comparison</span>),
                  <span class="kw">position</span><span class="kw">=</span><span class="fu">position_jitterdodge</span>()) +
  <span class="fu">facet_grid</span>(<span class="no">comparison</span>~<span class="no">model</span>)</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-32-1.png" width="700"></p>
<p><br></p>
<p>Stratification by younger population reconstruct cross-basis functions for rainfall and temperature given the optimal DoF</p>
<div class="sourceCode" id="cb82"><html><body><pre class="r">d_q_age0 &lt;- subset(d_q_age,age==0)

sort(d_q_age0$prcp, decreasing=FALSE)
  [1]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
  [7]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [13]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [19]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [25]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [31]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [37]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [43]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [49]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [55]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [61]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [67]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [73]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [79]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [85]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [91]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [97]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[103]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[109]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[115]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[121]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[127]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[133]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[139]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[145]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[151]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[157]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[163]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[169]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[175]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[181]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[187]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[193]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[199]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[205]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[211]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[217]  0.04285714  0.04285714  0.05000000  0.07142857  0.07500000  0.08333333
[223]  0.11428571  0.13333333  0.13333333  0.14285714  0.14285714  0.14285714
[229]  0.14285714  0.15714286  0.16666667  0.18571429  0.18571429  0.21428571
[235]  0.21666667  0.25000000  0.25000000  0.26666667  0.33333333  0.33333333
[241]  0.40000000  0.41666667  0.41666667  0.41666667  0.43333333  0.46666667
[247]  0.47142857  0.50000000  0.51428571  0.55000000  0.58000000  0.60000000
[253]  0.62000000  0.68571429  0.75714286  0.76000000  0.80000000  0.84285714
[259]  0.95000000  0.96000000  1.01428571  1.05000000  1.13333333  1.20000000
[265]  1.22000000  1.40000000  1.40000000  1.42000000  1.48333333  1.52857143
[271]  1.57142857  1.62857143  1.68333333  1.70000000  1.70000000  1.72000000
[277]  1.85000000  2.00000000  2.08000000  2.11666667  2.18000000  2.21428571
[283]  2.24000000  2.38000000  2.52500000  2.53333333  2.57142857  2.65000000
[289]  2.68571429  2.75000000  2.87142857  2.96666667  2.96666667  3.16666667
[295]  3.26666667  3.26666667  3.30000000  3.30000000  3.30000000  3.35000000
[301]  3.60000000  3.60000000  3.81428571  3.85000000  3.95000000  3.98333333
[307]  3.98333333  4.02000000  4.10000000  4.20000000  4.31666667  4.54285714
[313]  4.56666667  4.70000000  4.71428571  4.82000000  4.82500000  4.83333333
[319]  4.92000000  5.03333333  5.05000000  5.20000000  5.21428571  5.24000000
[325]  5.35000000  5.52857143  5.60000000  5.62857143  5.68333333  5.85000000
[331]  5.88333333  6.07142857  6.20000000  6.22500000  6.46666667  6.50000000
[337]  7.22500000  7.27142857  7.30000000  7.38333333  7.48333333  7.65714286
[343]  7.96000000  8.50000000  8.94285714  9.10000000  9.66666667  9.70000000
[349]  9.72000000  9.77500000 10.80000000 11.13333333 11.16000000 11.17500000
[355] 11.26666667 11.55000000 11.75000000 11.80000000 11.98571429 12.72857143
[361] 12.87500000 13.80000000 13.82500000 14.15714286 14.58571429 15.75000000
[367] 20.40000000 20.58571429 21.72500000 22.80000000 25.41428571 28.41428571
[373] 31.70000000
lagk=logknots(20, fun="ns", df=3)
vark=equalknots(d_q_age0$prcp, fun="ns", df=3)
cb.rain &lt;- crossbasis(d_q_age0$prcp, lag=20, argvar=list(knots=vark), arglag=list(knots=lagk))

sort(d_q_age0$temp, decreasing=FALSE)
  [1] 16.64286 17.90000 18.38571 18.53333 18.85714 18.96000 19.22857 19.25714
  [9] 19.52857 20.08571 20.16667 20.34286 20.41667 20.48333 20.58571 20.61667
 [17] 20.65714 20.67143 20.70000 20.77500 20.78571 20.96667 20.97143 21.03333
 [25] 21.04000 21.04286 21.07143 21.07143 21.10000 21.12857 21.18333 21.21429
 [33] 21.24286 21.27143 21.28000 21.33333 21.42000 21.45000 21.45714 21.47143
 [41] 21.55714 21.55714 21.56667 21.57143 21.58000 21.67143 21.71429 21.72857
 [49] 21.73333 21.74286 21.80000 21.81429 21.84286 21.87143 21.90000 21.90000
 [57] 21.91429 21.94286 22.08571 22.10000 22.22000 22.24286 22.24286 22.26667
 [65] 22.28000 22.28571 22.31429 22.33333 22.35714 22.40000 22.44286 22.47143
 [73] 22.50000 22.55714 22.56667 22.57143 22.57500 22.58571 22.58571 22.60000
 [81] 22.70000 22.75714 22.77143 22.78000 22.78571 22.80000 22.86667 22.95714
 [89] 22.98000 23.00000 23.02500 23.02857 23.06667 23.10000 23.10000 23.11429
 [97] 23.11429 23.22857 23.24286 23.28571 23.31429 23.31667 23.32857 23.34286
[105] 23.40000 23.40000 23.40000 23.41429 23.48000 23.48571 23.54286 23.67143
[113] 23.71429 23.71429 23.75000 23.77143 23.77500 23.82857 23.82857 23.87143
[121] 23.90000 23.90000 23.90000 23.95714 24.00000 24.00000 24.02857 24.05000
[129] 24.05000 24.08571 24.08571 24.11429 24.15714 24.20000 24.23333 24.25000
[137] 24.25000 24.25000 24.25714 24.30000 24.32857 24.32857 24.35714 24.37143
[145] 24.37500 24.37500 24.45714 24.48000 24.51429 24.52000 24.55714 24.57500
[153] 24.58000 24.61429 24.62857 24.65000 24.67143 24.70000 24.70000 24.73333
[161] 24.77143 24.78000 24.78333 24.80000 24.82500 24.86667 24.87143 24.87500
[169] 24.88571 24.90000 24.91667 24.93333 24.95714 24.98333 25.00000 25.00000
[177] 25.01667 25.03333 25.06000 25.08571 25.10000 25.10000 25.11429 25.12857
[185] 25.14286 25.15714 25.17143 25.20000 25.20000 25.20000 25.20000 25.22500
[193] 25.22857 25.25714 25.27500 25.30000 25.31429 25.34286 25.35000 25.35714
[201] 25.38571 25.40000 25.44286 25.53333 25.60000 25.60000 25.62857 25.62857
[209] 25.62857 25.64286 25.64286 25.64286 25.65000 25.68333 25.68571 25.70000
[217] 25.72857 25.75000 25.75714 25.76000 25.77143 25.78333 25.78571 25.78571
[225] 25.84286 25.86667 25.91429 25.92857 25.94286 25.98000 26.02500 26.03333
[233] 26.03333 26.04286 26.04286 26.08571 26.14000 26.15714 26.15714 26.16667
[241] 26.18333 26.18571 26.21429 26.21429 26.22000 26.22857 26.25000 26.25714
[249] 26.28000 26.33333 26.35000 26.41429 26.41667 26.41667 26.41667 26.42500
[257] 26.45000 26.47143 26.51429 26.53333 26.54286 26.60000 26.66667 26.67143
[265] 26.70000 26.71429 26.72857 26.76000 26.78571 26.80000 26.87143 26.87143
[273] 26.88571 26.92500 26.92857 26.94286 26.94286 26.95714 26.97143 27.00000
[281] 27.00000 27.01429 27.03333 27.05000 27.10000 27.21429 27.25714 27.27143
[289] 27.27143 27.27143 27.28333 27.28571 27.37143 27.40000 27.42857 27.45000
[297] 27.45714 27.54000 27.55000 27.61429 27.66000 27.75000 27.76000 27.77143
[305] 27.78571 27.80000 27.87143 27.87143 27.88333 27.98000 28.00000 28.00000
[313] 28.01429 28.02857 28.05714 28.05714 28.10000 28.16667 28.20000 28.22000
[321] 28.22857 28.25000 28.25714 28.25714 28.25714 28.27143 28.28333 28.32857
[329] 28.36000 28.36667 28.38571 28.45714 28.46667 28.48571 28.55000 28.57143
[337] 28.60000 28.60000 28.65714 28.66667 28.74286 28.77143 28.80000 28.87143
[345] 28.87500 28.97500 29.14286 29.16667 29.21667 29.25714 29.34000 29.43333
[353] 29.47143 29.61429 29.70000 29.71667 29.90000 30.02857 30.02857 30.05000
[361] 30.23333 30.26000 30.46667 30.74286 30.88000 30.96667 30.97143 31.25714
[369] 31.32857 31.52857 31.67143 32.20000 34.00000
lagk=logknots(20, fun="ns", df=3)
vark=equalknots(d_q_age0$temp, fun="ns", df=3)
cb.temp &lt;- crossbasis(d_q_age0$temp, lag=20, argvar=list(knots=vark), arglag=list(knots=lagk))

#fit two models for rainfall and temperature seperately in generalised linear framework
model.r &lt;- glm(ncase ~ cb.rain + wk + year, family=quasipoisson(), na.action=na.exclude, d_q_age0)
model.t &lt;- glm(ncase ~ cb.temp + wk + year, family=quasipoisson(), na.action=na.exclude, d_q_age0)

#validate rainfall model by minimising high partial/auto-correlation (outside blue dotted lines)
pacf(residuals(model.r,type="deviance"),na.action=na.omit,main="Partial autocorrelation",xlim=c(0,20))</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-33-1.png" width="700"></p>
<div class="sourceCode" id="cb83"><html><body><pre class="r"><span class="no">model.r</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span>(<span class="no">model.r</span>,<span class="no">.</span>~<span class="no">.</span>+<span class="fu"><a href="https://rdrr.io/r/stats/lag.html">lag</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span>(<span class="no">model.r</span>,<span class="kw">type</span><span class="kw">=</span><span class="st">"deviance"</span>),<span class="fl">4</span>))
<span class="no">model.r</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span>(<span class="no">model.r</span>,<span class="no">.</span>~<span class="no">.</span>+<span class="fu"><a href="https://rdrr.io/r/stats/lag.html">lag</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span>(<span class="no">model.r</span>,<span class="kw">type</span><span class="kw">=</span><span class="st">"deviance"</span>),<span class="fl">10</span>))
<span class="no">model.r</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span>(<span class="no">model.r</span>,<span class="no">.</span>~<span class="no">.</span>+<span class="fu"><a href="https://rdrr.io/r/stats/lag.html">lag</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span>(<span class="no">model.r</span>,<span class="kw">type</span><span class="kw">=</span><span class="st">"deviance"</span>),<span class="fl">11</span>))
<span class="no">model.r</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span>(<span class="no">model.r</span>,<span class="no">.</span>~<span class="no">.</span>+<span class="fu"><a href="https://rdrr.io/r/stats/lag.html">lag</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span>(<span class="no">model.r</span>,<span class="kw">type</span><span class="kw">=</span><span class="st">"deviance"</span>),<span class="fl">16</span>))

<span class="co">#validate temperature model by minimising high partial/auto-correlation (outside blue dotted lines)</span>
<span class="fu"><a href="https://rdrr.io/r/stats/acf.html">pacf</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span>(<span class="no">model.t</span>,<span class="kw">type</span><span class="kw">=</span><span class="st">"deviance"</span>),<span class="kw">na.action</span><span class="kw">=</span><span class="no">na.omit</span>,<span class="kw">main</span><span class="kw">=</span><span class="st">"Partial autocorrelation"</span>,<span class="kw">xlim</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>,<span class="fl">20</span>))</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-33-2.png" width="700"></p>
<div class="sourceCode" id="cb84"><html><body><pre class="r"><span class="no">model.t</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span>(<span class="no">model.t</span>,<span class="no">.</span>~<span class="no">.</span>+<span class="fu"><a href="https://rdrr.io/r/stats/lag.html">lag</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span>(<span class="no">model.t</span>,<span class="kw">type</span><span class="kw">=</span><span class="st">"deviance"</span>),<span class="fl">4</span>))
<span class="no">model.t</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span>(<span class="no">model.t</span>,<span class="no">.</span>~<span class="no">.</span>+<span class="fu"><a href="https://rdrr.io/r/stats/lag.html">lag</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span>(<span class="no">model.t</span>,<span class="kw">type</span><span class="kw">=</span><span class="st">"deviance"</span>),<span class="fl">10</span>))
<span class="no">model.t</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span>(<span class="no">model.t</span>,<span class="no">.</span>~<span class="no">.</span>+<span class="fu"><a href="https://rdrr.io/r/stats/lag.html">lag</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span>(<span class="no">model.t</span>,<span class="kw">type</span><span class="kw">=</span><span class="st">"deviance"</span>),<span class="fl">11</span>))
<span class="no">model.t</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span>(<span class="no">model.t</span>,<span class="no">.</span>~<span class="no">.</span>+<span class="fu"><a href="https://rdrr.io/r/stats/lag.html">lag</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span>(<span class="no">model.t</span>,<span class="kw">type</span><span class="kw">=</span><span class="st">"deviance"</span>),<span class="fl">16</span>))

<span class="co">#predict (nowcast) the effect on TB notification of rainfall/temperature</span>
<span class="no">pred.rain</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/dlnm/man/crosspred.html">crosspred</a></span>(<span class="no">cb.rain</span>, <span class="no">model.r</span>, <span class="kw">cen</span><span class="kw">=</span><span class="fl">0</span>, <span class="kw">by</span><span class="kw">=</span><span class="fl">0.2</span>)
<span class="no">pred.temp</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/dlnm/man/crosspred.html">crosspred</a></span>(<span class="no">cb.temp</span>, <span class="no">model.t</span>, <span class="kw">cen</span><span class="kw">=</span><span class="fl">17</span>, <span class="kw">by</span><span class="kw">=</span><span class="fl">0.2</span>)

<span class="co">#plot 3D, countour and curves for rainfall on TB notifications</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span>(<span class="kw">mgp</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">2.3</span>,<span class="fl">1</span>,<span class="fl">0</span>),<span class="kw">mai</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.9</span>,<span class="fl">0.9</span>,<span class="fl">0.3</span>,<span class="fl">0.2</span>))
<span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">pred.rain</span>, <span class="st">"contour"</span>, <span class="kw">key.title</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html">title</a></span>(<span class="st">"TBN"</span>), <span class="kw">plot.title</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html">title</a></span>(<span class="st">"A"</span>, <span class="kw">xlab</span> <span class="kw">=</span><span class="st">"Weekly mean rainfall (mm)"</span>, <span class="kw">ylab</span> <span class="kw">=</span> <span class="st">"Weekly lag"</span>, <span class="kw">cex.lab</span><span class="kw">=</span><span class="fl">1</span>, <span class="kw">cex.axis</span><span class="kw">=</span><span class="fl">1</span>))</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-33-3.png" width="700"></p>
<div class="sourceCode" id="cb85"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">pred.rain</span>, <span class="st">"slices"</span>, <span class="kw">type</span><span class="kw">=</span><span class="st">"p"</span>, <span class="kw">pch</span><span class="kw">=</span><span class="fl">19</span>, <span class="kw">cex</span><span class="kw">=</span><span class="fl">1.3</span>, <span class="kw">var</span><span class="kw">=</span><span class="fl">18</span>, <span class="kw">col</span><span class="kw">=</span><span class="st">"purple"</span>, <span class="kw">ci.level</span><span class="kw">=</span><span class="fl">0.5</span>, <span class="kw">ci</span><span class="kw">=</span><span class="st">"bars"</span>, <span class="kw">ylab</span><span class="kw">=</span><span class="st">"Report ratio"</span>, <span class="kw">xlab</span><span class="kw">=</span><span class="st">"Weekly lag"</span>, <span class="kw">main</span><span class="kw">=</span><span class="st">"B"</span>)</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-33-4.png" width="700"></p>
<div class="sourceCode" id="cb86"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">pred.rain</span>, <span class="st">"slices"</span>, <span class="kw">type</span><span class="kw">=</span><span class="st">"p"</span>, <span class="kw">pch</span><span class="kw">=</span><span class="fl">19</span>, <span class="kw">cex</span><span class="kw">=</span><span class="fl">1.3</span>, <span class="kw">var</span><span class="kw">=</span><span class="fl">30</span>, <span class="kw">col</span><span class="kw">=</span><span class="st">"purple"</span>, <span class="kw">ci.level</span><span class="kw">=</span><span class="fl">0.5</span>, <span class="kw">ci</span><span class="kw">=</span><span class="st">"bars"</span>, <span class="kw">ylab</span><span class="kw">=</span><span class="st">"Report ratio"</span>, <span class="kw">xlab</span><span class="kw">=</span><span class="st">"Weekly lag"</span>, <span class="kw">main</span><span class="kw">=</span><span class="st">"C"</span>)</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-33-5.png" width="700"></p>
<div class="sourceCode" id="cb87"><html><body><pre class="r">
<span class="co">#plot 3D, countour and curves for temperature on TB notifications</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span>(<span class="kw">mgp</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">2.3</span>,<span class="fl">1</span>,<span class="fl">0</span>),<span class="kw">mai</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.9</span>,<span class="fl">0.9</span>,<span class="fl">0.3</span>,<span class="fl">0.2</span>))
<span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">pred.temp</span>, <span class="st">"contour"</span>, <span class="kw">key.title</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html">title</a></span>(<span class="st">"TBN"</span>), <span class="kw">plot.title</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html">title</a></span>(<span class="st">"D"</span>, <span class="kw">xlab</span> <span class="kw">=</span><span class="st">"Weekly mean temperature (°C)"</span>, <span class="kw">ylab</span> <span class="kw">=</span> <span class="st">"Weekly lag"</span>, <span class="kw">cex.lab</span><span class="kw">=</span><span class="fl">1</span>, <span class="kw">cex.axis</span><span class="kw">=</span><span class="fl">1</span>))</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-33-6.png" width="700"></p>
<div class="sourceCode" id="cb88"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">pred.temp</span>, <span class="st">"slices"</span>, <span class="kw">type</span><span class="kw">=</span><span class="st">"p"</span>, <span class="kw">pch</span><span class="kw">=</span><span class="fl">19</span>, <span class="kw">cex</span><span class="kw">=</span><span class="fl">1.3</span>, <span class="kw">var</span><span class="kw">=</span><span class="fl">20</span>, <span class="kw">col</span><span class="kw">=</span><span class="st">"red2"</span>, <span class="kw">ci.level</span><span class="kw">=</span><span class="fl">0.5</span>, <span class="kw">ci</span><span class="kw">=</span><span class="st">"bars"</span>, <span class="kw">ylab</span><span class="kw">=</span><span class="st">"Report ratio"</span>, <span class="kw">xlab</span><span class="kw">=</span><span class="st">"Weekly lag"</span>, <span class="kw">main</span><span class="kw">=</span><span class="st">"E"</span>)</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-33-7.png" width="700"></p>
<div class="sourceCode" id="cb89"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">pred.temp</span>, <span class="st">"slices"</span>, <span class="kw">type</span><span class="kw">=</span><span class="st">"p"</span>, <span class="kw">pch</span><span class="kw">=</span><span class="fl">19</span>, <span class="kw">cex</span><span class="kw">=</span><span class="fl">1.3</span>, <span class="kw">var</span><span class="kw">=</span><span class="fl">30</span>, <span class="kw">col</span><span class="kw">=</span><span class="st">"red2"</span>, <span class="kw">ci.level</span><span class="kw">=</span><span class="fl">0.5</span>, <span class="kw">ci</span><span class="kw">=</span><span class="st">"bars"</span>, <span class="kw">ylab</span><span class="kw">=</span><span class="st">"Report ratio"</span>, <span class="kw">xlab</span><span class="kw">=</span><span class="st">"Weekly lag"</span>, <span class="kw">main</span><span class="kw">=</span><span class="st">"F"</span>)</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-33-8.png" width="700"></p>
<p><br></p>
<p>Extract the data for combined plot</p>
<div class="sourceCode" id="cb90"><html><body><pre class="r"><span class="co">#rainfall</span>
<span class="no">f_rain</span> <span class="kw">&lt;-</span> <span class="no">pred.rain</span>$<span class="no">matRRfit</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu">rownames_to_column</span>(<span class="kw">var</span><span class="kw">=</span><span class="st">"var"</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">var</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">var</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">var</span><span class="kw">==</span><span class="fl">18</span> <span class="kw">|</span> <span class="no">var</span><span class="kw">==</span><span class="fl">30</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">comparison</span> <span class="kw">=</span> <span class="fu">case_when</span>(<span class="no">var</span><span class="kw">==</span><span class="fl">18</span> ~ <span class="st">"Mid (18mm) vs. low (0mm)"</span>,
                                <span class="no">var</span><span class="kw">==</span><span class="fl">30</span> ~ <span class="st">"High (30mm) vs. low (0mm)"</span>),
         <span class="kw">variable</span><span class="kw">=</span><span class="st">"Young age"</span>,
         <span class="kw">model</span> <span class="kw">=</span> <span class="st">"Rainfall"</span>) <span class="kw">%&gt;%</span>
  <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> <span class="no">lag0</span>:<span class="no">lag20</span>)

<span class="no">f_rain_ci_lo</span> <span class="kw">&lt;-</span> <span class="no">pred.rain</span>$<span class="no">matRRlow</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu">rownames_to_column</span>(<span class="kw">var</span><span class="kw">=</span><span class="st">"var"</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">var</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">var</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">var</span><span class="kw">==</span><span class="fl">18</span> <span class="kw">|</span> <span class="no">var</span><span class="kw">==</span><span class="fl">30</span>) <span class="kw">%&gt;%</span>
  <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> <span class="no">lag0</span>:<span class="no">lag20</span>) <span class="kw">%&gt;%</span>
  <span class="fu">rename</span>(<span class="kw">ci_lo</span><span class="kw">=</span><span class="no">value</span>)

<span class="no">f_rain_ci_hi</span> <span class="kw">&lt;-</span> <span class="no">pred.rain</span>$<span class="no">matRRhigh</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu">rownames_to_column</span>(<span class="kw">var</span><span class="kw">=</span><span class="st">"var"</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">var</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">var</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">var</span><span class="kw">==</span><span class="fl">18</span> <span class="kw">|</span> <span class="no">var</span><span class="kw">==</span><span class="fl">30</span>) <span class="kw">%&gt;%</span>
  <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> <span class="no">lag0</span>:<span class="no">lag20</span>) <span class="kw">%&gt;%</span>
  <span class="fu">rename</span>(<span class="kw">ci_hi</span><span class="kw">=</span><span class="no">value</span>)

<span class="no">f1</span> <span class="kw">&lt;-</span> <span class="fu">left_join</span>(<span class="no">f_rain</span>, <span class="no">f_rain_ci_lo</span>)
<span class="no">f1</span> <span class="kw">&lt;-</span> <span class="fu">left_join</span>(<span class="no">f1</span>, <span class="no">f_rain_ci_hi</span>)

<span class="co">#temp</span>
<span class="no">f_temp</span> <span class="kw">&lt;-</span> <span class="no">pred.temp</span>$<span class="no">matRRfit</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu">rownames_to_column</span>(<span class="kw">var</span><span class="kw">=</span><span class="st">"var"</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">var</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">var</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">var</span><span class="kw">==</span><span class="fl">20</span> <span class="kw">|</span> <span class="no">var</span><span class="kw">==</span><span class="fl">30</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">comparison</span> <span class="kw">=</span> <span class="fu">case_when</span>(<span class="no">var</span><span class="kw">==</span><span class="fl">20</span> ~ <span class="st">"Mid (20°C) vs. low (17°C)"</span>,
                                <span class="no">var</span><span class="kw">==</span><span class="fl">30</span> ~ <span class="st">"High (30°C) vs. low (17°C)"</span>),
         <span class="kw">variable</span><span class="kw">=</span><span class="st">"Young age"</span>,
         <span class="kw">model</span> <span class="kw">=</span> <span class="st">"Temperature"</span>) <span class="kw">%&gt;%</span>
  <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> <span class="no">lag0</span>:<span class="no">lag20</span>)

<span class="no">f_temp_ci_lo</span> <span class="kw">&lt;-</span> <span class="no">pred.temp</span>$<span class="no">matRRlow</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu">rownames_to_column</span>(<span class="kw">var</span><span class="kw">=</span><span class="st">"var"</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">var</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">var</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">var</span><span class="kw">==</span><span class="fl">20</span> <span class="kw">|</span> <span class="no">var</span><span class="kw">==</span><span class="fl">30</span>) <span class="kw">%&gt;%</span>
  <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> <span class="no">lag0</span>:<span class="no">lag20</span>) <span class="kw">%&gt;%</span>
  <span class="fu">rename</span>(<span class="kw">ci_lo</span><span class="kw">=</span><span class="no">value</span>)

<span class="no">f_temp_ci_hi</span> <span class="kw">&lt;-</span> <span class="no">pred.temp</span>$<span class="no">matRRhigh</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu">rownames_to_column</span>(<span class="kw">var</span><span class="kw">=</span><span class="st">"var"</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">var</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">var</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">var</span><span class="kw">==</span><span class="fl">20</span> <span class="kw">|</span> <span class="no">var</span><span class="kw">==</span><span class="fl">30</span>) <span class="kw">%&gt;%</span>
  <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> <span class="no">lag0</span>:<span class="no">lag20</span>) <span class="kw">%&gt;%</span>
  <span class="fu">rename</span>(<span class="kw">ci_hi</span><span class="kw">=</span><span class="no">value</span>)

<span class="no">f2</span> <span class="kw">&lt;-</span> <span class="fu">left_join</span>(<span class="no">f_temp</span>, <span class="no">f_temp_ci_lo</span>)
<span class="no">f2</span> <span class="kw">&lt;-</span> <span class="fu">left_join</span>(<span class="no">f2</span>, <span class="no">f_temp_ci_hi</span>)

<span class="no">f</span> <span class="kw">&lt;-</span> <span class="fu">bind_rows</span>(<span class="no">f1</span>, <span class="no">f2</span>)

<span class="no">f</span> <span class="kw">&lt;-</span> <span class="no">f</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">lag</span> <span class="kw">=</span> <span class="fu">parse_number</span>(<span class="no">name</span>))

<span class="no">f</span> <span class="kw">%&gt;%</span>
  <span class="fu">ggplot</span>() +
  <span class="fu">geom_pointrange</span>(<span class="fu">aes</span>(<span class="kw">x</span><span class="kw">=</span><span class="no">lag</span>, <span class="kw">y</span><span class="kw">=</span><span class="no">value</span>, <span class="kw">ymin</span><span class="kw">=</span><span class="no">ci_lo</span>, <span class="kw">ymax</span><span class="kw">=</span><span class="no">ci_hi</span>, <span class="kw">group</span><span class="kw">=</span><span class="no">comparison</span>, <span class="kw">colour</span><span class="kw">=</span><span class="no">comparison</span>),
                  <span class="kw">position</span><span class="kw">=</span><span class="fu">position_jitterdodge</span>()) +
  <span class="fu">facet_grid</span>(<span class="no">comparison</span>~<span class="no">model</span>)</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-34-1.png" width="700"></p>
<p><br></p>
<p>Stratification by middle-age population reconstruct cross-basis functions for rainfall and temperature given the optimal DoF</p>
<div class="sourceCode" id="cb91"><html><body><pre class="r">d_q_age1 &lt;- subset(d_q_age,age==1)

sort(d_q_age1$prcp, decreasing=FALSE)
  [1]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
  [7]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [13]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [19]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [25]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [31]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [37]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [43]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [49]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [55]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [61]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [67]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [73]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [79]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [85]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [91]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [97]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[103]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[109]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[115]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[121]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[127]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[133]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[139]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[145]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[151]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[157]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[163]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[169]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[175]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[181]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[187]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[193]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[199]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[205]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[211]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[217]  0.04285714  0.04285714  0.05000000  0.07142857  0.07500000  0.08333333
[223]  0.11428571  0.13333333  0.13333333  0.14285714  0.14285714  0.14285714
[229]  0.14285714  0.15714286  0.16666667  0.18571429  0.18571429  0.21428571
[235]  0.21666667  0.25000000  0.25000000  0.26666667  0.33333333  0.33333333
[241]  0.40000000  0.41666667  0.41666667  0.41666667  0.43333333  0.46666667
[247]  0.47142857  0.50000000  0.51428571  0.55000000  0.58000000  0.60000000
[253]  0.62000000  0.68571429  0.75714286  0.76000000  0.80000000  0.84285714
[259]  0.95000000  0.96000000  1.01428571  1.05000000  1.13333333  1.20000000
[265]  1.22000000  1.40000000  1.40000000  1.42000000  1.48333333  1.52857143
[271]  1.57142857  1.62857143  1.68333333  1.70000000  1.70000000  1.72000000
[277]  1.85000000  2.00000000  2.08000000  2.11666667  2.18000000  2.21428571
[283]  2.24000000  2.38000000  2.52500000  2.53333333  2.57142857  2.65000000
[289]  2.68571429  2.75000000  2.87142857  2.96666667  2.96666667  3.16666667
[295]  3.26666667  3.26666667  3.30000000  3.30000000  3.30000000  3.35000000
[301]  3.60000000  3.60000000  3.81428571  3.85000000  3.95000000  3.98333333
[307]  3.98333333  4.02000000  4.10000000  4.20000000  4.31666667  4.54285714
[313]  4.56666667  4.70000000  4.71428571  4.82000000  4.82500000  4.83333333
[319]  4.92000000  5.03333333  5.05000000  5.20000000  5.21428571  5.24000000
[325]  5.35000000  5.52857143  5.60000000  5.62857143  5.68333333  5.85000000
[331]  5.88333333  6.07142857  6.20000000  6.22500000  6.46666667  6.50000000
[337]  7.22500000  7.27142857  7.30000000  7.38333333  7.48333333  7.65714286
[343]  7.96000000  8.50000000  8.94285714  9.10000000  9.66666667  9.70000000
[349]  9.72000000  9.77500000 10.80000000 11.13333333 11.16000000 11.17500000
[355] 11.26666667 11.55000000 11.75000000 11.80000000 11.98571429 12.72857143
[361] 12.87500000 13.80000000 13.82500000 14.15714286 14.58571429 15.75000000
[367] 20.40000000 20.58571429 21.72500000 22.80000000 25.41428571 28.41428571
[373] 31.70000000
lagk=logknots(20, fun="ns", df=3)
vark=equalknots(d_q_age1$prcp, fun="ns", df=3)
cb.rain &lt;- crossbasis(d_q_age1$prcp, lag=20, argvar=list(knots=vark), arglag=list(knots=lagk))

sort(d_q_age1$temp, decreasing=FALSE)
  [1] 16.64286 17.90000 18.38571 18.53333 18.85714 18.96000 19.22857 19.25714
  [9] 19.52857 20.08571 20.16667 20.34286 20.41667 20.48333 20.58571 20.61667
 [17] 20.65714 20.67143 20.70000 20.77500 20.78571 20.96667 20.97143 21.03333
 [25] 21.04000 21.04286 21.07143 21.07143 21.10000 21.12857 21.18333 21.21429
 [33] 21.24286 21.27143 21.28000 21.33333 21.42000 21.45000 21.45714 21.47143
 [41] 21.55714 21.55714 21.56667 21.57143 21.58000 21.67143 21.71429 21.72857
 [49] 21.73333 21.74286 21.80000 21.81429 21.84286 21.87143 21.90000 21.90000
 [57] 21.91429 21.94286 22.08571 22.10000 22.22000 22.24286 22.24286 22.26667
 [65] 22.28000 22.28571 22.31429 22.33333 22.35714 22.40000 22.44286 22.47143
 [73] 22.50000 22.55714 22.56667 22.57143 22.57500 22.58571 22.58571 22.60000
 [81] 22.70000 22.75714 22.77143 22.78000 22.78571 22.80000 22.86667 22.95714
 [89] 22.98000 23.00000 23.02500 23.02857 23.06667 23.10000 23.10000 23.11429
 [97] 23.11429 23.22857 23.24286 23.28571 23.31429 23.31667 23.32857 23.34286
[105] 23.40000 23.40000 23.40000 23.41429 23.48000 23.48571 23.54286 23.67143
[113] 23.71429 23.71429 23.75000 23.77143 23.77500 23.82857 23.82857 23.87143
[121] 23.90000 23.90000 23.90000 23.95714 24.00000 24.00000 24.02857 24.05000
[129] 24.05000 24.08571 24.08571 24.11429 24.15714 24.20000 24.23333 24.25000
[137] 24.25000 24.25000 24.25714 24.30000 24.32857 24.32857 24.35714 24.37143
[145] 24.37500 24.37500 24.45714 24.48000 24.51429 24.52000 24.55714 24.57500
[153] 24.58000 24.61429 24.62857 24.65000 24.67143 24.70000 24.70000 24.73333
[161] 24.77143 24.78000 24.78333 24.80000 24.82500 24.86667 24.87143 24.87500
[169] 24.88571 24.90000 24.91667 24.93333 24.95714 24.98333 25.00000 25.00000
[177] 25.01667 25.03333 25.06000 25.08571 25.10000 25.10000 25.11429 25.12857
[185] 25.14286 25.15714 25.17143 25.20000 25.20000 25.20000 25.20000 25.22500
[193] 25.22857 25.25714 25.27500 25.30000 25.31429 25.34286 25.35000 25.35714
[201] 25.38571 25.40000 25.44286 25.53333 25.60000 25.60000 25.62857 25.62857
[209] 25.62857 25.64286 25.64286 25.64286 25.65000 25.68333 25.68571 25.70000
[217] 25.72857 25.75000 25.75714 25.76000 25.77143 25.78333 25.78571 25.78571
[225] 25.84286 25.86667 25.91429 25.92857 25.94286 25.98000 26.02500 26.03333
[233] 26.03333 26.04286 26.04286 26.08571 26.14000 26.15714 26.15714 26.16667
[241] 26.18333 26.18571 26.21429 26.21429 26.22000 26.22857 26.25000 26.25714
[249] 26.28000 26.33333 26.35000 26.41429 26.41667 26.41667 26.41667 26.42500
[257] 26.45000 26.47143 26.51429 26.53333 26.54286 26.60000 26.66667 26.67143
[265] 26.70000 26.71429 26.72857 26.76000 26.78571 26.80000 26.87143 26.87143
[273] 26.88571 26.92500 26.92857 26.94286 26.94286 26.95714 26.97143 27.00000
[281] 27.00000 27.01429 27.03333 27.05000 27.10000 27.21429 27.25714 27.27143
[289] 27.27143 27.27143 27.28333 27.28571 27.37143 27.40000 27.42857 27.45000
[297] 27.45714 27.54000 27.55000 27.61429 27.66000 27.75000 27.76000 27.77143
[305] 27.78571 27.80000 27.87143 27.87143 27.88333 27.98000 28.00000 28.00000
[313] 28.01429 28.02857 28.05714 28.05714 28.10000 28.16667 28.20000 28.22000
[321] 28.22857 28.25000 28.25714 28.25714 28.25714 28.27143 28.28333 28.32857
[329] 28.36000 28.36667 28.38571 28.45714 28.46667 28.48571 28.55000 28.57143
[337] 28.60000 28.60000 28.65714 28.66667 28.74286 28.77143 28.80000 28.87143
[345] 28.87500 28.97500 29.14286 29.16667 29.21667 29.25714 29.34000 29.43333
[353] 29.47143 29.61429 29.70000 29.71667 29.90000 30.02857 30.02857 30.05000
[361] 30.23333 30.26000 30.46667 30.74286 30.88000 30.96667 30.97143 31.25714
[369] 31.32857 31.52857 31.67143 32.20000 34.00000
lagk=logknots(20, fun="ns", df=3)
vark=equalknots(d_q_age1$temp, fun="ns", df=3)
cb.temp &lt;- crossbasis(d_q_age1$temp, lag=20, argvar=list(knots=vark), arglag=list(knots=lagk))

#fit two models for rainfall and temperature seperately in generalised linear framework
model.r &lt;- glm(ncase ~ cb.rain + wk + year, family=quasipoisson(), na.action=na.exclude, d_q_age1)
model.t &lt;- glm(ncase ~ cb.temp + wk + year, family=quasipoisson(), na.action=na.exclude, d_q_age1)

#validate rainfall model by minimising high partial/auto-correlation (outside blue dotted lines)
pacf(residuals(model.r,type="deviance"),na.action=na.omit,main="Partial autocorrelation",xlim=c(0,20))</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-35-1.png" width="700"></p>
<div class="sourceCode" id="cb92"><html><body><pre class="r">
<span class="co">#validate temperature model by minimising high partial/auto-correlation (outside blue dotted lines)</span>
<span class="fu"><a href="https://rdrr.io/r/stats/acf.html">pacf</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span>(<span class="no">model.t</span>,<span class="kw">type</span><span class="kw">=</span><span class="st">"deviance"</span>),<span class="kw">na.action</span><span class="kw">=</span><span class="no">na.omit</span>,<span class="kw">main</span><span class="kw">=</span><span class="st">"Partial autocorrelation"</span>,<span class="kw">xlim</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>,<span class="fl">20</span>))</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-35-2.png" width="700"></p>
<div class="sourceCode" id="cb93"><html><body><pre class="r">
<span class="co">#predict (nowcast) the effect on TB notification of rainfall/temperature</span>
<span class="no">pred.rain</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/dlnm/man/crosspred.html">crosspred</a></span>(<span class="no">cb.rain</span>, <span class="no">model.r</span>, <span class="kw">cen</span><span class="kw">=</span><span class="fl">0</span>, <span class="kw">by</span><span class="kw">=</span><span class="fl">0.2</span>)
<span class="no">pred.temp</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/dlnm/man/crosspred.html">crosspred</a></span>(<span class="no">cb.temp</span>, <span class="no">model.t</span>, <span class="kw">cen</span><span class="kw">=</span><span class="fl">17</span>, <span class="kw">by</span><span class="kw">=</span><span class="fl">0.2</span>)

<span class="co">#plot 3D, countour and curves for rainfall on TB notifications</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span>(<span class="kw">mgp</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">2.3</span>,<span class="fl">1</span>,<span class="fl">0</span>),<span class="kw">mai</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.9</span>,<span class="fl">0.9</span>,<span class="fl">0.3</span>,<span class="fl">0.2</span>))
<span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">pred.rain</span>, <span class="st">"contour"</span>, <span class="kw">key.title</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html">title</a></span>(<span class="st">"TBN"</span>), <span class="kw">plot.title</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html">title</a></span>(<span class="st">"A"</span>, <span class="kw">xlab</span> <span class="kw">=</span><span class="st">"Weekly mean rainfall (mm)"</span>, <span class="kw">ylab</span> <span class="kw">=</span> <span class="st">"Weekly lag"</span>, <span class="kw">cex.lab</span><span class="kw">=</span><span class="fl">1</span>, <span class="kw">cex.axis</span><span class="kw">=</span><span class="fl">1</span>))</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-35-3.png" width="700"></p>
<div class="sourceCode" id="cb94"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">pred.rain</span>, <span class="st">"slices"</span>, <span class="kw">type</span><span class="kw">=</span><span class="st">"p"</span>, <span class="kw">pch</span><span class="kw">=</span><span class="fl">19</span>, <span class="kw">cex</span><span class="kw">=</span><span class="fl">1.3</span>, <span class="kw">var</span><span class="kw">=</span><span class="fl">18</span>, <span class="kw">col</span><span class="kw">=</span><span class="st">"purple"</span>, <span class="kw">ci.level</span><span class="kw">=</span><span class="fl">0.5</span>, <span class="kw">ci</span><span class="kw">=</span><span class="st">"bars"</span>, <span class="kw">ylab</span><span class="kw">=</span><span class="st">"Report ratio"</span>, <span class="kw">xlab</span><span class="kw">=</span><span class="st">"Weekly lag"</span>, <span class="kw">main</span><span class="kw">=</span><span class="st">"B"</span>)</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-35-4.png" width="700"></p>
<div class="sourceCode" id="cb95"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">pred.rain</span>, <span class="st">"slices"</span>, <span class="kw">type</span><span class="kw">=</span><span class="st">"p"</span>, <span class="kw">pch</span><span class="kw">=</span><span class="fl">19</span>, <span class="kw">cex</span><span class="kw">=</span><span class="fl">1.3</span>, <span class="kw">var</span><span class="kw">=</span><span class="fl">30</span>, <span class="kw">col</span><span class="kw">=</span><span class="st">"purple"</span>, <span class="kw">ci.level</span><span class="kw">=</span><span class="fl">0.5</span>, <span class="kw">ci</span><span class="kw">=</span><span class="st">"bars"</span>, <span class="kw">ylab</span><span class="kw">=</span><span class="st">"Report ratio"</span>, <span class="kw">xlab</span><span class="kw">=</span><span class="st">"Weekly lag"</span>, <span class="kw">main</span><span class="kw">=</span><span class="st">"C"</span>)</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-35-5.png" width="700"></p>
<div class="sourceCode" id="cb96"><html><body><pre class="r">
<span class="co">#plot 3D, countour and curves for temperature on TB notifications</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span>(<span class="kw">mgp</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">2.3</span>,<span class="fl">1</span>,<span class="fl">0</span>),<span class="kw">mai</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.9</span>,<span class="fl">0.9</span>,<span class="fl">0.3</span>,<span class="fl">0.2</span>))
<span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">pred.temp</span>, <span class="st">"contour"</span>, <span class="kw">key.title</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html">title</a></span>(<span class="st">"TBN"</span>), <span class="kw">plot.title</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html">title</a></span>(<span class="st">"D"</span>, <span class="kw">xlab</span> <span class="kw">=</span><span class="st">"Weekly mean temperature (°C)"</span>, <span class="kw">ylab</span> <span class="kw">=</span> <span class="st">"Weekly lag"</span>, <span class="kw">cex.lab</span><span class="kw">=</span><span class="fl">1</span>, <span class="kw">cex.axis</span><span class="kw">=</span><span class="fl">1</span>))</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-35-6.png" width="700"></p>
<div class="sourceCode" id="cb97"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">pred.temp</span>, <span class="st">"slices"</span>, <span class="kw">type</span><span class="kw">=</span><span class="st">"p"</span>, <span class="kw">pch</span><span class="kw">=</span><span class="fl">19</span>, <span class="kw">cex</span><span class="kw">=</span><span class="fl">1.3</span>, <span class="kw">var</span><span class="kw">=</span><span class="fl">20</span>, <span class="kw">col</span><span class="kw">=</span><span class="st">"red2"</span>, <span class="kw">ci.level</span><span class="kw">=</span><span class="fl">0.5</span>, <span class="kw">ci</span><span class="kw">=</span><span class="st">"bars"</span>, <span class="kw">ylab</span><span class="kw">=</span><span class="st">"Report ratio"</span>, <span class="kw">xlab</span><span class="kw">=</span><span class="st">"Weekly lag"</span>, <span class="kw">main</span><span class="kw">=</span><span class="st">"E"</span>)</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-35-7.png" width="700"></p>
<div class="sourceCode" id="cb98"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">pred.temp</span>, <span class="st">"slices"</span>, <span class="kw">type</span><span class="kw">=</span><span class="st">"p"</span>, <span class="kw">pch</span><span class="kw">=</span><span class="fl">19</span>, <span class="kw">cex</span><span class="kw">=</span><span class="fl">1.3</span>, <span class="kw">var</span><span class="kw">=</span><span class="fl">30</span>, <span class="kw">col</span><span class="kw">=</span><span class="st">"red2"</span>, <span class="kw">ci.level</span><span class="kw">=</span><span class="fl">0.5</span>, <span class="kw">ci</span><span class="kw">=</span><span class="st">"bars"</span>, <span class="kw">ylab</span><span class="kw">=</span><span class="st">"Report ratio"</span>, <span class="kw">xlab</span><span class="kw">=</span><span class="st">"Weekly lag"</span>, <span class="kw">main</span><span class="kw">=</span><span class="st">"F"</span>)</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-35-8.png" width="700"></p>
<p><br></p>
<p>Extract the data for combined plot</p>
<div class="sourceCode" id="cb99"><html><body><pre class="r"><span class="co">#rainfall</span>
<span class="no">g_rain</span> <span class="kw">&lt;-</span> <span class="no">pred.rain</span>$<span class="no">matRRfit</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu">rownames_to_column</span>(<span class="kw">var</span><span class="kw">=</span><span class="st">"var"</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">var</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">var</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">var</span><span class="kw">==</span><span class="fl">18</span> <span class="kw">|</span> <span class="no">var</span><span class="kw">==</span><span class="fl">30</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">comparison</span> <span class="kw">=</span> <span class="fu">case_when</span>(<span class="no">var</span><span class="kw">==</span><span class="fl">18</span> ~ <span class="st">"Mid (18mm) vs. low (0mm)"</span>,
                                <span class="no">var</span><span class="kw">==</span><span class="fl">30</span> ~ <span class="st">"High (30mm) vs. low (0mm)"</span>),
         <span class="kw">variable</span><span class="kw">=</span><span class="st">"Middle age"</span>,
         <span class="kw">model</span> <span class="kw">=</span> <span class="st">"Rainfall"</span>) <span class="kw">%&gt;%</span>
  <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> <span class="no">lag0</span>:<span class="no">lag20</span>)

<span class="no">g_rain_ci_lo</span> <span class="kw">&lt;-</span> <span class="no">pred.rain</span>$<span class="no">matRRlow</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu">rownames_to_column</span>(<span class="kw">var</span><span class="kw">=</span><span class="st">"var"</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">var</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">var</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">var</span><span class="kw">==</span><span class="fl">18</span> <span class="kw">|</span> <span class="no">var</span><span class="kw">==</span><span class="fl">30</span>) <span class="kw">%&gt;%</span>
  <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> <span class="no">lag0</span>:<span class="no">lag20</span>) <span class="kw">%&gt;%</span>
  <span class="fu">rename</span>(<span class="kw">ci_lo</span><span class="kw">=</span><span class="no">value</span>)

<span class="no">g_rain_ci_hi</span> <span class="kw">&lt;-</span> <span class="no">pred.rain</span>$<span class="no">matRRhigh</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu">rownames_to_column</span>(<span class="kw">var</span><span class="kw">=</span><span class="st">"var"</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">var</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">var</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">var</span><span class="kw">==</span><span class="fl">18</span> <span class="kw">|</span> <span class="no">var</span><span class="kw">==</span><span class="fl">30</span>) <span class="kw">%&gt;%</span>
  <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> <span class="no">lag0</span>:<span class="no">lag20</span>) <span class="kw">%&gt;%</span>
  <span class="fu">rename</span>(<span class="kw">ci_hi</span><span class="kw">=</span><span class="no">value</span>)

<span class="no">g1</span> <span class="kw">&lt;-</span> <span class="fu">left_join</span>(<span class="no">g_rain</span>, <span class="no">g_rain_ci_lo</span>)
<span class="no">g1</span> <span class="kw">&lt;-</span> <span class="fu">left_join</span>(<span class="no">g1</span>, <span class="no">g_rain_ci_hi</span>)

<span class="co">#temp</span>
<span class="no">g_temp</span> <span class="kw">&lt;-</span> <span class="no">pred.temp</span>$<span class="no">matRRfit</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu">rownames_to_column</span>(<span class="kw">var</span><span class="kw">=</span><span class="st">"var"</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">var</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">var</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">var</span><span class="kw">==</span><span class="fl">20</span> <span class="kw">|</span> <span class="no">var</span><span class="kw">==</span><span class="fl">30</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">comparison</span> <span class="kw">=</span> <span class="fu">case_when</span>(<span class="no">var</span><span class="kw">==</span><span class="fl">20</span> ~ <span class="st">"Mid (20°C) vs. low (17°C)"</span>,
                                <span class="no">var</span><span class="kw">==</span><span class="fl">30</span> ~ <span class="st">"High (30°C) vs. low (17°C)"</span>),
         <span class="kw">variable</span><span class="kw">=</span><span class="st">"Middle age"</span>,
         <span class="kw">model</span> <span class="kw">=</span> <span class="st">"Temperature"</span>) <span class="kw">%&gt;%</span>
  <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> <span class="no">lag0</span>:<span class="no">lag20</span>)

<span class="no">g_temp_ci_lo</span> <span class="kw">&lt;-</span> <span class="no">pred.temp</span>$<span class="no">matRRlow</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu">rownames_to_column</span>(<span class="kw">var</span><span class="kw">=</span><span class="st">"var"</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">var</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">var</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">var</span><span class="kw">==</span><span class="fl">20</span> <span class="kw">|</span> <span class="no">var</span><span class="kw">==</span><span class="fl">30</span>) <span class="kw">%&gt;%</span>
  <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> <span class="no">lag0</span>:<span class="no">lag20</span>) <span class="kw">%&gt;%</span>
  <span class="fu">rename</span>(<span class="kw">ci_lo</span><span class="kw">=</span><span class="no">value</span>)

<span class="no">g_temp_ci_hi</span> <span class="kw">&lt;-</span> <span class="no">pred.temp</span>$<span class="no">matRRhigh</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu">rownames_to_column</span>(<span class="kw">var</span><span class="kw">=</span><span class="st">"var"</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">var</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">var</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">var</span><span class="kw">==</span><span class="fl">20</span> <span class="kw">|</span> <span class="no">var</span><span class="kw">==</span><span class="fl">30</span>) <span class="kw">%&gt;%</span>
  <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> <span class="no">lag0</span>:<span class="no">lag20</span>) <span class="kw">%&gt;%</span>
  <span class="fu">rename</span>(<span class="kw">ci_hi</span><span class="kw">=</span><span class="no">value</span>)

<span class="no">g2</span> <span class="kw">&lt;-</span> <span class="fu">left_join</span>(<span class="no">g_temp</span>, <span class="no">g_temp_ci_lo</span>)
<span class="no">g2</span> <span class="kw">&lt;-</span> <span class="fu">left_join</span>(<span class="no">g2</span>, <span class="no">g_temp_ci_hi</span>)

<span class="no">g</span> <span class="kw">&lt;-</span> <span class="fu">bind_rows</span>(<span class="no">g1</span>, <span class="no">g2</span>)

<span class="no">g</span> <span class="kw">&lt;-</span> <span class="no">g</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">lag</span> <span class="kw">=</span> <span class="fu">parse_number</span>(<span class="no">name</span>))

<span class="no">g</span> <span class="kw">%&gt;%</span>
  <span class="fu">ggplot</span>() +
  <span class="fu">geom_pointrange</span>(<span class="fu">aes</span>(<span class="kw">x</span><span class="kw">=</span><span class="no">lag</span>, <span class="kw">y</span><span class="kw">=</span><span class="no">value</span>, <span class="kw">ymin</span><span class="kw">=</span><span class="no">ci_lo</span>, <span class="kw">ymax</span><span class="kw">=</span><span class="no">ci_hi</span>, <span class="kw">group</span><span class="kw">=</span><span class="no">comparison</span>, <span class="kw">colour</span><span class="kw">=</span><span class="no">comparison</span>),
                  <span class="kw">position</span><span class="kw">=</span><span class="fu">position_jitterdodge</span>()) +
  <span class="fu">facet_grid</span>(<span class="no">comparison</span>~<span class="no">model</span>)</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-36-1.png" width="700"></p>
<p><br></p>
<p>Stratification by older population reconstruct cross-basis functions for rainfall and temperature given the optimal DoF</p>
<div class="sourceCode" id="cb100"><html><body><pre class="r">d_q_age2 &lt;- subset(d_q_age,age==2)

sort(d_q_age2$prcp, decreasing=FALSE)
  [1]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
  [7]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [13]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [19]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [25]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [31]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [37]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [43]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [49]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [55]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [61]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [67]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [73]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [79]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [85]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [91]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [97]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[103]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[109]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[115]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[121]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[127]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[133]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[139]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[145]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[151]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[157]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[163]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[169]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[175]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[181]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[187]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[193]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[199]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[205]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[211]  0.00000000  0.00000000  0.00000000  0.04285714  0.05000000  0.07142857
[217]  0.07500000  0.08333333  0.11428571  0.13333333  0.13333333  0.14285714
[223]  0.14285714  0.14285714  0.14285714  0.15714286  0.16666667  0.18571429
[229]  0.18571429  0.21428571  0.21666667  0.25000000  0.25000000  0.26666667
[235]  0.33333333  0.33333333  0.40000000  0.41666667  0.41666667  0.41666667
[241]  0.43333333  0.46666667  0.47142857  0.50000000  0.51428571  0.55000000
[247]  0.58000000  0.60000000  0.68571429  0.75714286  0.76000000  0.80000000
[253]  0.84285714  0.95000000  1.01428571  1.05000000  1.13333333  1.20000000
[259]  1.22000000  1.40000000  1.40000000  1.42000000  1.48333333  1.52857143
[265]  1.57142857  1.62857143  1.68333333  1.70000000  1.70000000  1.72000000
[271]  1.85000000  2.00000000  2.08000000  2.11666667  2.18000000  2.21428571
[277]  2.24000000  2.38000000  2.52500000  2.53333333  2.57142857  2.65000000
[283]  2.68571429  2.75000000  2.96666667  2.96666667  3.16666667  3.26666667
[289]  3.26666667  3.30000000  3.30000000  3.30000000  3.35000000  3.60000000
[295]  3.60000000  3.85000000  3.95000000  3.98333333  3.98333333  4.02000000
[301]  4.10000000  4.20000000  4.31666667  4.54285714  4.56666667  4.70000000
[307]  4.71428571  4.82000000  4.82500000  4.83333333  4.92000000  5.03333333
[313]  5.05000000  5.20000000  5.21428571  5.24000000  5.35000000  5.52857143
[319]  5.60000000  5.62857143  5.68333333  5.85000000  5.88333333  6.07142857
[325]  6.20000000  6.22500000  6.46666667  6.50000000  7.22500000  7.27142857
[331]  7.30000000  7.38333333  7.48333333  7.65714286  7.96000000  8.50000000
[337]  8.94285714  9.10000000  9.66666667  9.70000000  9.72000000  9.77500000
[343] 10.80000000 11.13333333 11.16000000 11.17500000 11.26666667 11.55000000
[349] 11.75000000 11.80000000 11.98571429 12.72857143 12.87500000 13.80000000
[355] 13.82500000 14.15714286 15.75000000 20.40000000 20.58571429 21.72500000
[361] 22.80000000 25.41428571 28.41428571 31.70000000
lagk=logknots(20, fun="ns", df=3)
vark=equalknots(d_q_age2$prcp, fun="ns", df=3)
cb.rain &lt;- crossbasis(d_q_age2$prcp, lag=20, argvar=list(knots=vark), arglag=list(knots=lagk))

sort(d_q_age2$temp, decreasing=FALSE)
  [1] 16.64286 17.90000 18.38571 18.53333 18.85714 18.96000 19.22857 19.25714
  [9] 19.52857 20.08571 20.16667 20.34286 20.41667 20.48333 20.58571 20.61667
 [17] 20.65714 20.67143 20.70000 20.77500 20.78571 20.96667 20.97143 21.03333
 [25] 21.04000 21.04286 21.07143 21.07143 21.10000 21.12857 21.18333 21.21429
 [33] 21.24286 21.27143 21.28000 21.33333 21.42000 21.45000 21.45714 21.47143
 [41] 21.55714 21.55714 21.56667 21.57143 21.58000 21.67143 21.72857 21.73333
 [49] 21.74286 21.80000 21.81429 21.84286 21.87143 21.90000 21.91429 21.94286
 [57] 22.08571 22.10000 22.22000 22.24286 22.24286 22.26667 22.28000 22.28571
 [65] 22.31429 22.33333 22.35714 22.40000 22.47143 22.50000 22.55714 22.56667
 [73] 22.57143 22.57500 22.58571 22.58571 22.60000 22.70000 22.75714 22.77143
 [81] 22.78000 22.78571 22.80000 22.86667 22.95714 22.98000 23.00000 23.02500
 [89] 23.02857 23.06667 23.10000 23.10000 23.11429 23.11429 23.22857 23.24286
 [97] 23.28571 23.31429 23.31667 23.32857 23.40000 23.40000 23.40000 23.41429
[105] 23.48000 23.48571 23.54286 23.71429 23.71429 23.75000 23.77143 23.77500
[113] 23.82857 23.82857 23.87143 23.90000 23.90000 23.90000 23.95714 24.00000
[121] 24.00000 24.02857 24.05000 24.05000 24.08571 24.08571 24.11429 24.15714
[129] 24.20000 24.23333 24.25000 24.25000 24.25000 24.25714 24.30000 24.32857
[137] 24.32857 24.35714 24.37143 24.37500 24.37500 24.45714 24.48000 24.52000
[145] 24.55714 24.57500 24.58000 24.61429 24.62857 24.65000 24.70000 24.70000
[153] 24.73333 24.77143 24.78000 24.78333 24.80000 24.82500 24.86667 24.87143
[161] 24.87500 24.88571 24.90000 24.91667 24.93333 24.95714 24.98333 25.00000
[169] 25.00000 25.01667 25.03333 25.06000 25.08571 25.10000 25.10000 25.11429
[177] 25.12857 25.14286 25.15714 25.17143 25.20000 25.20000 25.20000 25.20000
[185] 25.22500 25.22857 25.25714 25.27500 25.30000 25.31429 25.34286 25.35000
[193] 25.35714 25.38571 25.40000 25.44286 25.53333 25.60000 25.60000 25.62857
[201] 25.62857 25.64286 25.64286 25.64286 25.65000 25.68333 25.68571 25.70000
[209] 25.72857 25.75000 25.75714 25.76000 25.77143 25.78333 25.78571 25.78571
[217] 25.84286 25.86667 25.91429 25.92857 25.94286 25.98000 26.02500 26.03333
[225] 26.03333 26.04286 26.04286 26.08571 26.14000 26.15714 26.15714 26.16667
[233] 26.18333 26.18571 26.21429 26.21429 26.22000 26.22857 26.25000 26.25714
[241] 26.28000 26.33333 26.35000 26.41429 26.41667 26.41667 26.41667 26.42500
[249] 26.45000 26.47143 26.51429 26.53333 26.54286 26.60000 26.66667 26.67143
[257] 26.70000 26.71429 26.72857 26.76000 26.78571 26.80000 26.87143 26.87143
[265] 26.88571 26.92500 26.92857 26.94286 26.94286 26.95714 26.97143 27.00000
[273] 27.00000 27.01429 27.03333 27.05000 27.10000 27.21429 27.25714 27.27143
[281] 27.27143 27.27143 27.28333 27.28571 27.37143 27.40000 27.42857 27.45000
[289] 27.45714 27.54000 27.55000 27.61429 27.66000 27.75000 27.76000 27.77143
[297] 27.78571 27.80000 27.87143 27.87143 27.88333 27.98000 28.00000 28.00000
[305] 28.01429 28.02857 28.05714 28.05714 28.10000 28.16667 28.20000 28.22000
[313] 28.22857 28.25000 28.25714 28.25714 28.25714 28.27143 28.28333 28.32857
[321] 28.36000 28.36667 28.38571 28.45714 28.46667 28.48571 28.55000 28.57143
[329] 28.60000 28.60000 28.65714 28.66667 28.74286 28.77143 28.80000 28.87143
[337] 28.87500 28.97500 29.14286 29.16667 29.21667 29.25714 29.34000 29.43333
[345] 29.47143 29.61429 29.70000 29.71667 29.90000 30.02857 30.05000 30.23333
[353] 30.26000 30.46667 30.74286 30.88000 30.96667 30.97143 31.25714 31.32857
[361] 31.52857 31.67143 32.20000 34.00000
lagk=logknots(20, fun="ns", df=3)
vark=equalknots(d_q_age2$temp, fun="ns", df=3)
cb.temp &lt;- crossbasis(d_q_age2$temp, lag=20, argvar=list(knots=vark), arglag=list(knots=lagk))

#fit two models for rainfall and temperature seperately in generalised linear framework
model.r &lt;- glm(ncase ~ cb.rain + wk + year, family=quasipoisson(), na.action=na.exclude, d_q_age2)
model.t &lt;- glm(ncase ~ cb.temp + wk + year, family=quasipoisson(), na.action=na.exclude, d_q_age2)

#validate rainfall model by minimising high partial/auto-correlation (outside blue dotted lines)
pacf(residuals(model.r,type="deviance"),na.action=na.omit,main="Partial autocorrelation",xlim=c(0,20))</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-37-1.png" width="700"></p>
<div class="sourceCode" id="cb101"><html><body><pre class="r"><span class="no">model.r</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span>(<span class="no">model.r</span>,<span class="no">.</span>~<span class="no">.</span>+<span class="fu"><a href="https://rdrr.io/r/stats/lag.html">lag</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span>(<span class="no">model.r</span>,<span class="kw">type</span><span class="kw">=</span><span class="st">"deviance"</span>),<span class="fl">14</span>))

<span class="co">#validate temperature model by minimising high partial/auto-correlation (outside blue dotted lines)</span>
<span class="fu"><a href="https://rdrr.io/r/stats/acf.html">pacf</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span>(<span class="no">model.t</span>,<span class="kw">type</span><span class="kw">=</span><span class="st">"deviance"</span>),<span class="kw">na.action</span><span class="kw">=</span><span class="no">na.omit</span>,<span class="kw">main</span><span class="kw">=</span><span class="st">"Partial autocorrelation"</span>,<span class="kw">xlim</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>,<span class="fl">20</span>))</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-37-2.png" width="700"></p>
<div class="sourceCode" id="cb102"><html><body><pre class="r"><span class="no">model.t</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span>(<span class="no">model.t</span>,<span class="no">.</span>~<span class="no">.</span>+<span class="fu"><a href="https://rdrr.io/r/stats/lag.html">lag</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span>(<span class="no">model.t</span>,<span class="kw">type</span><span class="kw">=</span><span class="st">"deviance"</span>),<span class="fl">14</span>))

<span class="co">#predict (nowcast) the effect on TB notification of rainfall/temperature</span>
<span class="no">pred.rain</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/dlnm/man/crosspred.html">crosspred</a></span>(<span class="no">cb.rain</span>, <span class="no">model.r</span>, <span class="kw">cen</span><span class="kw">=</span><span class="fl">0</span>, <span class="kw">by</span><span class="kw">=</span><span class="fl">0.2</span>, <span class="kw">ci.level</span> <span class="kw">=</span> <span class="fl">0.50</span>)
<span class="no">pred.temp</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/dlnm/man/crosspred.html">crosspred</a></span>(<span class="no">cb.temp</span>, <span class="no">model.t</span>, <span class="kw">cen</span><span class="kw">=</span><span class="fl">17</span>, <span class="kw">by</span><span class="kw">=</span><span class="fl">0.2</span>)

<span class="co">#plot 3D, countour and curves for rainfall on TB notifications</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span>(<span class="kw">mgp</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">2.3</span>,<span class="fl">1</span>,<span class="fl">0</span>),<span class="kw">mai</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.9</span>,<span class="fl">0.9</span>,<span class="fl">0.3</span>,<span class="fl">0.2</span>))
<span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">pred.rain</span>, <span class="st">"contour"</span>, <span class="kw">key.title</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html">title</a></span>(<span class="st">"TBN"</span>), <span class="kw">plot.title</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html">title</a></span>(<span class="st">"A"</span>, <span class="kw">xlab</span> <span class="kw">=</span><span class="st">"Weekly mean rainfall (mm)"</span>, <span class="kw">ylab</span> <span class="kw">=</span> <span class="st">"Weekly lag"</span>, <span class="kw">cex.lab</span><span class="kw">=</span><span class="fl">1</span>, <span class="kw">cex.axis</span><span class="kw">=</span><span class="fl">1</span>))</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-37-3.png" width="700"></p>
<div class="sourceCode" id="cb103"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">pred.rain</span>, <span class="st">"slices"</span>, <span class="kw">type</span><span class="kw">=</span><span class="st">"p"</span>, <span class="kw">pch</span><span class="kw">=</span><span class="fl">19</span>, <span class="kw">cex</span><span class="kw">=</span><span class="fl">1.3</span>, <span class="kw">var</span><span class="kw">=</span><span class="fl">18</span>, <span class="kw">col</span><span class="kw">=</span><span class="st">"purple"</span>, <span class="kw">ci.level</span><span class="kw">=</span><span class="fl">0.5</span>, <span class="kw">ci</span><span class="kw">=</span><span class="st">"bars"</span>, <span class="kw">ylab</span><span class="kw">=</span><span class="st">"Report ratio"</span>, <span class="kw">xlab</span><span class="kw">=</span><span class="st">"Weekly lag"</span>, <span class="kw">main</span><span class="kw">=</span><span class="st">"B"</span>)</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-37-4.png" width="700"></p>
<div class="sourceCode" id="cb104"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">pred.rain</span>, <span class="st">"slices"</span>, <span class="kw">type</span><span class="kw">=</span><span class="st">"p"</span>, <span class="kw">pch</span><span class="kw">=</span><span class="fl">19</span>, <span class="kw">cex</span><span class="kw">=</span><span class="fl">1.3</span>, <span class="kw">var</span><span class="kw">=</span><span class="fl">30</span>, <span class="kw">col</span><span class="kw">=</span><span class="st">"purple"</span>, <span class="kw">ci.level</span><span class="kw">=</span><span class="fl">0.5</span>, <span class="kw">ci</span><span class="kw">=</span><span class="st">"bars"</span>, <span class="kw">ylab</span><span class="kw">=</span><span class="st">"Report ratio"</span>, <span class="kw">xlab</span><span class="kw">=</span><span class="st">"Weekly lag"</span>, <span class="kw">main</span><span class="kw">=</span><span class="st">"C"</span>)</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-37-5.png" width="700"></p>
<div class="sourceCode" id="cb105"><html><body><pre class="r">
<span class="co">#plot 3D, countour and curves for temperature on TB notifications</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span>(<span class="kw">mgp</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">2.3</span>,<span class="fl">1</span>,<span class="fl">0</span>),<span class="kw">mai</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.9</span>,<span class="fl">0.9</span>,<span class="fl">0.3</span>,<span class="fl">0.2</span>))
<span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">pred.temp</span>, <span class="st">"contour"</span>, <span class="kw">key.title</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html">title</a></span>(<span class="st">"TBN"</span>), <span class="kw">plot.title</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html">title</a></span>(<span class="st">"D"</span>, <span class="kw">xlab</span> <span class="kw">=</span><span class="st">"Weekly mean temperature (°C)"</span>, <span class="kw">ylab</span> <span class="kw">=</span> <span class="st">"Weekly lag"</span>, <span class="kw">cex.lab</span><span class="kw">=</span><span class="fl">1</span>, <span class="kw">cex.axis</span><span class="kw">=</span><span class="fl">1</span>))</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-37-6.png" width="700"></p>
<div class="sourceCode" id="cb106"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">pred.temp</span>, <span class="st">"slices"</span>, <span class="kw">type</span><span class="kw">=</span><span class="st">"p"</span>, <span class="kw">pch</span><span class="kw">=</span><span class="fl">19</span>, <span class="kw">cex</span><span class="kw">=</span><span class="fl">1.3</span>, <span class="kw">var</span><span class="kw">=</span><span class="fl">20</span>, <span class="kw">col</span><span class="kw">=</span><span class="st">"red2"</span>, <span class="kw">ci.level</span><span class="kw">=</span><span class="fl">0.5</span>, <span class="kw">ci</span><span class="kw">=</span><span class="st">"bars"</span>, <span class="kw">ylab</span><span class="kw">=</span><span class="st">"Report ratio"</span>, <span class="kw">xlab</span><span class="kw">=</span><span class="st">"Weekly lag"</span>, <span class="kw">main</span><span class="kw">=</span><span class="st">"E"</span>)</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-37-7.png" width="700"></p>
<div class="sourceCode" id="cb107"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">pred.temp</span>, <span class="st">"slices"</span>, <span class="kw">type</span><span class="kw">=</span><span class="st">"p"</span>, <span class="kw">pch</span><span class="kw">=</span><span class="fl">19</span>, <span class="kw">cex</span><span class="kw">=</span><span class="fl">1.3</span>, <span class="kw">var</span><span class="kw">=</span><span class="fl">30</span>, <span class="kw">col</span><span class="kw">=</span><span class="st">"red2"</span>, <span class="kw">ci.level</span><span class="kw">=</span><span class="fl">0.5</span>, <span class="kw">ci</span><span class="kw">=</span><span class="st">"bars"</span>, <span class="kw">ylab</span><span class="kw">=</span><span class="st">"Report ratio"</span>, <span class="kw">xlab</span><span class="kw">=</span><span class="st">"Weekly lag"</span>, <span class="kw">main</span><span class="kw">=</span><span class="st">"F"</span>)</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-37-8.png" width="700"></p>
<p>Extract the data for combined plot</p>
<div class="sourceCode" id="cb108"><html><body><pre class="r"><span class="co">#rainfall</span>
<span class="no">h_rain</span> <span class="kw">&lt;-</span> <span class="no">pred.rain</span>$<span class="no">matRRfit</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu">rownames_to_column</span>(<span class="kw">var</span><span class="kw">=</span><span class="st">"var"</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">var</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">var</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">var</span><span class="kw">==</span><span class="fl">18</span> <span class="kw">|</span> <span class="no">var</span><span class="kw">==</span><span class="fl">30</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">comparison</span> <span class="kw">=</span> <span class="fu">case_when</span>(<span class="no">var</span><span class="kw">==</span><span class="fl">18</span> ~ <span class="st">"Mid (18mm) vs. low (0mm)"</span>,
                                <span class="no">var</span><span class="kw">==</span><span class="fl">30</span> ~ <span class="st">"High (30mm) vs. low (0mm)"</span>),
         <span class="kw">variable</span><span class="kw">=</span><span class="st">"Old age"</span>,
         <span class="kw">model</span> <span class="kw">=</span> <span class="st">"Rainfall"</span>) <span class="kw">%&gt;%</span>
  <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> <span class="no">lag0</span>:<span class="no">lag20</span>)

<span class="no">h_rain_ci_lo</span> <span class="kw">&lt;-</span> <span class="no">pred.rain</span>$<span class="no">matRRlow</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu">rownames_to_column</span>(<span class="kw">var</span><span class="kw">=</span><span class="st">"var"</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">var</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">var</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">var</span><span class="kw">==</span><span class="fl">18</span> <span class="kw">|</span> <span class="no">var</span><span class="kw">==</span><span class="fl">30</span>) <span class="kw">%&gt;%</span>
  <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> <span class="no">lag0</span>:<span class="no">lag20</span>) <span class="kw">%&gt;%</span>
  <span class="fu">rename</span>(<span class="kw">ci_lo</span><span class="kw">=</span><span class="no">value</span>)

<span class="no">h_rain_ci_hi</span> <span class="kw">&lt;-</span> <span class="no">pred.rain</span>$<span class="no">matRRhigh</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu">rownames_to_column</span>(<span class="kw">var</span><span class="kw">=</span><span class="st">"var"</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">var</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">var</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">var</span><span class="kw">==</span><span class="fl">18</span> <span class="kw">|</span> <span class="no">var</span><span class="kw">==</span><span class="fl">30</span>) <span class="kw">%&gt;%</span>
  <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> <span class="no">lag0</span>:<span class="no">lag20</span>) <span class="kw">%&gt;%</span>
  <span class="fu">rename</span>(<span class="kw">ci_hi</span><span class="kw">=</span><span class="no">value</span>)

<span class="no">h1</span> <span class="kw">&lt;-</span> <span class="fu">left_join</span>(<span class="no">h_rain</span>, <span class="no">h_rain_ci_lo</span>)
<span class="no">h1</span> <span class="kw">&lt;-</span> <span class="fu">left_join</span>(<span class="no">h1</span>, <span class="no">h_rain_ci_hi</span>)

<span class="co">#temp</span>
<span class="no">h_temp</span> <span class="kw">&lt;-</span> <span class="no">pred.temp</span>$<span class="no">matRRfit</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu">rownames_to_column</span>(<span class="kw">var</span><span class="kw">=</span><span class="st">"var"</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">var</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">var</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">var</span><span class="kw">==</span><span class="fl">20</span> <span class="kw">|</span> <span class="no">var</span><span class="kw">==</span><span class="fl">30</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">comparison</span> <span class="kw">=</span> <span class="fu">case_when</span>(<span class="no">var</span><span class="kw">==</span><span class="fl">20</span> ~ <span class="st">"Mid (20°C) vs. low (17°C)"</span>,
                                <span class="no">var</span><span class="kw">==</span><span class="fl">30</span> ~ <span class="st">"High (30°C) vs. low (17°C)"</span>),
         <span class="kw">variable</span><span class="kw">=</span><span class="st">"Old age"</span>,
         <span class="kw">model</span> <span class="kw">=</span> <span class="st">"Temperature"</span>) <span class="kw">%&gt;%</span>
  <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> <span class="no">lag0</span>:<span class="no">lag20</span>)

<span class="no">h_temp_ci_lo</span> <span class="kw">&lt;-</span> <span class="no">pred.temp</span>$<span class="no">matRRlow</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu">rownames_to_column</span>(<span class="kw">var</span><span class="kw">=</span><span class="st">"var"</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">var</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">var</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">var</span><span class="kw">==</span><span class="fl">20</span> <span class="kw">|</span> <span class="no">var</span><span class="kw">==</span><span class="fl">30</span>) <span class="kw">%&gt;%</span>
  <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> <span class="no">lag0</span>:<span class="no">lag20</span>) <span class="kw">%&gt;%</span>
  <span class="fu">rename</span>(<span class="kw">ci_lo</span><span class="kw">=</span><span class="no">value</span>)

<span class="no">h_temp_ci_hi</span> <span class="kw">&lt;-</span> <span class="no">pred.temp</span>$<span class="no">matRRhigh</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu">rownames_to_column</span>(<span class="kw">var</span><span class="kw">=</span><span class="st">"var"</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">var</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">var</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">var</span><span class="kw">==</span><span class="fl">20</span> <span class="kw">|</span> <span class="no">var</span><span class="kw">==</span><span class="fl">30</span>) <span class="kw">%&gt;%</span>
  <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> <span class="no">lag0</span>:<span class="no">lag20</span>) <span class="kw">%&gt;%</span>
  <span class="fu">rename</span>(<span class="kw">ci_hi</span><span class="kw">=</span><span class="no">value</span>)

<span class="no">h2</span> <span class="kw">&lt;-</span> <span class="fu">left_join</span>(<span class="no">h_temp</span>, <span class="no">h_temp_ci_lo</span>)
<span class="no">h2</span> <span class="kw">&lt;-</span> <span class="fu">left_join</span>(<span class="no">h2</span>, <span class="no">h_temp_ci_hi</span>)

<span class="no">h</span> <span class="kw">&lt;-</span> <span class="fu">bind_rows</span>(<span class="no">h1</span>, <span class="no">h2</span>)

<span class="no">h</span> <span class="kw">&lt;-</span> <span class="no">h</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">lag</span> <span class="kw">=</span> <span class="fu">parse_number</span>(<span class="no">name</span>))

<span class="no">h</span> <span class="kw">%&gt;%</span>
  <span class="fu">ggplot</span>() +
  <span class="fu">geom_pointrange</span>(<span class="fu">aes</span>(<span class="kw">x</span><span class="kw">=</span><span class="no">lag</span>, <span class="kw">y</span><span class="kw">=</span><span class="no">value</span>, <span class="kw">ymin</span><span class="kw">=</span><span class="no">ci_lo</span>, <span class="kw">ymax</span><span class="kw">=</span><span class="no">ci_hi</span>, <span class="kw">group</span><span class="kw">=</span><span class="no">comparison</span>, <span class="kw">colour</span><span class="kw">=</span><span class="no">comparison</span>),
                  <span class="kw">position</span><span class="kw">=</span><span class="fu">position_jitterdodge</span>()) +
  <span class="fu">facet_grid</span>(<span class="no">comparison</span>~<span class="no">model</span>)</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-38-1.png" width="700"></p>
<p>stratification by microbiologically-confirmed TB (Xpert/smear positive) reconstruct cross-basis functions for rainfall and temperature given the optimal DoF</p>
<div class="sourceCode" id="cb109"><html><body><pre class="r">
d_q_micro0 &lt;- subset(d_q_micro,smr_xpert_any==0)

sort(d_q_micro0$prcp, decreasing=FALSE)
  [1]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
  [7]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [13]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [19]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [25]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [31]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [37]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [43]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [49]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [55]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [61]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [67]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [73]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [79]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [85]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [91]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [97]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[103]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[109]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[115]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[121]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[127]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[133]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[139]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[145]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[151]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[157]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[163]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[169]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[175]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[181]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[187]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[193]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[199]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[205]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[211]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[217]  0.04285714  0.04285714  0.05000000  0.07142857  0.07500000  0.08333333
[223]  0.11428571  0.13333333  0.13333333  0.14285714  0.14285714  0.14285714
[229]  0.14285714  0.15714286  0.16666667  0.18571429  0.18571429  0.21428571
[235]  0.21666667  0.25000000  0.25000000  0.26666667  0.33333333  0.33333333
[241]  0.40000000  0.41666667  0.41666667  0.41666667  0.43333333  0.46666667
[247]  0.47142857  0.50000000  0.51428571  0.55000000  0.58000000  0.60000000
[253]  0.62000000  0.68571429  0.75714286  0.76000000  0.80000000  0.84285714
[259]  0.95000000  0.96000000  1.01428571  1.05000000  1.13333333  1.20000000
[265]  1.22000000  1.40000000  1.40000000  1.42000000  1.48333333  1.52857143
[271]  1.57142857  1.62857143  1.68333333  1.70000000  1.70000000  1.72000000
[277]  1.85000000  2.00000000  2.08000000  2.11666667  2.18000000  2.21428571
[283]  2.24000000  2.38000000  2.52500000  2.53333333  2.57142857  2.65000000
[289]  2.68571429  2.75000000  2.87142857  2.96666667  2.96666667  3.16666667
[295]  3.26666667  3.26666667  3.30000000  3.30000000  3.30000000  3.35000000
[301]  3.60000000  3.60000000  3.81428571  3.85000000  3.95000000  3.98333333
[307]  3.98333333  4.02000000  4.10000000  4.20000000  4.31666667  4.54285714
[313]  4.56666667  4.70000000  4.71428571  4.82000000  4.82500000  4.83333333
[319]  4.92000000  5.03333333  5.05000000  5.20000000  5.21428571  5.24000000
[325]  5.35000000  5.52857143  5.60000000  5.62857143  5.68333333  5.85000000
[331]  5.88333333  6.07142857  6.20000000  6.22500000  6.46666667  6.50000000
[337]  7.22500000  7.27142857  7.30000000  7.38333333  7.48333333  7.65714286
[343]  7.96000000  8.50000000  8.94285714  9.10000000  9.66666667  9.70000000
[349]  9.72000000  9.77500000 10.80000000 11.13333333 11.16000000 11.17500000
[355] 11.26666667 11.55000000 11.75000000 11.80000000 11.98571429 12.72857143
[361] 12.87500000 13.80000000 13.82500000 14.15714286 14.58571429 15.75000000
[367] 20.40000000 20.58571429 21.72500000 22.80000000 25.41428571 28.41428571
[373] 31.70000000
lagk=logknots(20, fun="ns", df=3)
vark=equalknots(d_q_micro0$prcp, fun="ns", df=3)
cb.rain &lt;- crossbasis(d_q_micro0$prcp, lag=20, argvar=list(knots=vark), arglag=list(knots=lagk))

sort(d_q_micro0$temp, decreasing=FALSE)
  [1] 16.64286 17.90000 18.38571 18.53333 18.85714 18.96000 19.22857 19.25714
  [9] 19.52857 20.08571 20.16667 20.34286 20.41667 20.48333 20.58571 20.61667
 [17] 20.65714 20.67143 20.70000 20.77500 20.78571 20.96667 20.97143 21.03333
 [25] 21.04000 21.04286 21.07143 21.07143 21.10000 21.12857 21.18333 21.21429
 [33] 21.24286 21.27143 21.28000 21.33333 21.42000 21.45000 21.45714 21.47143
 [41] 21.55714 21.55714 21.56667 21.57143 21.58000 21.67143 21.71429 21.72857
 [49] 21.73333 21.74286 21.80000 21.81429 21.84286 21.87143 21.90000 21.90000
 [57] 21.91429 21.94286 22.08571 22.10000 22.22000 22.24286 22.24286 22.26667
 [65] 22.28000 22.28571 22.31429 22.33333 22.35714 22.40000 22.44286 22.47143
 [73] 22.50000 22.55714 22.56667 22.57143 22.57500 22.58571 22.58571 22.60000
 [81] 22.70000 22.75714 22.77143 22.78000 22.78571 22.80000 22.86667 22.95714
 [89] 22.98000 23.00000 23.02500 23.02857 23.06667 23.10000 23.10000 23.11429
 [97] 23.11429 23.22857 23.24286 23.28571 23.31429 23.31667 23.32857 23.34286
[105] 23.40000 23.40000 23.40000 23.41429 23.48000 23.48571 23.54286 23.67143
[113] 23.71429 23.71429 23.75000 23.77143 23.77500 23.82857 23.82857 23.87143
[121] 23.90000 23.90000 23.90000 23.95714 24.00000 24.00000 24.02857 24.05000
[129] 24.05000 24.08571 24.08571 24.11429 24.15714 24.20000 24.23333 24.25000
[137] 24.25000 24.25000 24.25714 24.30000 24.32857 24.32857 24.35714 24.37143
[145] 24.37500 24.37500 24.45714 24.48000 24.51429 24.52000 24.55714 24.57500
[153] 24.58000 24.61429 24.62857 24.65000 24.67143 24.70000 24.70000 24.73333
[161] 24.77143 24.78000 24.78333 24.80000 24.82500 24.86667 24.87143 24.87500
[169] 24.88571 24.90000 24.91667 24.93333 24.95714 24.98333 25.00000 25.00000
[177] 25.01667 25.03333 25.06000 25.08571 25.10000 25.10000 25.11429 25.12857
[185] 25.14286 25.15714 25.17143 25.20000 25.20000 25.20000 25.20000 25.22500
[193] 25.22857 25.25714 25.27500 25.30000 25.31429 25.34286 25.35000 25.35714
[201] 25.38571 25.40000 25.44286 25.53333 25.60000 25.60000 25.62857 25.62857
[209] 25.62857 25.64286 25.64286 25.64286 25.65000 25.68333 25.68571 25.70000
[217] 25.72857 25.75000 25.75714 25.76000 25.77143 25.78333 25.78571 25.78571
[225] 25.84286 25.86667 25.91429 25.92857 25.94286 25.98000 26.02500 26.03333
[233] 26.03333 26.04286 26.04286 26.08571 26.14000 26.15714 26.15714 26.16667
[241] 26.18333 26.18571 26.21429 26.21429 26.22000 26.22857 26.25000 26.25714
[249] 26.28000 26.33333 26.35000 26.41429 26.41667 26.41667 26.41667 26.42500
[257] 26.45000 26.47143 26.51429 26.53333 26.54286 26.60000 26.66667 26.67143
[265] 26.70000 26.71429 26.72857 26.76000 26.78571 26.80000 26.87143 26.87143
[273] 26.88571 26.92500 26.92857 26.94286 26.94286 26.95714 26.97143 27.00000
[281] 27.00000 27.01429 27.03333 27.05000 27.10000 27.21429 27.25714 27.27143
[289] 27.27143 27.27143 27.28333 27.28571 27.37143 27.40000 27.42857 27.45000
[297] 27.45714 27.54000 27.55000 27.61429 27.66000 27.75000 27.76000 27.77143
[305] 27.78571 27.80000 27.87143 27.87143 27.88333 27.98000 28.00000 28.00000
[313] 28.01429 28.02857 28.05714 28.05714 28.10000 28.16667 28.20000 28.22000
[321] 28.22857 28.25000 28.25714 28.25714 28.25714 28.27143 28.28333 28.32857
[329] 28.36000 28.36667 28.38571 28.45714 28.46667 28.48571 28.55000 28.57143
[337] 28.60000 28.60000 28.65714 28.66667 28.74286 28.77143 28.80000 28.87143
[345] 28.87500 28.97500 29.14286 29.16667 29.21667 29.25714 29.34000 29.43333
[353] 29.47143 29.61429 29.70000 29.71667 29.90000 30.02857 30.02857 30.05000
[361] 30.23333 30.26000 30.46667 30.74286 30.88000 30.96667 30.97143 31.25714
[369] 31.32857 31.52857 31.67143 32.20000 34.00000
lagk=logknots(20, fun="ns", df=3)
vark=equalknots(d_q_micro0$temp, fun="ns", df=3)
cb.temp &lt;- crossbasis(d_q_micro0$temp, lag=20, argvar=list(knots=vark), arglag=list(knots=lagk))

#fit two models for rainfall and temperature seperately in generalised linear framework
model.r &lt;- glm(ncase ~ cb.rain + wk + year, family=quasipoisson(), na.action=na.exclude, d_q_micro0)
model.t &lt;- glm(ncase ~ cb.temp + wk + year, family=quasipoisson(), na.action=na.exclude, d_q_micro0)

#validate rainfall model by minimising high partial/auto-correlation (outside blue dotted lines)
pacf(residuals(model.r,type="deviance"),na.action=na.omit,main="Partial autocorrelation",xlim=c(0,20))</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-39-1.png" width="700"></p>
<div class="sourceCode" id="cb110"><html><body><pre class="r">
<span class="co">#validate temperature model by minimising high partial/auto-correlation (outside blue dotted lines)</span>
<span class="fu"><a href="https://rdrr.io/r/stats/acf.html">pacf</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span>(<span class="no">model.t</span>,<span class="kw">type</span><span class="kw">=</span><span class="st">"deviance"</span>),<span class="kw">na.action</span><span class="kw">=</span><span class="no">na.omit</span>,<span class="kw">main</span><span class="kw">=</span><span class="st">"Partial autocorrelation"</span>,<span class="kw">xlim</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>,<span class="fl">20</span>))</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-39-2.png" width="700"></p>
<div class="sourceCode" id="cb111"><html><body><pre class="r">
<span class="co">#predict (nowcast) the effect on TB notification of rainfall/temperature</span>
<span class="no">pred.rain</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/dlnm/man/crosspred.html">crosspred</a></span>(<span class="no">cb.rain</span>, <span class="no">model.r</span>, <span class="kw">cen</span><span class="kw">=</span><span class="fl">0</span>, <span class="kw">by</span><span class="kw">=</span><span class="fl">0.2</span>)
<span class="no">pred.temp</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/dlnm/man/crosspred.html">crosspred</a></span>(<span class="no">cb.temp</span>, <span class="no">model.t</span>, <span class="kw">cen</span><span class="kw">=</span><span class="fl">17</span>, <span class="kw">by</span><span class="kw">=</span><span class="fl">0.2</span>)

<span class="co">#plot 3D, countour and curves for rainfall on TB notifications</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span>(<span class="kw">mgp</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">2.3</span>,<span class="fl">1</span>,<span class="fl">0</span>),<span class="kw">mai</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.9</span>,<span class="fl">0.9</span>,<span class="fl">0.3</span>,<span class="fl">0.2</span>))
<span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">pred.rain</span>, <span class="st">"contour"</span>, <span class="kw">key.title</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html">title</a></span>(<span class="st">"TBN"</span>), <span class="kw">plot.title</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html">title</a></span>(<span class="st">"A"</span>, <span class="kw">xlab</span> <span class="kw">=</span><span class="st">"Weekly mean rainfall (mm)"</span>, <span class="kw">ylab</span> <span class="kw">=</span> <span class="st">"Weekly lag"</span>, <span class="kw">cex.lab</span><span class="kw">=</span><span class="fl">1</span>, <span class="kw">cex.axis</span><span class="kw">=</span><span class="fl">1</span>))</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-39-3.png" width="700"></p>
<div class="sourceCode" id="cb112"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">pred.rain</span>, <span class="st">"slices"</span>, <span class="kw">type</span><span class="kw">=</span><span class="st">"p"</span>, <span class="kw">pch</span><span class="kw">=</span><span class="fl">19</span>, <span class="kw">cex</span><span class="kw">=</span><span class="fl">1.3</span>, <span class="kw">var</span><span class="kw">=</span><span class="fl">18</span>, <span class="kw">col</span><span class="kw">=</span><span class="st">"purple"</span>, <span class="kw">ci.level</span><span class="kw">=</span><span class="fl">0.5</span>, <span class="kw">ci</span><span class="kw">=</span><span class="st">"bars"</span>, <span class="kw">ylab</span><span class="kw">=</span><span class="st">"Report ratio"</span>, <span class="kw">xlab</span><span class="kw">=</span><span class="st">"Weekly lag"</span>, <span class="kw">main</span><span class="kw">=</span><span class="st">"B"</span>)</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-39-4.png" width="700"></p>
<div class="sourceCode" id="cb113"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">pred.rain</span>, <span class="st">"slices"</span>, <span class="kw">type</span><span class="kw">=</span><span class="st">"p"</span>, <span class="kw">pch</span><span class="kw">=</span><span class="fl">19</span>, <span class="kw">cex</span><span class="kw">=</span><span class="fl">1.3</span>, <span class="kw">var</span><span class="kw">=</span><span class="fl">30</span>, <span class="kw">col</span><span class="kw">=</span><span class="st">"purple"</span>, <span class="kw">ci.level</span><span class="kw">=</span><span class="fl">0.5</span>, <span class="kw">ci</span><span class="kw">=</span><span class="st">"bars"</span>, <span class="kw">ylab</span><span class="kw">=</span><span class="st">"Report ratio"</span>, <span class="kw">xlab</span><span class="kw">=</span><span class="st">"Weekly lag"</span>, <span class="kw">main</span><span class="kw">=</span><span class="st">"C"</span>)</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-39-5.png" width="700"></p>
<div class="sourceCode" id="cb114"><html><body><pre class="r">
<span class="co">#plot 3D, countour and curves for temperature on TB notifications</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span>(<span class="kw">mgp</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">2.3</span>,<span class="fl">1</span>,<span class="fl">0</span>),<span class="kw">mai</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.9</span>,<span class="fl">0.9</span>,<span class="fl">0.3</span>,<span class="fl">0.2</span>))
<span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">pred.temp</span>, <span class="st">"contour"</span>, <span class="kw">key.title</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html">title</a></span>(<span class="st">"TBN"</span>), <span class="kw">plot.title</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html">title</a></span>(<span class="st">"D"</span>, <span class="kw">xlab</span> <span class="kw">=</span><span class="st">"Weekly mean temperature (°C)"</span>, <span class="kw">ylab</span> <span class="kw">=</span> <span class="st">"Weekly lag"</span>, <span class="kw">cex.lab</span><span class="kw">=</span><span class="fl">1</span>, <span class="kw">cex.axis</span><span class="kw">=</span><span class="fl">1</span>))</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-39-6.png" width="700"></p>
<div class="sourceCode" id="cb115"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">pred.temp</span>, <span class="st">"slices"</span>, <span class="kw">type</span><span class="kw">=</span><span class="st">"p"</span>, <span class="kw">pch</span><span class="kw">=</span><span class="fl">19</span>, <span class="kw">cex</span><span class="kw">=</span><span class="fl">1.3</span>, <span class="kw">var</span><span class="kw">=</span><span class="fl">20</span>, <span class="kw">col</span><span class="kw">=</span><span class="st">"red2"</span>, <span class="kw">ci.level</span><span class="kw">=</span><span class="fl">0.5</span>, <span class="kw">ci</span><span class="kw">=</span><span class="st">"bars"</span>, <span class="kw">ylab</span><span class="kw">=</span><span class="st">"Report ratio"</span>, <span class="kw">xlab</span><span class="kw">=</span><span class="st">"Weekly lag"</span>, <span class="kw">main</span><span class="kw">=</span><span class="st">"E"</span>)</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-39-7.png" width="700"></p>
<div class="sourceCode" id="cb116"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">pred.temp</span>, <span class="st">"slices"</span>, <span class="kw">type</span><span class="kw">=</span><span class="st">"p"</span>, <span class="kw">pch</span><span class="kw">=</span><span class="fl">19</span>, <span class="kw">cex</span><span class="kw">=</span><span class="fl">1.3</span>, <span class="kw">var</span><span class="kw">=</span><span class="fl">30</span>, <span class="kw">col</span><span class="kw">=</span><span class="st">"red2"</span>, <span class="kw">ci.level</span><span class="kw">=</span><span class="fl">0.5</span>, <span class="kw">ci</span><span class="kw">=</span><span class="st">"bars"</span>, <span class="kw">ylab</span><span class="kw">=</span><span class="st">"Report ratio"</span>, <span class="kw">xlab</span><span class="kw">=</span><span class="st">"Weekly lag"</span>, <span class="kw">main</span><span class="kw">=</span><span class="st">"F"</span>)</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-39-8.png" width="700"></p>
<p><br></p>
<p>Extract the data for combined plot</p>
<div class="sourceCode" id="cb117"><html><body><pre class="r"><span class="co">#rainfall</span>
<span class="no">i_rain</span> <span class="kw">&lt;-</span> <span class="no">pred.rain</span>$<span class="no">matRRfit</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu">rownames_to_column</span>(<span class="kw">var</span><span class="kw">=</span><span class="st">"var"</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">var</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">var</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">var</span><span class="kw">==</span><span class="fl">18</span> <span class="kw">|</span> <span class="no">var</span><span class="kw">==</span><span class="fl">30</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">comparison</span> <span class="kw">=</span> <span class="fu">case_when</span>(<span class="no">var</span><span class="kw">==</span><span class="fl">18</span> ~ <span class="st">"Mid (18mm) vs. low (0mm)"</span>,
                                <span class="no">var</span><span class="kw">==</span><span class="fl">30</span> ~ <span class="st">"High (30mm) vs. low (0mm)"</span>),
         <span class="kw">variable</span><span class="kw">=</span><span class="st">"Smear/Xpert negative"</span>,
         <span class="kw">model</span> <span class="kw">=</span> <span class="st">"Rainfall"</span>) <span class="kw">%&gt;%</span>
  <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> <span class="no">lag0</span>:<span class="no">lag20</span>)

<span class="no">i_rain_ci_lo</span> <span class="kw">&lt;-</span> <span class="no">pred.rain</span>$<span class="no">matRRlow</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu">rownames_to_column</span>(<span class="kw">var</span><span class="kw">=</span><span class="st">"var"</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">var</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">var</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">var</span><span class="kw">==</span><span class="fl">18</span> <span class="kw">|</span> <span class="no">var</span><span class="kw">==</span><span class="fl">30</span>) <span class="kw">%&gt;%</span>
  <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> <span class="no">lag0</span>:<span class="no">lag20</span>) <span class="kw">%&gt;%</span>
  <span class="fu">rename</span>(<span class="kw">ci_lo</span><span class="kw">=</span><span class="no">value</span>)

<span class="no">i_rain_ci_hi</span> <span class="kw">&lt;-</span> <span class="no">pred.rain</span>$<span class="no">matRRhigh</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu">rownames_to_column</span>(<span class="kw">var</span><span class="kw">=</span><span class="st">"var"</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">var</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">var</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">var</span><span class="kw">==</span><span class="fl">18</span> <span class="kw">|</span> <span class="no">var</span><span class="kw">==</span><span class="fl">30</span>) <span class="kw">%&gt;%</span>
  <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> <span class="no">lag0</span>:<span class="no">lag20</span>) <span class="kw">%&gt;%</span>
  <span class="fu">rename</span>(<span class="kw">ci_hi</span><span class="kw">=</span><span class="no">value</span>)

<span class="no">i1</span> <span class="kw">&lt;-</span> <span class="fu">left_join</span>(<span class="no">i_rain</span>, <span class="no">i_rain_ci_lo</span>)
<span class="no">i1</span> <span class="kw">&lt;-</span> <span class="fu">left_join</span>(<span class="no">i1</span>, <span class="no">i_rain_ci_hi</span>)

<span class="co">#temp</span>
<span class="no">i_temp</span> <span class="kw">&lt;-</span> <span class="no">pred.temp</span>$<span class="no">matRRfit</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu">rownames_to_column</span>(<span class="kw">var</span><span class="kw">=</span><span class="st">"var"</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">var</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">var</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">var</span><span class="kw">==</span><span class="fl">20</span> <span class="kw">|</span> <span class="no">var</span><span class="kw">==</span><span class="fl">30</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">comparison</span> <span class="kw">=</span> <span class="fu">case_when</span>(<span class="no">var</span><span class="kw">==</span><span class="fl">20</span> ~ <span class="st">"Mid (20°C) vs. low (17°C)"</span>,
                                <span class="no">var</span><span class="kw">==</span><span class="fl">30</span> ~ <span class="st">"High (30°C) vs. low (17°C)"</span>),
         <span class="kw">variable</span><span class="kw">=</span><span class="st">"Smear/Xpert negative"</span>,
         <span class="kw">model</span> <span class="kw">=</span> <span class="st">"Temperature"</span>) <span class="kw">%&gt;%</span>
  <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> <span class="no">lag0</span>:<span class="no">lag20</span>)

<span class="no">i_temp_ci_lo</span> <span class="kw">&lt;-</span> <span class="no">pred.temp</span>$<span class="no">matRRlow</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu">rownames_to_column</span>(<span class="kw">var</span><span class="kw">=</span><span class="st">"var"</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">var</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">var</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">var</span><span class="kw">==</span><span class="fl">20</span> <span class="kw">|</span> <span class="no">var</span><span class="kw">==</span><span class="fl">30</span>) <span class="kw">%&gt;%</span>
  <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> <span class="no">lag0</span>:<span class="no">lag20</span>) <span class="kw">%&gt;%</span>
  <span class="fu">rename</span>(<span class="kw">ci_lo</span><span class="kw">=</span><span class="no">value</span>)

<span class="no">i_temp_ci_hi</span> <span class="kw">&lt;-</span> <span class="no">pred.temp</span>$<span class="no">matRRhigh</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu">rownames_to_column</span>(<span class="kw">var</span><span class="kw">=</span><span class="st">"var"</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">var</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">var</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">var</span><span class="kw">==</span><span class="fl">20</span> <span class="kw">|</span> <span class="no">var</span><span class="kw">==</span><span class="fl">30</span>) <span class="kw">%&gt;%</span>
  <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> <span class="no">lag0</span>:<span class="no">lag20</span>) <span class="kw">%&gt;%</span>
  <span class="fu">rename</span>(<span class="kw">ci_hi</span><span class="kw">=</span><span class="no">value</span>)

<span class="no">i2</span> <span class="kw">&lt;-</span> <span class="fu">left_join</span>(<span class="no">i_temp</span>, <span class="no">i_temp_ci_lo</span>)
<span class="no">i2</span> <span class="kw">&lt;-</span> <span class="fu">left_join</span>(<span class="no">i2</span>, <span class="no">i_temp_ci_hi</span>)

<span class="no">i</span> <span class="kw">&lt;-</span> <span class="fu">bind_rows</span>(<span class="no">i1</span>, <span class="no">i2</span>)

<span class="no">i</span> <span class="kw">&lt;-</span> <span class="no">i</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">lag</span> <span class="kw">=</span> <span class="fu">parse_number</span>(<span class="no">name</span>))

<span class="no">i</span> <span class="kw">%&gt;%</span>
  <span class="fu">ggplot</span>() +
  <span class="fu">geom_pointrange</span>(<span class="fu">aes</span>(<span class="kw">x</span><span class="kw">=</span><span class="no">lag</span>, <span class="kw">y</span><span class="kw">=</span><span class="no">value</span>, <span class="kw">ymin</span><span class="kw">=</span><span class="no">ci_lo</span>, <span class="kw">ymax</span><span class="kw">=</span><span class="no">ci_hi</span>, <span class="kw">group</span><span class="kw">=</span><span class="no">comparison</span>, <span class="kw">colour</span><span class="kw">=</span><span class="no">comparison</span>),
                  <span class="kw">position</span><span class="kw">=</span><span class="fu">position_jitterdodge</span>()) +
  <span class="fu">facet_grid</span>(<span class="no">comparison</span>~<span class="no">model</span>)</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-40-1.png" width="700"></p>
<p><br></p>
<p>stratification by smear/xpert positive reconstruct cross-basis functions for rainfall and temperature given the optimal DoF</p>
<div class="sourceCode" id="cb118"><html><body><pre class="r">
d_q_micro1 &lt;- subset(d_q_micro,smr_xpert_any==1)

sort(d_q_micro1$prcp, decreasing=FALSE)
  [1]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
  [7]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [13]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [19]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [25]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [31]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [37]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [43]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [49]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [55]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [61]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [67]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [73]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [79]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [85]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [91]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
 [97]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[103]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[109]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[115]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[121]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[127]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[133]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[139]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[145]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[151]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[157]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[163]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[169]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[175]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[181]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[187]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[193]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[199]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[205]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[211]  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
[217]  0.04285714  0.04285714  0.05000000  0.07142857  0.07500000  0.08333333
[223]  0.11428571  0.13333333  0.13333333  0.14285714  0.14285714  0.14285714
[229]  0.14285714  0.15714286  0.16666667  0.18571429  0.18571429  0.21428571
[235]  0.21666667  0.25000000  0.25000000  0.26666667  0.33333333  0.33333333
[241]  0.40000000  0.41666667  0.41666667  0.41666667  0.43333333  0.46666667
[247]  0.47142857  0.50000000  0.51428571  0.55000000  0.58000000  0.60000000
[253]  0.62000000  0.68571429  0.75714286  0.76000000  0.80000000  0.84285714
[259]  0.95000000  0.96000000  1.01428571  1.05000000  1.13333333  1.20000000
[265]  1.22000000  1.40000000  1.40000000  1.42000000  1.48333333  1.52857143
[271]  1.57142857  1.62857143  1.68333333  1.70000000  1.70000000  1.72000000
[277]  1.85000000  2.00000000  2.08000000  2.11666667  2.18000000  2.21428571
[283]  2.24000000  2.38000000  2.52500000  2.53333333  2.57142857  2.65000000
[289]  2.68571429  2.75000000  2.87142857  2.96666667  2.96666667  3.16666667
[295]  3.26666667  3.26666667  3.30000000  3.30000000  3.30000000  3.35000000
[301]  3.60000000  3.60000000  3.81428571  3.85000000  3.95000000  3.98333333
[307]  3.98333333  4.02000000  4.10000000  4.20000000  4.31666667  4.54285714
[313]  4.56666667  4.70000000  4.71428571  4.82000000  4.82500000  4.83333333
[319]  4.92000000  5.03333333  5.05000000  5.20000000  5.21428571  5.24000000
[325]  5.35000000  5.52857143  5.60000000  5.62857143  5.68333333  5.85000000
[331]  5.88333333  6.07142857  6.20000000  6.22500000  6.46666667  6.50000000
[337]  7.22500000  7.27142857  7.30000000  7.38333333  7.48333333  7.65714286
[343]  7.96000000  8.50000000  8.94285714  9.10000000  9.66666667  9.70000000
[349]  9.72000000  9.77500000 10.80000000 11.13333333 11.16000000 11.17500000
[355] 11.26666667 11.55000000 11.75000000 11.80000000 11.98571429 12.72857143
[361] 12.87500000 13.80000000 13.82500000 14.15714286 14.58571429 15.75000000
[367] 20.40000000 20.58571429 21.72500000 22.80000000 25.41428571 28.41428571
[373] 31.70000000
lagk=logknots(20, fun="ns", df=3)
vark=equalknots(d_q_micro1$prcp, fun="ns", df=3)
cb.rain &lt;- crossbasis(d_q_micro1$prcp, lag=20, argvar=list(knots=vark), arglag=list(knots=lagk))

sort(d_q_micro1$temp, decreasing=FALSE)
  [1] 16.64286 17.90000 18.38571 18.53333 18.85714 18.96000 19.22857 19.25714
  [9] 19.52857 20.08571 20.16667 20.34286 20.41667 20.48333 20.58571 20.61667
 [17] 20.65714 20.67143 20.70000 20.77500 20.78571 20.96667 20.97143 21.03333
 [25] 21.04000 21.04286 21.07143 21.07143 21.10000 21.12857 21.18333 21.21429
 [33] 21.24286 21.27143 21.28000 21.33333 21.42000 21.45000 21.45714 21.47143
 [41] 21.55714 21.55714 21.56667 21.57143 21.58000 21.67143 21.71429 21.72857
 [49] 21.73333 21.74286 21.80000 21.81429 21.84286 21.87143 21.90000 21.90000
 [57] 21.91429 21.94286 22.08571 22.10000 22.22000 22.24286 22.24286 22.26667
 [65] 22.28000 22.28571 22.31429 22.33333 22.35714 22.40000 22.44286 22.47143
 [73] 22.50000 22.55714 22.56667 22.57143 22.57500 22.58571 22.58571 22.60000
 [81] 22.70000 22.75714 22.77143 22.78000 22.78571 22.80000 22.86667 22.95714
 [89] 22.98000 23.00000 23.02500 23.02857 23.06667 23.10000 23.10000 23.11429
 [97] 23.11429 23.22857 23.24286 23.28571 23.31429 23.31667 23.32857 23.34286
[105] 23.40000 23.40000 23.40000 23.41429 23.48000 23.48571 23.54286 23.67143
[113] 23.71429 23.71429 23.75000 23.77143 23.77500 23.82857 23.82857 23.87143
[121] 23.90000 23.90000 23.90000 23.95714 24.00000 24.00000 24.02857 24.05000
[129] 24.05000 24.08571 24.08571 24.11429 24.15714 24.20000 24.23333 24.25000
[137] 24.25000 24.25000 24.25714 24.30000 24.32857 24.32857 24.35714 24.37143
[145] 24.37500 24.37500 24.45714 24.48000 24.51429 24.52000 24.55714 24.57500
[153] 24.58000 24.61429 24.62857 24.65000 24.67143 24.70000 24.70000 24.73333
[161] 24.77143 24.78000 24.78333 24.80000 24.82500 24.86667 24.87143 24.87500
[169] 24.88571 24.90000 24.91667 24.93333 24.95714 24.98333 25.00000 25.00000
[177] 25.01667 25.03333 25.06000 25.08571 25.10000 25.10000 25.11429 25.12857
[185] 25.14286 25.15714 25.17143 25.20000 25.20000 25.20000 25.20000 25.22500
[193] 25.22857 25.25714 25.27500 25.30000 25.31429 25.34286 25.35000 25.35714
[201] 25.38571 25.40000 25.44286 25.53333 25.60000 25.60000 25.62857 25.62857
[209] 25.62857 25.64286 25.64286 25.64286 25.65000 25.68333 25.68571 25.70000
[217] 25.72857 25.75000 25.75714 25.76000 25.77143 25.78333 25.78571 25.78571
[225] 25.84286 25.86667 25.91429 25.92857 25.94286 25.98000 26.02500 26.03333
[233] 26.03333 26.04286 26.04286 26.08571 26.14000 26.15714 26.15714 26.16667
[241] 26.18333 26.18571 26.21429 26.21429 26.22000 26.22857 26.25000 26.25714
[249] 26.28000 26.33333 26.35000 26.41429 26.41667 26.41667 26.41667 26.42500
[257] 26.45000 26.47143 26.51429 26.53333 26.54286 26.60000 26.66667 26.67143
[265] 26.70000 26.71429 26.72857 26.76000 26.78571 26.80000 26.87143 26.87143
[273] 26.88571 26.92500 26.92857 26.94286 26.94286 26.95714 26.97143 27.00000
[281] 27.00000 27.01429 27.03333 27.05000 27.10000 27.21429 27.25714 27.27143
[289] 27.27143 27.27143 27.28333 27.28571 27.37143 27.40000 27.42857 27.45000
[297] 27.45714 27.54000 27.55000 27.61429 27.66000 27.75000 27.76000 27.77143
[305] 27.78571 27.80000 27.87143 27.87143 27.88333 27.98000 28.00000 28.00000
[313] 28.01429 28.02857 28.05714 28.05714 28.10000 28.16667 28.20000 28.22000
[321] 28.22857 28.25000 28.25714 28.25714 28.25714 28.27143 28.28333 28.32857
[329] 28.36000 28.36667 28.38571 28.45714 28.46667 28.48571 28.55000 28.57143
[337] 28.60000 28.60000 28.65714 28.66667 28.74286 28.77143 28.80000 28.87143
[345] 28.87500 28.97500 29.14286 29.16667 29.21667 29.25714 29.34000 29.43333
[353] 29.47143 29.61429 29.70000 29.71667 29.90000 30.02857 30.02857 30.05000
[361] 30.23333 30.26000 30.46667 30.74286 30.88000 30.96667 30.97143 31.25714
[369] 31.32857 31.52857 31.67143 32.20000 34.00000
lagk=logknots(20, fun="ns", df=3)
vark=equalknots(d_q_micro1$temp, fun="ns", df=3)
cb.temp &lt;- crossbasis(d_q_micro1$temp, lag=20, argvar=list(knots=vark), arglag=list(knots=lagk))

#fit two models for rainfall and temperature seperately in generalised linear framework
model.r &lt;- glm(ncase ~ cb.rain + wk + year, family=quasipoisson(), na.action=na.exclude, d_q_micro1)
model.t &lt;- glm(ncase ~ cb.temp + wk + year, family=quasipoisson(), na.action=na.exclude, d_q_micro1)

#validate rainfall model by minimising high partial/auto-correlation (outside blue dotted lines)
pacf(residuals(model.r,type="deviance"),na.action=na.omit,main="Partial autocorrelation",xlim=c(0,20))</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-41-1.png" width="700"></p>
<div class="sourceCode" id="cb119"><html><body><pre class="r">
<span class="co">#validate temperature model by minimising high partial/auto-correlation (outside blue dotted lines)</span>
<span class="fu"><a href="https://rdrr.io/r/stats/acf.html">pacf</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span>(<span class="no">model.t</span>,<span class="kw">type</span><span class="kw">=</span><span class="st">"deviance"</span>),<span class="kw">na.action</span><span class="kw">=</span><span class="no">na.omit</span>,<span class="kw">main</span><span class="kw">=</span><span class="st">"Partial autocorrelation"</span>,<span class="kw">xlim</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>,<span class="fl">20</span>))</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-41-2.png" width="700"></p>
<div class="sourceCode" id="cb120"><html><body><pre class="r"><span class="no">model.t</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span>(<span class="no">model.t</span>,<span class="no">.</span>~<span class="no">.</span>+<span class="fu"><a href="https://rdrr.io/r/stats/lag.html">lag</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span>(<span class="no">model.t</span>,<span class="kw">type</span><span class="kw">=</span><span class="st">"deviance"</span>),<span class="fl">9</span>))

<span class="co">#predict (nowcast) the effect on TB notification of rainfall/temperature</span>
<span class="no">pred.rain</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/dlnm/man/crosspred.html">crosspred</a></span>(<span class="no">cb.rain</span>, <span class="no">model.r</span>, <span class="kw">cen</span><span class="kw">=</span><span class="fl">0</span>, <span class="kw">by</span><span class="kw">=</span><span class="fl">0.2</span>)
<span class="no">pred.temp</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/dlnm/man/crosspred.html">crosspred</a></span>(<span class="no">cb.temp</span>, <span class="no">model.t</span>, <span class="kw">cen</span><span class="kw">=</span><span class="fl">17</span>, <span class="kw">by</span><span class="kw">=</span><span class="fl">0.2</span>)

<span class="co">#plot 3D, countour and curves for rainfall on TB notifications</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span>(<span class="kw">mgp</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">2.3</span>,<span class="fl">1</span>,<span class="fl">0</span>),<span class="kw">mai</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.9</span>,<span class="fl">0.9</span>,<span class="fl">0.3</span>,<span class="fl">0.2</span>))
<span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">pred.rain</span>, <span class="st">"contour"</span>, <span class="kw">key.title</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html">title</a></span>(<span class="st">"TBN"</span>), <span class="kw">plot.title</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html">title</a></span>(<span class="st">"A"</span>, <span class="kw">xlab</span> <span class="kw">=</span><span class="st">"Weekly mean rainfall (mm)"</span>, <span class="kw">ylab</span> <span class="kw">=</span> <span class="st">"Weekly lag"</span>, <span class="kw">cex.lab</span><span class="kw">=</span><span class="fl">1</span>, <span class="kw">cex.axis</span><span class="kw">=</span><span class="fl">1</span>))</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-41-3.png" width="700"></p>
<div class="sourceCode" id="cb121"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">pred.rain</span>, <span class="st">"slices"</span>, <span class="kw">type</span><span class="kw">=</span><span class="st">"p"</span>, <span class="kw">pch</span><span class="kw">=</span><span class="fl">19</span>, <span class="kw">cex</span><span class="kw">=</span><span class="fl">1.3</span>, <span class="kw">var</span><span class="kw">=</span><span class="fl">18</span>, <span class="kw">col</span><span class="kw">=</span><span class="st">"purple"</span>, <span class="kw">ci.level</span><span class="kw">=</span><span class="fl">0.5</span>, <span class="kw">ci</span><span class="kw">=</span><span class="st">"bars"</span>, <span class="kw">ylab</span><span class="kw">=</span><span class="st">"Report ratio"</span>, <span class="kw">xlab</span><span class="kw">=</span><span class="st">"Weekly lag"</span>, <span class="kw">main</span><span class="kw">=</span><span class="st">"B"</span>)</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-41-4.png" width="700"></p>
<div class="sourceCode" id="cb122"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">pred.rain</span>, <span class="st">"slices"</span>, <span class="kw">type</span><span class="kw">=</span><span class="st">"p"</span>, <span class="kw">pch</span><span class="kw">=</span><span class="fl">19</span>, <span class="kw">cex</span><span class="kw">=</span><span class="fl">1.3</span>, <span class="kw">var</span><span class="kw">=</span><span class="fl">30</span>, <span class="kw">col</span><span class="kw">=</span><span class="st">"purple"</span>, <span class="kw">ci.level</span><span class="kw">=</span><span class="fl">0.5</span>, <span class="kw">ci</span><span class="kw">=</span><span class="st">"bars"</span>, <span class="kw">ylab</span><span class="kw">=</span><span class="st">"Report ratio"</span>, <span class="kw">xlab</span><span class="kw">=</span><span class="st">"Weekly lag"</span>, <span class="kw">main</span><span class="kw">=</span><span class="st">"C"</span>)</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-41-5.png" width="700"></p>
<div class="sourceCode" id="cb123"><html><body><pre class="r">
<span class="co">#plot 3D, countour and curves for temperature on TB notifications</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span>(<span class="kw">mgp</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">2.3</span>,<span class="fl">1</span>,<span class="fl">0</span>),<span class="kw">mai</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.9</span>,<span class="fl">0.9</span>,<span class="fl">0.3</span>,<span class="fl">0.2</span>))
<span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">pred.temp</span>, <span class="st">"contour"</span>, <span class="kw">key.title</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html">title</a></span>(<span class="st">"TBN"</span>), <span class="kw">plot.title</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html">title</a></span>(<span class="st">"D"</span>, <span class="kw">xlab</span> <span class="kw">=</span><span class="st">"Weekly mean temperature (°C)"</span>, <span class="kw">ylab</span> <span class="kw">=</span> <span class="st">"Weekly lag"</span>, <span class="kw">cex.lab</span><span class="kw">=</span><span class="fl">1</span>, <span class="kw">cex.axis</span><span class="kw">=</span><span class="fl">1</span>))</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-41-6.png" width="700"></p>
<div class="sourceCode" id="cb124"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">pred.temp</span>, <span class="st">"slices"</span>, <span class="kw">type</span><span class="kw">=</span><span class="st">"p"</span>, <span class="kw">pch</span><span class="kw">=</span><span class="fl">19</span>, <span class="kw">cex</span><span class="kw">=</span><span class="fl">1.3</span>, <span class="kw">var</span><span class="kw">=</span><span class="fl">20</span>, <span class="kw">col</span><span class="kw">=</span><span class="st">"red2"</span>, <span class="kw">ci.level</span><span class="kw">=</span><span class="fl">0.5</span>, <span class="kw">ci</span><span class="kw">=</span><span class="st">"bars"</span>, <span class="kw">ylab</span><span class="kw">=</span><span class="st">"Report ratio"</span>, <span class="kw">xlab</span><span class="kw">=</span><span class="st">"Weekly lag"</span>, <span class="kw">main</span><span class="kw">=</span><span class="st">"E"</span>)</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-41-7.png" width="700"></p>
<div class="sourceCode" id="cb125"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">pred.temp</span>, <span class="st">"slices"</span>, <span class="kw">type</span><span class="kw">=</span><span class="st">"p"</span>, <span class="kw">pch</span><span class="kw">=</span><span class="fl">19</span>, <span class="kw">cex</span><span class="kw">=</span><span class="fl">1.3</span>, <span class="kw">var</span><span class="kw">=</span><span class="fl">30</span>, <span class="kw">col</span><span class="kw">=</span><span class="st">"red2"</span>, <span class="kw">ci.level</span><span class="kw">=</span><span class="fl">0.5</span>, <span class="kw">ci</span><span class="kw">=</span><span class="st">"bars"</span>, <span class="kw">ylab</span><span class="kw">=</span><span class="st">"Report ratio"</span>, <span class="kw">xlab</span><span class="kw">=</span><span class="st">"Weekly lag"</span>, <span class="kw">main</span><span class="kw">=</span><span class="st">"F"</span>)</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-41-8.png" width="700"></p>
<p><br></p>
<p>Extract the data for combined plot</p>
<div class="sourceCode" id="cb126"><html><body><pre class="r"><span class="co">#rainfall</span>
<span class="no">j_rain</span> <span class="kw">&lt;-</span> <span class="no">pred.rain</span>$<span class="no">matRRfit</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu">rownames_to_column</span>(<span class="kw">var</span><span class="kw">=</span><span class="st">"var"</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">var</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">var</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">var</span><span class="kw">==</span><span class="fl">18</span> <span class="kw">|</span> <span class="no">var</span><span class="kw">==</span><span class="fl">30</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">comparison</span> <span class="kw">=</span> <span class="fu">case_when</span>(<span class="no">var</span><span class="kw">==</span><span class="fl">18</span> ~ <span class="st">"Mid (18mm) vs. low (0mm)"</span>,
                                <span class="no">var</span><span class="kw">==</span><span class="fl">30</span> ~ <span class="st">"High (30mm) vs. low (0mm)"</span>),
         <span class="kw">variable</span><span class="kw">=</span><span class="st">"Smear/Xpert positive"</span>,
         <span class="kw">model</span> <span class="kw">=</span> <span class="st">"Rainfall"</span>) <span class="kw">%&gt;%</span>
  <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> <span class="no">lag0</span>:<span class="no">lag20</span>)

<span class="no">j_rain_ci_lo</span> <span class="kw">&lt;-</span> <span class="no">pred.rain</span>$<span class="no">matRRlow</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu">rownames_to_column</span>(<span class="kw">var</span><span class="kw">=</span><span class="st">"var"</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">var</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">var</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">var</span><span class="kw">==</span><span class="fl">18</span> <span class="kw">|</span> <span class="no">var</span><span class="kw">==</span><span class="fl">30</span>) <span class="kw">%&gt;%</span>
  <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> <span class="no">lag0</span>:<span class="no">lag20</span>) <span class="kw">%&gt;%</span>
  <span class="fu">rename</span>(<span class="kw">ci_lo</span><span class="kw">=</span><span class="no">value</span>)

<span class="no">j_rain_ci_hi</span> <span class="kw">&lt;-</span> <span class="no">pred.rain</span>$<span class="no">matRRhigh</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu">rownames_to_column</span>(<span class="kw">var</span><span class="kw">=</span><span class="st">"var"</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">var</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">var</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">var</span><span class="kw">==</span><span class="fl">18</span> <span class="kw">|</span> <span class="no">var</span><span class="kw">==</span><span class="fl">30</span>) <span class="kw">%&gt;%</span>
  <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> <span class="no">lag0</span>:<span class="no">lag20</span>) <span class="kw">%&gt;%</span>
  <span class="fu">rename</span>(<span class="kw">ci_hi</span><span class="kw">=</span><span class="no">value</span>)

<span class="no">j1</span> <span class="kw">&lt;-</span> <span class="fu">left_join</span>(<span class="no">j_rain</span>, <span class="no">j_rain_ci_lo</span>)
<span class="no">j1</span> <span class="kw">&lt;-</span> <span class="fu">left_join</span>(<span class="no">j1</span>, <span class="no">j_rain_ci_hi</span>)

<span class="co">#temp</span>
<span class="no">j_temp</span> <span class="kw">&lt;-</span> <span class="no">pred.temp</span>$<span class="no">matRRfit</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu">rownames_to_column</span>(<span class="kw">var</span><span class="kw">=</span><span class="st">"var"</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">var</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">var</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">var</span><span class="kw">==</span><span class="fl">20</span> <span class="kw">|</span> <span class="no">var</span><span class="kw">==</span><span class="fl">30</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">comparison</span> <span class="kw">=</span> <span class="fu">case_when</span>(<span class="no">var</span><span class="kw">==</span><span class="fl">20</span> ~ <span class="st">"Mid (20°C) vs. low (17°C)"</span>,
                                <span class="no">var</span><span class="kw">==</span><span class="fl">30</span> ~ <span class="st">"High (30°C) vs. low (17°C)"</span>),
         <span class="kw">variable</span><span class="kw">=</span><span class="st">"Smear/Xpert positive"</span>,
         <span class="kw">model</span> <span class="kw">=</span> <span class="st">"Temperature"</span>) <span class="kw">%&gt;%</span>
  <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> <span class="no">lag0</span>:<span class="no">lag20</span>)

<span class="no">j_temp_ci_lo</span> <span class="kw">&lt;-</span> <span class="no">pred.temp</span>$<span class="no">matRRlow</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu">rownames_to_column</span>(<span class="kw">var</span><span class="kw">=</span><span class="st">"var"</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">var</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">var</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">var</span><span class="kw">==</span><span class="fl">20</span> <span class="kw">|</span> <span class="no">var</span><span class="kw">==</span><span class="fl">30</span>) <span class="kw">%&gt;%</span>
  <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> <span class="no">lag0</span>:<span class="no">lag20</span>) <span class="kw">%&gt;%</span>
  <span class="fu">rename</span>(<span class="kw">ci_lo</span><span class="kw">=</span><span class="no">value</span>)

<span class="no">j_temp_ci_hi</span> <span class="kw">&lt;-</span> <span class="no">pred.temp</span>$<span class="no">matRRhigh</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu">rownames_to_column</span>(<span class="kw">var</span><span class="kw">=</span><span class="st">"var"</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">var</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">var</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">var</span><span class="kw">==</span><span class="fl">20</span> <span class="kw">|</span> <span class="no">var</span><span class="kw">==</span><span class="fl">30</span>) <span class="kw">%&gt;%</span>
  <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> <span class="no">lag0</span>:<span class="no">lag20</span>) <span class="kw">%&gt;%</span>
  <span class="fu">rename</span>(<span class="kw">ci_hi</span><span class="kw">=</span><span class="no">value</span>)

<span class="no">j2</span> <span class="kw">&lt;-</span> <span class="fu">left_join</span>(<span class="no">j_temp</span>, <span class="no">j_temp_ci_lo</span>)
<span class="no">j2</span> <span class="kw">&lt;-</span> <span class="fu">left_join</span>(<span class="no">j2</span>, <span class="no">j_temp_ci_hi</span>)

<span class="no">j</span> <span class="kw">&lt;-</span> <span class="fu">bind_rows</span>(<span class="no">j1</span>, <span class="no">j2</span>)

<span class="no">j</span> <span class="kw">&lt;-</span> <span class="no">j</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">lag</span> <span class="kw">=</span> <span class="fu">parse_number</span>(<span class="no">name</span>))

<span class="no">j</span> <span class="kw">%&gt;%</span>
  <span class="fu">ggplot</span>() +
  <span class="fu">geom_pointrange</span>(<span class="fu">aes</span>(<span class="kw">x</span><span class="kw">=</span><span class="no">lag</span>, <span class="kw">y</span><span class="kw">=</span><span class="no">value</span>, <span class="kw">ymin</span><span class="kw">=</span><span class="no">ci_lo</span>, <span class="kw">ymax</span><span class="kw">=</span><span class="no">ci_hi</span>, <span class="kw">group</span><span class="kw">=</span><span class="no">comparison</span>, <span class="kw">colour</span><span class="kw">=</span><span class="no">comparison</span>),
                  <span class="kw">position</span><span class="kw">=</span><span class="fu">position_jitterdodge</span>()) +
  <span class="fu">facet_grid</span>(<span class="no">comparison</span>~<span class="no">model</span>)</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-42-1.png" width="700"></p>
<p><br></p>
</div>
<div id="figure-3" class="section level2">
<h2 class="hasAnchor">
<a href="#figure-3" class="anchor"></a>12. Figure 3</h2>
<p>Bring all the estimates together in a single plot</p>
<div class="sourceCode" id="cb127"><html><body><pre class="r">
<span class="no">fig2</span> <span class="kw">&lt;-</span> <span class="fu">bind_rows</span>(<span class="no">a</span>,<span class="no">b</span>,<span class="no">c</span>,<span class="no">d</span>,<span class="no">e</span>,<span class="no">f</span>,<span class="no">g</span>,<span class="no">h</span>,<span class="no">i</span>,<span class="no">j</span>)

<span class="no">fig2</span> <span class="kw">&lt;-</span> <span class="no">fig2</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggpubr/man/reexports.html">mutate</a></span>(<span class="kw">variable</span> <span class="kw">=</span> <span class="fu">fct_relevel</span>(<span class="no">variable</span>,
            <span class="st">"Overall"</span>, <span class="st">"Male"</span>, <span class="st">"Female"</span>, <span class="st">"HIV-positive"</span>,
            <span class="st">"HIV-negative"</span>, <span class="st">"Young age"</span>, <span class="st">"Middle age"</span>, <span class="st">"Old age"</span>,
            <span class="st">"Smear/Xpert positive"</span>, <span class="st">"Smear/Xpert negative"</span>))

<span class="no">fig2</span> <span class="kw">%&gt;%</span>
  <span class="fu">ggplot</span>() +
  <span class="fu">geom_hline</span>(<span class="fu">aes</span>(<span class="kw">yintercept</span><span class="kw">=</span><span class="fl">1</span>)) +
  <span class="fu">geom_pointrange</span>(<span class="fu">aes</span>(<span class="kw">x</span><span class="kw">=</span><span class="no">lag</span>, <span class="kw">y</span><span class="kw">=</span><span class="no">value</span>, <span class="kw">ymin</span><span class="kw">=</span><span class="no">ci_lo</span>, <span class="kw">ymax</span><span class="kw">=</span><span class="no">ci_hi</span>, <span class="kw">group</span><span class="kw">=</span><span class="no">comparison</span>, <span class="kw">colour</span><span class="kw">=</span><span class="no">comparison</span>),
                  <span class="kw">pch</span><span class="kw">=</span><span class="fl">16</span>, <span class="kw">size</span><span class="kw">=</span><span class="fl">0.3</span>) +
  <span class="fu">facet_grid</span>(<span class="no">variable</span>~<span class="no">model</span> + <span class="no">comparison</span>) +
  <span class="fu">theme_bw</span>() +
  <span class="co">#coord_trans(y = "log10") +</span>
  <span class="fu">scale_fill_manual</span>(<span class="kw">values</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"#E31A1C"</span>,  <span class="st">"#1F78B4"</span>, <span class="st">"#A6CEE3"</span>, <span class="st">"#FB9A99"</span>))+
  <span class="fu">scale_colour_manual</span>(<span class="kw">values</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"#E31A1C"</span>, <span class="st">"#1F78B4"</span>, <span class="st">"#A6CEE3"</span>, <span class="st">"#FB9A99"</span>)) +
  <span class="fu">labs</span>(<span class="kw">y</span><span class="kw">=</span><span class="st">"Report ratio (95% CI)"</span>,
       <span class="kw">x</span><span class="kw">=</span><span class="st">"Lag (weeks)"</span>) +
  <span class="fu">theme</span>(<span class="kw">legend.position</span> <span class="kw">=</span> <span class="st">"none"</span>,
        <span class="kw">panel.grid.major</span> <span class="kw">=</span> <span class="fu">element_blank</span>(),
        <span class="kw">panel.grid.minor</span> <span class="kw">=</span> <span class="fu">element_blank</span>(),
        <span class="kw">strip.background</span> <span class="kw">=</span> <span class="fu">element_rect</span>(<span class="kw">colour</span> <span class="kw">=</span> <span class="st">"black"</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="st">"white"</span>),
        <span class="kw">strip.text</span> <span class="kw">=</span> <span class="fu">element_text</span>(<span class="kw">size</span><span class="kw">=</span><span class="fl">8</span>, <span class="kw">family</span> <span class="kw">=</span> <span class="st">"Open Sans Condensed Light"</span>, <span class="kw">color</span> <span class="kw">=</span> <span class="st">"black"</span>))</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-43-1.png" width="700"></p>
<div class="sourceCode" id="cb128"><html><body><pre class="r">
<span class="fu">ggsave</span>(<span class="fu"><a href="https://rdrr.io/pkg/here/man/here.html">here</a></span>(<span class="st">"figures/figure3a.png"</span>), <span class="kw">height</span><span class="kw">=</span><span class="fl">10</span>, <span class="kw">dpi</span><span class="kw">=</span><span class="fl">600</span>)

<span class="no">fig2</span> <span class="kw">%&gt;%</span>
  <span class="fu">ggplot</span>() +
  <span class="fu">geom_hline</span>(<span class="fu">aes</span>(<span class="kw">yintercept</span><span class="kw">=</span><span class="fl">1</span>), <span class="kw">colour</span><span class="kw">=</span><span class="st">"grey"</span>, <span class="kw">linetype</span><span class="kw">=</span><span class="st">"dashed"</span>) +
  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="kw">x</span><span class="kw">=</span><span class="no">lag</span>, <span class="kw">ymin</span><span class="kw">=</span><span class="no">ci_lo</span>, <span class="kw">ymax</span><span class="kw">=</span><span class="no">ci_hi</span>, <span class="kw">fill</span><span class="kw">=</span><span class="no">comparison</span>), <span class="kw">alpha</span><span class="kw">=</span><span class="fl">0.6</span>) +
  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="kw">x</span><span class="kw">=</span><span class="no">lag</span>, <span class="kw">y</span><span class="kw">=</span><span class="no">value</span>, <span class="kw">colour</span><span class="kw">=</span><span class="no">comparison</span>)) +
  <span class="fu">facet_grid</span>(<span class="no">variable</span>~<span class="no">model</span> + <span class="no">comparison</span>) +
  <span class="fu">theme_bw</span>() +
  <span class="fu">coord_trans</span>(<span class="kw">y</span> <span class="kw">=</span> <span class="st">"log10"</span>) +
  <span class="fu">scale_fill_manual</span>(<span class="kw">values</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"#E31A1C"</span>,  <span class="st">"#1F78B4"</span>, <span class="st">"#A6CEE3"</span>, <span class="st">"#FB9A99"</span>))+
  <span class="fu">scale_colour_manual</span>(<span class="kw">values</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"#E31A1C"</span>, <span class="st">"#1F78B4"</span>, <span class="st">"#A6CEE3"</span>, <span class="st">"#FB9A99"</span>)) +
  <span class="fu">labs</span>(<span class="kw">y</span><span class="kw">=</span><span class="st">"Report ratio (95% CI)"</span>,
       <span class="kw">x</span><span class="kw">=</span><span class="st">"Lag (weeks)"</span>)  +
  <span class="fu">theme</span>(<span class="kw">legend.position</span> <span class="kw">=</span> <span class="st">"none"</span>,
        <span class="kw">panel.grid.major</span> <span class="kw">=</span> <span class="fu">element_blank</span>(),
        <span class="kw">panel.grid.minor</span> <span class="kw">=</span> <span class="fu">element_blank</span>(),
        <span class="kw">strip.background</span> <span class="kw">=</span> <span class="fu">element_rect</span>(<span class="kw">colour</span> <span class="kw">=</span> <span class="st">"black"</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="st">"white"</span>),
        <span class="kw">strip.text</span> <span class="kw">=</span> <span class="fu">element_text</span>(<span class="kw">size</span><span class="kw">=</span><span class="fl">8</span>, <span class="kw">family</span> <span class="kw">=</span> <span class="st">"Open Sans Condensed Light"</span>, <span class="kw">color</span> <span class="kw">=</span> <span class="st">"black"</span>))</pre></body></html></div>
<p><img src="data-and-code_files/figure-html/unnamed-chunk-43-2.png" width="700"></p>
<div class="sourceCode" id="cb129"><html><body><pre class="r">
<span class="fu">ggsave</span>(<span class="fu"><a href="https://rdrr.io/pkg/here/man/here.html">here</a></span>(<span class="st">"figures/figure3b.png"</span>), <span class="kw">height</span><span class="kw">=</span><span class="fl">10</span>, <span class="kw">dpi</span><span class="kw">=</span><span class="fl">600</span>)</pre></body></html></div>
<p><br></p>
</div>
<div id="reproducibility" class="section level2">
<h2 class="hasAnchor">
<a href="#reproducibility" class="anchor"></a>13. Reproducibility</h2>
<p>This reproduction of the analysis was run by:</p>
<table class="table">
<colgroup>
<col width="13%">
<col width="86%">
</colgroup>
<thead><tr class="header">
<th align="left">keyName</th>
<th align="left">value</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">sysname</td>
<td align="left">Darwin</td>
</tr>
<tr class="even">
<td align="left">release</td>
<td align="left">19.6.0</td>
</tr>
<tr class="odd">
<td align="left">version</td>
<td align="left">Darwin Kernel Version 19.6.0: Sun Jul 5 00:43:10 PDT 2020; root:xnu-6153.141.1~9/RELEASE_X86_64</td>
</tr>
<tr class="even">
<td align="left">nodename</td>
<td align="left">petermarsonsMBP</td>
</tr>
<tr class="odd">
<td align="left">machine</td>
<td align="left">x86_64</td>
</tr>
<tr class="even">
<td align="left">login</td>
<td align="left">root</td>
</tr>
<tr class="odd">
<td align="left">user</td>
<td align="left">peter.macpherson</td>
</tr>
<tr class="even">
<td align="left">effective_user</td>
<td align="left">peter.macpherson</td>
</tr>
</tbody>
</table>
<p>Analysis was run at <strong>2020-08-24 15:43:07</strong>, and using the following Session Info:</p>
<pre><code>R version 4.0.2 (2020-06-22)
Platform: x86_64-apple-darwin17.0 (64-bit)
Running under: macOS Catalina 10.15.6

Matrix products: default
BLAS:   /Library/Frameworks/R.framework/Versions/4.0/Resources/lib/libRblas.dylib
LAPACK: /Library/Frameworks/R.framework/Versions/4.0/Resources/lib/libRlapack.dylib

Random number generation:
 RNG:     Mersenne-Twister 
 Normal:  Inversion 
 Sample:  Rounding 
 
locale:
[1] en_GB.UTF-8/en_GB.UTF-8/en_GB.UTF-8/C/en_GB.UTF-8/en_GB.UTF-8

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
 [1] knitr_1.29         Metrics_0.1.4      MuMIn_1.43.17      dlnm_2.4.2        
 [5] patchwork_1.0.1    arsenal_3.5.0      GSODR_2.1.1        ggtext_0.1.0      
 [9] here_0.1           ggseas_0.5.4       fpp2_2.3           expsmooth_2.3     
[13] fma_2.4            Mcomp_2.8          forecast_8.12      smooth_2.6.0      
[17] greybox_0.6.0      xts_0.12-0         ggpubr_0.4.0       zoo_1.8-8         
[21] mlwdata_0.1.0.0000 mgcv_1.8-31        nlme_3.1-148       glue_1.4.1        
[25] tsibble_0.9.2      lubridate_1.7.9    forcats_0.5.0      stringr_1.4.0     
[29] dplyr_1.0.1        purrr_0.3.4        readr_1.3.1        tidyr_1.1.1       
[33] tibble_3.0.3       ggplot2_3.3.2      tidyverse_1.3.0   

loaded via a namespace (and not attached):
 [1] readxl_1.3.1       backports_1.1.8    splines_4.0.2      listenv_0.8.0     
 [5] digest_0.6.25      htmltools_0.5.0    fansi_0.4.1        magrittr_1.5      
 [9] memoise_1.1.0      openxlsx_4.1.5     globals_0.12.5     modelr_0.1.8      
[13] RcppParallel_5.0.2 pkgdown_1.5.1      anytime_0.3.8      tsModel_0.6       
[17] tseries_0.10-47    colorspace_1.4-1   blob_1.2.1         rvest_0.3.6       
[21] haven_2.3.1        xfun_0.16          crayon_1.3.4       jsonlite_1.7.0    
[25] survival_3.1-12    gtable_0.3.0       car_3.0-9          lamW_1.3.3        
[29] future.apply_1.6.0 quantmod_0.4.17    abind_1.4-5        scales_1.1.1      
[33] DBI_1.1.0          rstatix_0.6.0      Rcpp_1.0.5         gridtext_0.1.1    
[37] foreign_0.8-80     stats4_4.0.2       httr_1.4.2         x13binary_1.1.39-2
[41] ellipsis_0.3.1     pkgconfig_2.0.3    farver_2.0.3       nnet_7.3-14       
[45] dbplyr_1.4.4       utf8_1.1.4         tidyselect_1.1.0   labeling_0.3      
[49] rlang_0.4.7        munsell_0.5.0      cellranger_1.1.0   tools_4.0.2       
[53] cli_2.0.2          generics_0.0.2     broom_0.7.0        evaluate_0.14     
[57] yaml_2.2.1         fs_1.5.0           zip_2.0.4          future_1.18.0     
[61] pracma_2.2.9       xml2_1.3.2         compiler_4.0.2     rstudioapi_0.11   
[65] curl_4.3           ggsignif_0.6.0     reprex_0.3.0       statmod_1.4.34    
[69] stringi_1.4.6      highr_0.8          desc_1.2.0         lattice_0.20-41   
[73] Matrix_1.2-18      markdown_1.1       nloptr_1.2.2.2     urca_1.3-0        
[77] vctrs_0.3.2        pillar_1.4.6       lifecycle_0.2.0    lmtest_0.9-37     
[81] cowplot_1.0.0      data.table_1.13.0  R6_2.4.1           rio_0.5.16        
[85] codetools_0.2-16   MASS_7.3-51.6      assertthat_0.2.1   rprojroot_1.3-2   
[89] withr_2.2.0        seasonal_1.7.1     fracdiff_1.5-1     parallel_4.0.2    
[93] hms_0.5.3          quadprog_1.5-8     grid_4.0.2         timeDate_3043.102 
[97] rmarkdown_2.3      carData_3.0-4      TTR_0.23-6        </code></pre>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Peter MacPherson.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
